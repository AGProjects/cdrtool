<?

/*
  Copyright (c) 2007 AG Projects
  http://ag-projects.com

  This library provide the functions for managing SIP accounts,
  ENUM ranges, ENUM numbers, Trusted Peers, LCR, Rating plans
  on a remote NGN-Pro server

*/

class SOAPEngine {
    var $version       = 1;
    var $adminonly     = 0;
    var $customer      = 0;
    var $reseller      = 0;
    var $loginType     = 'reseller';
	var $allowedPorts  = array();

    var $services=array(
                        'sip_accounts'     => array(
                                           'recordsClass' => 'SipAccounts',
                                           'name'         => 'SIP accounts',
                                           'soapClass'    => 'WebService_NGNPro_SipPort'
                                          ),
                        'sip_aliases'    => array('recordsClass' => 'SipAliases',
                                           'name'         => 'SIP Aliases',
                                           'soapClass'    => 'WebService_NGNPro_SipPort'
                                          ),
                        'sip_domains'    => array('recordsClass' => 'Domains',
                                           'name'         => 'SIP Domains',
                                           'soapClass'    => 'WebService_NGNPro_SipPort'
                                          ),
                        'enum_numbers'    => array('recordsClass' => 'EnumMappings',
                                           'name'         => 'ENUM Numbers',
                                           'soapClass'    => 'WebService_NGNPro_EnumPort'
                                          ),
                        'enum_ranges'    => array('recordsClass' => 'EnumRanges',
                                           'name'         => 'ENUM Ranges',
                                           'soapClass'    => 'WebService_NGNPro_EnumPort'
                                          ),
                        'customers'     => array('recordsClass' => 'Customers',
                                           'name'         => 'Customers',
                                           'soapClass'    => 'WebService_NGNPro_CustomerPort'
                                           ),
                        'trusted_peers'  => array('recordsClass' => 'TrustedPeers',
                                           'name'         => 'Trusted Peers',
                                           'soapClass'    => 'WebService_NGNPro_SipPort'
                                          ),
                        'pstn_gateways'  => array('recordsClass' => 'Gateways',
                                           'name'         => 'PSTN Gateways',
                                           'soapClass'    => 'WebService_NGNPro_NetworkPort'
                                           ),
                        'pstn_gateway_groups' => array('recordsClass' => 'GatewayGroups',
                                           'name'         => 'Gateway groups',
                                           'soapClass'    => 'WebService_NGNPro_NetworkPort'
                                          ),
                        'pstn_routes'    => array('recordsClass' => 'Routes',
                                           'name'         => 'PSTN Routes',
                                           'soapClass'    => 'WebService_NGNPro_NetworkPort'
                                          )
                        );

    function getSoapEngineAllowed($soapEngines,$filter) {
    	$_filter_els=explode(" ",trim($filter));
		foreach(array_keys($soapEngines) as $_engine) {
            //dprint("check engine $_engine");
        	foreach ($_filter_els as $_filter) {
                //dprint("check filter $_filter");

                unset($_allowed_engine);
                $_allowed_ports=array();

                list($_allowed_engine,$_allowed_ports_els) = explode(":",$_filter);

                //dprint ("_allowed_engine=$_allowed_engine, _allowed_ports=$_allowed_ports_els");
                if ($_allowed_ports_els) {
                	$_allowed_ports = explode(",",$_allowed_ports_els);
                }

            	if ($_engine == $_allowed_engine) {
                	$soapEngines_checked[$_engine]=$soapEngines[$_engine];
                    $this->allowedPorts[$_engine]=$_allowed_ports;
                	continue;
            	} else {
                    //dprint ("$_engine != $_allowed_engine");
                }
        	}
    	}

		//dprint_r($soapEngines_checked);

        return $soapEngines_checked;
    }

    function SOAPEngine($service,$soapEngines,$extraFormElements,$loginCredentials) {

        // service syntax is is port@engine

        /*
        $soapEngines=array(
                                   'mdns' => array('name'=> 'Managed DNS',
                                                 'username'=> 'soapadmin',
                                                 'password'=> 'passwd',
                                                 'url'     => 'http://example.com:9200/',
                                                 'impersonate' => 1745
                                                 ),
        */

		$this->loginCredentials = $loginCredentials;
        dprint_r($this->loginCredentials);

		if ($this->loginCredentials['customer'] == $this->loginCredentials['reseller']) {
            unset($this->loginCredentials['customer']);
        }

        if ($this->loginCredentials['loginType'] == 'admin') $this->adminonly = 1;

        if (strlen($this->loginCredentials['soapFilter'])) {
            $this->soapEngines = $this->getSoapEngineAllowed($soapEngines,$this->loginCredentials['soapFilter']);
        } else {
        	$this->soapEngines = $soapEngines;
        }

        if (is_array($this->soapEngines)) {

            if (!$service) {
                // use first engine available
                $_services     = array_keys($this->services);
                $_soapids      = array_keys($this->soapEngines);
                $service       = $_services[0].'@'.$_soapids[0];
            }

            if (is_array($extraFormElements)) {
	        	$this->extraFormElements    = $extraFormElements;
            }

            $this->service = $service;

            $_els=explode('@',$this->service);

            $this->soapEngineId             = $_els[1];
            $this->soapEngineIdSettingsPage = $this->soapEngineId;

            if (count($this->allowedPorts[$this->soapEngineId]) > 1 && in_array($_els[0],$this->allowedPorts[$this->soapEngineId])) {
            	$this->soapEnginePort = $_els[0];
            	$this->recordsClass   = $this->services[$this->soapEnginePort]['recordsClass'];
            	$this->soapClass      = $this->services[$this->soapEnginePort]['soapClass'];
            }  else {
            	$this->soapEnginePort = $_els[0];
            	$this->recordsClass   = $this->services[$this->soapEnginePort]['recordsClass'];
            	$this->soapClass      = $this->services[$this->soapEnginePort]['soapClass'];
            }

            foreach(array_keys($this->soapEngines) as $_key ) {
            	$this->skipEngines[$_key]=$this->soapEngines[$_key]['skipEngines'];
                $this->skip[$_key]=$this->soapEngines[$_key]['skip'];
            }

            if (strlen($this->soapEngines[$this->soapEngineId]['version'])) {
            	$this->version = $this->soapEngines[$this->soapEngineId]['version'];
            }

            $this->defaultEnumTLD  = $this->soapEngines[$this->soapEngineId]['defaultEnumTLD'];

			if (strlen($this->soapEngines[$this->soapEngineId]['soapEngineIdSettingsPage'])) {
            	$this->soapEngineIdSettingsPage=$this->soapEngines[$this->soapEngineId]['soapEngineIdSettingsPage'];
            }

			if (strlen($this->soapEngines[$this->soapEngineId]['SipSettingsPage'])) {
            	$this->SipSettingsPage=$this->soapEngines[$this->soapEngineId]['SipSettingsPage'];
            }

			if (strlen($this->soapEngines[$this->soapEngineId]['customerProperties'])) {
            	$this->customerProperties=$this->soapEngines[$this->soapEngineId]['customerProperties'];
            }

			if (strlen($this->soapEngines[$this->soapEngineId]['recordGenerator'])) {
            	$this->recordGenerator=$this->soapEngines[$this->soapEngineId]['recordGenerator'];
            }

            if (strlen($loginCredentials['reseller'])) {
            	$this->reseller = $loginCredentials['reseller'];
            } else if ($this->adminonly && $_REQUEST['reseller_filter']){
                $this->reseller = $_REQUEST['reseller_filter'];
            }

            if (strlen($loginCredentials['customer'])) {
            	$this->customer = $loginCredentials['customer'];
            } else if ($this->adminonly && $_REQUEST['customer_filter']){
            	$this->customer = $_REQUEST['customer_filter'];
            }

            if (strlen($loginCredentials['soapUsername'])) {
            	$this->soapUsername=$loginCredentials['soapUsername'];
            } else if ($this->adminonly) {
				$this->soapUsername=$this->soapEngines[$this->soapEngineId]['username'];
            }

			//print_r($loginCredentials);
            if (strlen($loginCredentials['soapUsername'])) {
                $this->SOAPlogin = array(
                                       "username"    => $this->soapUsername,
                                       "password"    => $loginCredentials['soapPassword'],
                                       "admin"       => false
                                       );
            } else {
                $this->SOAPlogin = array(
                                       "username"    => $this->soapUsername,
                                       "password"    => $this->soapEngines[$this->soapEngineId]['password'],
                                       "admin"       => true,
                                       "impersonate" => intval($this->reseller)
                                       );
            }

            $this->SOAPurl=$this->soapEngines[$this->soapEngineId]['url'];
            printf ("<p>Connection to %s at <a href=%swsdl target=wsdl>%s</a> as %s/%s ",$this->soapClass,$this->SOAPurl,$this->SOAPurl,$this->soapUsername,$this->reseller);
            $this->SoapAuth = array('auth', $this->SOAPlogin , 'urn:AGProjects:NGNPro', 0, '');

    		// Instantiate the SOAP client
            if (!class_exists($this->soapClass)) return ;

            $this->soapclient = new $this->soapClass($this->SOAPurl);

            $this->soapclient->setOpt('curl', CURLOPT_TIMEOUT,        5);
            $this->soapclient->setOpt('curl', CURLOPT_SSL_VERIFYPEER, 0);
            $this->soapclient->setOpt('curl', CURLOPT_SSL_VERIFYHOST, 0);

			$this->soapRemoteId=$this->soapEngines[$this->soapEngineId]['depends'];

            if (strlen($this->soapRemoteId) && in_array($this->soapRemoteId,array_keys($this->soapEngines))) {
				$this->soapEngineIdRemote = $this->soapEngines[$this->soapRemoteId];
                $impersonateRemote=intval($this->soapEngines[$this->soapRemoteId]['impersonate']);

    	        $this->SOAPloginRemote = array(
        	                           "username"    => $this->soapEngines[$this->soapRemoteId]['username'],
            	                       "password"    => $this->soapEngines[$this->soapRemoteId]['password'],
                	                   "admin"       => true,
                    	               "impersonate" => $impersonateRemote
                                   );

                //print_r($this->SOAPloginRemote);
            	$this->SOAPurlRemote=$this->soapEngines[$this->soapRemoteId]['url'];
            	//printf ("and syncronize writes at <a href=%swsdl target=wsdl>%s</a>",$this->SOAPurlRemote,$this->SOAPurlRemote);

            	$this->SoapAuthRemote = array('auth', $this->SOAPloginRemote , 'urn:AGProjects:NGNPro', 0, '');

    			// Instantiate the SOAP client depends
            	$this->soapclientRemote = new $this->soapClass($this->SOAPurlRemote);

            	$this->soapclientRemote->setOpt('curl', CURLOPT_TIMEOUT,        5);
            	$this->soapclientRemote->setOpt('curl', CURLOPT_SSL_VERIFYPEER, 0);
            	$this->soapclientRemote->setOpt('curl', CURLOPT_SSL_VERIFYHOST, 0);
            }

	    	if ($this->version > 1) {
	            $this->soapclientCustomers = new WebService_NGNPro_CustomerPort($this->SOAPurl);
    	        $this->soapclientCustomers->setOpt('curl', CURLOPT_TIMEOUT,        5);
        	    $this->soapclientCustomers->setOpt('curl', CURLOPT_SSL_VERIFYPEER, 0);
            	$this->soapclientCustomers->setOpt('curl', CURLOPT_SSL_VERIFYHOST, 0);
            }

    	} else {
            print "<font color=red>Error: No SOAP credentials defined.</font>";
        }

        $this->url = $_SERVER['PHP_SELF']."?1=1";

        foreach (array_keys($this->extraFormElements) as $element) {
            if (!strlen($this->extraFormElements[$element])) continue;
            $this->url  .= sprintf('&%s=%s',$element,urlencode($this->extraFormElements[$element]));
        }
    }

    function execute($function) {

        /*
        $function=array('commit'   => array('name'       => 'addAccount',
                                            'parameters' => array($param1,$param2),
                                            'logs'       => array('success' => 'The function was a success',
                                                                  'failure' => 'The function has failed'
                                                                  )
                                           ),
                        'rollback' => array('name'       => 'addAccount',
                                            'parameters' => array($param1,$param2),
                                            'logs'       => array('success' => 'The function was a success',
                                                                  'failure' => 'The function has failed'
                                                                  )
                                           )

                        );
        */

        if (!$function['commit']['name']) {
            print "<font color=red>Error: no function name supplied</font>";
            return false;
        }

        if (is_object($this->soapclientRemote)) {

            $this->soapclientRemote->addHeader($this->SoapAuthRemote);

            $resultRemote = call_user_func_array(array($this->soapclientRemote,$function['commit']['name']),$function['commit']['parameters']);

            if (PEAR::isError($resultRemote)) {
                $error_msg   = $resultRemote->getMessage();
                $error_fault = $resultRemote->getFault();
                $error_code  = $resultRemote->getCode();
                printf ("<p><font color=red>Error from %s: %s (%s): %s</font>",$this->SOAPurlRemote,$error_msg, $error_fault->detail->exception->errorcode,$error_fault->detail->exception->errorstring);
                return false;
            } else {
            	printf ("<p><font color=green>%s %s </font>",$function['commit']['logs']['success'],$this->SOAPurlRemote);

                $this->soapclient->addHeader($this->SoapAuth);
            	$result = call_user_func_array(array($this->soapclient,$function['commit']['name']),$function['commit']['parameters']);

                if (PEAR::isError($result)) {
                    $error_msg   = $result->getMessage();
                    $error_fault = $result->getFault();
                    $error_code  = $result->getCode();
                    printf ("<p><font color=red>Error from %s: %s (%s): %s</font>",$this->SOAPurl,$error_msg, $error_fault->detail->exception->errorcode,$error_fault->detail->exception->errorstring);

					if ($function['rollback']['name']) {

            			$this->soapclientRemote->addHeader($this->SoapAuthRemote);
                        $this->counterRemote++;

            			$resultRemote = call_user_func_array(array($this->soapclientRemote,$function['rollback']['name']),$function['rollback']['parameters']);

                        if (PEAR::isError($result)) {
                            $error_msg=$result->getMessage();
                            $error_fault=$result->getFault();
                            $error_code=$result->getCode();
                            printf ("<p><font color=red>Error roll back at %s: %s (%s): %s</font>",$this->SOAPurl,$error_msg, $error_fault->detail->exception->errorcode,$error_fault->detail->exception->errorstring);
                        } else {
            				printf ("<p><font color=green>Rolled back action at %s </font>",$this->SOAPurlRemote);
                        }
                    }

                    return false;
                } else {
                    if ($function['commit']['logs']['success']) {
                    	printf ("<p><font color=green>%s %s </font>",$function['commit']['logs']['success'],$this->SOAPurl);
                    }
                }
            }

        } else {

	     	$this->soapclient->addHeader($this->SoapAuth);
            $result = call_user_func_array(array($this->soapclient,$function['commit']['name']),$function['commit']['parameters']);

            if (PEAR::isError($result)) {
                $error_msg   = $result->getMessage();
                $error_fault = $result->getFault();
                $error_code  = $result->getCode();
                printf ("<p><font color=red>Error from %s: %s (%s): %s</font>",$this->SOAPurl,$error_msg, $error_fault->detail->exception->errorcode,$error_fault->detail->exception->errorstring);
                return false;
            } else {
            	if ($function['commit']['logs']['success']) {
                	printf ("<p><font color=green>%s </font>",$function['commit']['logs']['success']);
                }
            }
        }

        return true;
    }
}

class Records {
	var $maxrowsperpage     = '15';
    var $SipSettingsPage    = 'sip_settings.phtml';
    var $allowedDomains     = array();
    var $selectionActive    = false;
    var $selectionKeys      = array();
    var $resellers          = array();
    var $customers          = array();
    var $recordGenerator    = false;
	var $customerProperties = array();

    function Records(&$SOAPEngine) {
    	$this->SOAPEngine         = &$SOAPEngine;
        $this->version            = &$this->SOAPEngine->version;
        $this->loginCredentials   = &$this->SOAPEngine->loginCredentials;
        $this->customerProperties = &$this->SOAPEngine->customerProperties;

        $this->sorting['sortBy']    = trim($_REQUEST['sortBy']);
        $this->sorting['sortOrder'] = trim($_REQUEST['sortOrder']);

        $this->next       = $_REQUEST['next'];

        $this->adminonly  = $this->SOAPEngine->adminonly;
		$this->reseller   = $this->SOAPEngine->reseller;
        $this->url        = $this->SOAPEngine->url;

		foreach(array_keys($this->filters) as $_filter) {
            if (strlen($this->filters[$_filter])) {
            	$this->selectionActive=true;
                break;
            }
        }

        if ($this->adminonly) {
        	$this->url .= sprintf('&adminonly=%s',$this->adminonly);
            if ($this->loginCredentials['reseller']) {
        		$this->filters['reseller']=$this->loginCredentials['reseller'];
            } else {
        		$this->filters['reseller']=trim($_REQUEST['reseller_filter']);
            }
        }

        if ($this->loginCredentials['customer']) {
        	$this->filters['customer'] = $this->loginCredentials['customer'];
        } else {
        	$this->filters['customer'] = trim($_REQUEST['customer_filter']);
        }

        $this->getResellers();
        $this->getCustomers();

        if (strlen($this->SOAPEngine->SipSettingsPage)) $this->SipSettingsPage=$this->SOAPEngine->SipSettingsPage;
    }

    function showEngineSelection() {
        $selected_soapEngine[$this->SOAPEngine->service]='selected';

        printf ("<select name=service onChange=\"document.soapengine.submit.disabled = true; location.href = '%s&service=' + this.options[this.selectedIndex].value\">",$this->url);
        $j=1;
        foreach (array_keys($this->SOAPEngine->soapEngines) as $_engine) {
        	if ($this->SOAPEngine->skip[$_engine]) continue;

        	if ($j>1) printf ("<option value=''>--------");
            $k=1;
            foreach (array_keys($this->SOAPEngine->services) as $_service) {
                $idx=$_service.'@'.$_engine;
                if (in_array($_service,$this->SOAPEngine->skipEngines[$_engine])) continue;
                if (count($this->SOAPEngine->allowedPorts[$_engine]) > 1 && !in_array($_service,$this->SOAPEngine->allowedPorts[$_engine])) continue;
                if ($_engine == 'Customers' && $this->version <= 1) continue;
                printf ("<option value='%s@%s' %s>%d.%d %s@%s",$_service,$_engine,$selected_soapEngine[$idx],$j,$k,$this->SOAPEngine->services[$_service]['name'],$this->SOAPEngine->soapEngines[$_engine]['name']);
                $k++;
            }
            $j++;
        }
        printf ("</select>");

        if ($this->version > 1) {
            print "Customer ";
    
            if ($this->adminonly) {
                $this->showResellerForm();
                if ($this->filters['reseller']) {
                    print ".";
                    $this->showCustomerForm();
                }
            } else {
                printf ("%s",$this->reseller);
                print ".";
                $this->showCustomerForm();
            }
        }
    }

    function showPagination($maxrows) {

        $url .= $this->url.'&'.$this->addFiltersToURL().
        sprintf("&service=%s&sortBy=%s&sortOrder=%s",
        urlencode($this->SOAPEngine->service),
        urlencode($this->sorting['sortBy']),
        urlencode($this->sorting['sortOrder'])
        );

        print "
        <p>
        <table border=0 align=center>
        <tr>
        <td>
        ";

        if ($this->next != 0  ) {
            $show_next=$this->maxrowsperpage-$this->next;
            if  ($show_next < 0)  {
                $mod_show_next  =  $show_next-2*$show_next;
            }
            if (!$mod_show_next) $mod_show_next=0;

            if ($mod_show_next/$this->maxrowsperpage >= 1) {
            	printf ("<a href='%s&next=0'>Begin</a> ",$url);
            }

            printf ("<a href='%s&next=%s'>Previous</a> ",$url,$mod_show_next);
        }
        
        print "
        </td>
        <td>
        ";

        if ($this->next + $this->maxrowsperpage < $this->rows)  {
            $show_next = $this->maxrowsperpage + $this->next;
            printf ("<a href='%s&next=%s'>Next</a> ",$url,$show_next);
        }

        print "
        </td>
        </tr>
        </table>
        ";
    }

    function showSeachFormCustom() {
    }

    function showSeachForm() {
        print "
        <p>
        <table border=0 class=border width=100%>
        <tr>
            ";
            printf ("<form method=post name=soapengine action=%s>",$_SERVER['PHP_SELF']);
            print "
        	<td align=left>
            ";
            $this->showEngineSelection();

            $this->showSeachFormCustom();

            print "
	        </td>
        	<td align=right>
            ";
            $this->showSortForm();

            print "
            <input type=submit name=action value=Search>
            ";
            $this->printHiddenFormElements();

            print "
	        </td>
            </form>
        </tr>
        </table>
        ";

        if ($_REQUEST['action'] != 'Delete') $this->showAddForm();
    }

    function listRecords() {
    }

    function getRecordKeys() {
    }

    function addRecord() {
    }

    function deleteRecord() {
    }

    function tel2enum($tel,$tld) {

        if (strlen($tld) == 0)  $tld="e164.arpa";

        // transform telephone number in FQDN Enum style domain name
        if (preg_match("/^[+]?(\d+)$/",$tel,$m)) {
            $l=strlen($m[1]);
            $rev_num="";
            $z=0;
            while ($z < $l) {
                $ss=substr($m[1],$z,1);
                $enum=$ss.".".$enum;
                $z++;
            }
            preg_match("/^(.*)\.$/",$enum,$m);
            $enum=$m[1];
            $enum=$enum.".$tld.";
            return($enum);
         } else {
            return($tel);
         }
    }

    function showAddForm() {
		if ($this->selectionActive) return;
	}

    function showSortForm() {

        if (!count($this->sortElements)) {
            return;
        }

        $selected_sortBy[$this->sorting['sortBy']]='selected';

        //print " Sort ";

        print "<select name=sortBy>";
        foreach (array_keys($this->sortElements) as $key) {
        	printf ("<option value='%s' %s>%s",$key,$selected_sortBy[$key],$this->sortElements[$key]);
        }
        print "</select>";

        $selected_sortOrder[$this->sorting['sortOrder']]='selected';
        print "<select name=sortOrder>";
        printf ("<option value='DESC' %s>DESC",$selected_sortOrder['DESC']);
        printf ("<option value='ASC' %s>ASC",$selected_sortOrder['ASC']);
        print "</select>";
    }

    function showTimezones() {
        if (!$fp = fopen("timezones", "r")) {
        	print _("Failed to open timezone file.");
            return false;
        }
        print "<select name=timezone>";
        print "<option>";
        while ($buffer = fgets($fp,1024)) {
        	$buffer=trim($buffer);
            if ($this->timezone==$buffer) {
                $selected="selected";
            } else {
                $selected="";
            }
            printf ("<option %s>%s>",$selected,$buffer);
        }
        print "</select>";
        fclose($fp);

    }

    function printHiddenFormElements () {
        printf("<input type=hidden name=service value='%s'>",$this->SOAPEngine->service);

        if ($this->adminonly) {
        	printf("<input type=hidden name=adminonly value='%s'>",$this->adminonly);
        }

        foreach (array_keys($this->SOAPEngine->extraFormElements) as $element) {
        	if (!strlen($this->SOAPEngine->extraFormElements[$element])) continue;
            printf ("<input type=hidden name=%s value='%s'>\n",$element,$this->SOAPEngine->extraFormElements[$element]);
        }

    }

    function getAllowedDomains() {
    }


    function showActionsForm() {
        if (!$this->selectionActive) {
            return;
        }

		$class_name=get_class($this).'Actions';

		if (class_exists($class_name)) {
            $actions=new $class_name(&$this->SOAPEngine);
            $actions->showActionsForm($this->filters,$this->sorting);
        }
    }

    function performActions() {
		$this->showSeachForm();

		$this->getRecordKeys();
    	//print_r($this->selectionKeys);

        $class_name=get_class($this).'Actions';

		if (class_exists($class_name)) {
            $actions=new $class_name(&$this->SOAPEngine);
            $actions->performActions(&$this->selectionKeys,$_REQUEST['sub_action'],trim($_REQUEST['sub_action_parameter']));
        }
    }

    function getCustomers() {
    	if (!$this->version <= 1 ) return;

        if (!$this->filters['reseller']) {
            return;
        }

        // Filter
        $filter=array('reseller'=>intval($this->filters['reseller']));

        $range=array('start' => 0,
                     'count' => 100
                     );

        // Order
        $orderBy = array('attribute' => 'customer',
                         'direction' => 'ASC'
                         );

        // Compose query
        $Query=array('filter'     => $filter,
                        'orderBy' => $orderBy,
                        'range'   => $range
                        );

        // Insert credetials
        $this->SOAPEngine->soapclientCustomers->addHeader($this->SOAPEngine->SoapAuth);

        // Call function
        $result     = $this->SOAPEngine->soapclientCustomers->getCustomers($Query);

        if (PEAR::isError($result)) {
            $error_msg  = $result->getMessage();
            $error_fault= $result->getFault();
            $error_code = $result->getCode();
            printf ("<p><font color=red>Error from %s: %s (%s): %s</font>",$this->SOAPEngine->SOAPurl,$error_msg, $error_fault->detail->exception->errorcode,$error_fault->detail->exception->errorstring);
            return false;
        } else {

            if ($result->total > $range['count']) return;

			if ($range['count'] <= $result->total) {
                $max=$range['count'];
            } else {
            	$max=$result->total;
            }

            $i=0;
            while ($i < $max)  {
                $customer=$result->accounts[$i];
            	$this->customers[$customer->id] = $customer->firstName.' '.$customer->lastName;
            	$i++;
            }
            return true;
        }
    }

    function getResellers() {
    	if (!$this->version <= 1 ) return;
        if (!$this->adminonly) {
        	return;
        }
        // Filter
        $filter=array('reseller'=>intval($this->filters['reseller']));

        $range=array('start' => 0,
                     'count' => 200
                     );

        // Order
        $orderBy = array('attribute' => 'customer',
                         'direction' => 'ASC'
                         );

        // Compose query
        $Query=array('filter'     => $filter,
                        'orderBy' => $orderBy,
                        'range'   => $range
                        );

        // Insert credetials
        $this->SOAPEngine->soapclientCustomers->addHeader($this->SOAPEngine->SoapAuth);

        // Call function
        $result     = $this->SOAPEngine->soapclientCustomers->getResellers($Query);

        if (PEAR::isError($result)) {
            $error_msg  = $result->getMessage();
            $error_fault= $result->getFault();
            $error_code = $result->getCode();
            printf ("<p><font color=red>Error from %s: %s (%s): %s</font>",$this->SOAPEngine->SOAPurl,$error_msg, $error_fault->detail->exception->errorcode,$error_fault->detail->exception->errorstring);
            return false;
        } else {

            //if ($result->total > $range['count']) return;

			if ($range['count'] <= $result->total) {
                $max=$range['count'];
            } else {
            	$max=$result->total;
            }

            $i=0;
            while ($i < $max)  {
                $reseller = $result->accounts[$i];

                if (strlen($reseller->organization) && $reseller->organization!= 'N/A') {
            		$this->resellers[$reseller->id] = $reseller->organization;
                } else {
            		$this->resellers[$reseller->id] = $reseller->firstName.' '.$reseller->lastName;
                }
            	$i++;
            }

            //print_r($this->resellers);
            return true;
        }
    }

    function showCustomerForm($name='customer_filter') {
        if ($this->loginCredentials['customer']) {
            printf (" %s",$this->loginCredentials['customer']);
        } else {
            if (count($this->customers)) {
                $select_customer[$this->filters['customer']]='selected';
                printf ("<select name=%s>",$name);
                print "<option>";
                foreach (array_keys($this->customers) as $_res) {
                    printf ("<option value='%s' %s>%s (%s)\n",$_res,$select_customer[$_res],$_res,$this->customers[$_res]);
                }
                print "</select>";
            } else {
                printf ("<input type=text size=5 name=%s value='%s'>",$name,$this->filters['customer']);
            }
        }
    }

    function showResellerForm($name='reseller_filter') {
        if (!$this->adminonly) return;
        if ($this->loginCredentials['reseller']) {
            printf (" %s",$this->loginCredentials['reseller']);
        } else {
            if (count($this->resellers)) {
                $select_reseller[$this->filters['reseller']]='selected';
                printf ("<select name=%s>",$name);
                print "<option>";
                foreach (array_keys($this->resellers) as $_res) {
                    printf ("<option value='%s' %s>%s (%s)\n",$_res,$select_reseller[$_res],$_res,$this->resellers[$_res]);
                }
                print "</select>";
            } else {
                printf ("<input type=text size=5 name=%s value='%s'>",$name,$this->filters['reseller']);
            }
        }
    }

    function addFiltersToURL() {

        $j=0;
		foreach(array_keys($this->filters) as $filter) {
        	if (strlen(trim($this->filters[$filter]))) {
                if ($j) $url .='&';
            	$url .= sprintf('%s_filter=%s',$filter,urlencode(trim($this->filters[$filter])));
            }
            $j++;
        }

        return $url;
    }

    function printFiltersToForm() {
		foreach(array_keys($this->filters) as $filter) {
        	if (strlen(trim($this->filters[$filter]))) {
            	printf("<input type=hidden name=%s_filter value='%s'>",$filter,trim($this->filters[$filter]));
            }
        }
    }

    function getRecord () {
    }

    function updateRecord () {
    }

    function showRecord () {
    }

}

class Domains extends Records {

    function Domains(&$SOAPEngine) {

		$this->Records(&$SOAPEngine);

        if ($this->version > 1) {
            // keep default maxrowsperpage
        	$this->sortElements=array('changeDate' => 'Change date',
                  	        	      'domain'     => 'Domain'
	                        	     );

            $this->filters   = array(
                               'domain'       => trim($_REQUEST['domain_filter'])
                               );

        } else {
    		$this->maxrowsperpage = 10000;
        }
    }

    function listRecords() {

        $this->showSeachForm();
    
		if ($this->version > 1) {

            // Filter
            $filter=array(
                          'domain'    => $this->filters['domain'],
                          'customer'  => intval($this->filters['customer']),
                          'reseller'  => intval($this->filters['reseller'])
                          );
    
            // Range
            $range=array('start' => intval($this->next),
                         'count' => intval($this->maxrowsperpage)
                         );
    
            // Order
            if (!$this->sorting['sortBy'])    $this->sorting['sortBy']    = 'changeDate';
            if (!$this->sorting['sortOrder']) $this->sorting['sortOrder'] = 'DESC';
    
            $orderBy = array('attribute' => $this->sorting['sortBy'],
                             'direction' => $this->sorting['sortOrder']
                             );
    
            // Compose query
            $Query=array('filter'     => $filter,
                            'orderBy' => $orderBy,
                            'range'   => $range
                            );
    
            // Insert credetials
            $this->SOAPEngine->soapclient->addHeader($this->SOAPEngine->SoapAuth);
    
            // Call function
            $result     = $this->SOAPEngine->soapclient->getDomains($Query);
		} else {
            // Insert credetials
            $this->SOAPEngine->soapclient->addHeader($this->SOAPEngine->SoapAuth);
    
            // Call function
            $result     = $this->SOAPEngine->soapclient->getDomains();
        }

        if (PEAR::isError($result)) {
            $error_msg  = $result->getMessage();
            $error_fault= $result->getFault();
            $error_code = $result->getCode();
            printf ("<p><font color=red>Error from %s: %s (%s): %s</font>",$this->SOAPEngine->SOAPurl,$error_msg, $error_fault->detail->exception->errorcode,$error_fault->detail->exception->errorstring);
            return false;
        } else {

			if ($this->version > 1) {
				$this->rows = $result->total;
            } else {
				$this->rows = count($result);
            }

     		if ($this->rows && $_REQUEST['action'] != 'PerformActions' && $_REQUEST['action'] != 'Delete') {
                $this->showActionsForm();
            }

            print "
            <table border=0 align=center>
            <tr><td>$this->rows records found</td></tr>
            </table>
            <p>
            <table border=0 cellpadding=2 width=100%>
            <tr bgcolor=lightgrey>
                <td><b>Id</b></th>
                ";
                if ($this->version > 1) print "<td><b>Customer</b></td>";
                print"
                <td><b>Domain</b></td>
                <td><b>Change date</b></td>
                <td><b>Action</b></td>
            </tr>
            ";

            if (!$this->next)  $this->next=0;

            if ($this->rows > $this->maxrowsperpage)  {
                $maxrows = $this->maxrowsperpage + $this->next;
                if ($maxrows > $this->rows) $maxrows = $this->maxrowsperpage;
            } else {
                $maxrows=$this->rows;
            }

            $i=0;

			if ($this->rows) {
                while ($i < $maxrows)  {

					if ($this->version > 1) {
                    	if (!$result->domains[$i]) break;
                    	$domain = $result->domains[$i];
                    } else {
                    	$domain = $result[$i];
                    }

                    $index = $this->next+$i+1;
    
                    $rr=floor($index/2);
                    $mod=$index-$rr*2;
            
                    if ($mod ==0) {
                    	$bgcolor="lightgrey";
                    } else {
                        $bgcolor="white";
                    }

                    if ($this->version > 1) {
        			$_url = $this->url.sprintf("&service=%s&action=Delete&domain_filter=%s",
                    urlencode($this->SOAPEngine->service),
                    urlencode($domain->domain)
                    );

                    if ($_REQUEST['action'] == 'Delete' &&
                        $_REQUEST['domain_filter'] == $domain->domain) {
                		$_url .= "&confirm=1";
                        $actionText = "<font color=red>Confirm</font>";
                    } else {
                        $actionText = "Delete";
                    }

                    $_customer_url = $this->url.sprintf("&service=customers@%s&customer_filter=%s",
                    urlencode($this->SOAPEngine->soapEngineId),
                    urlencode($domain->customer)
                    );

                    printf("
                    <tr bgcolor=%s>
                    <td>%s</td>
                    <td><a href=%s>%s.%s</a></td>
                    <td>%s</td>
                    <td>%s</td>
                    <td><a href=%s>%s</a></td>
                    </tr>",
                    $bgcolor,
                    $index,
                    $_customer_url,
                    $domain->reseller,
                    $domain->customer,
                    $domain->domain,
                    $domain->changeDate,
                    $_url,
                    $actionText
                    );
                    } else {
        			$_url = $this->url.sprintf("&service=%s&action=Delete&domain_filter=%s",
                    urlencode($this->SOAPEngine->service),
                    urlencode($domain)
                    );

                    if ($_REQUEST['action'] == 'Delete' &&
                        $_REQUEST['domain_filter'] == $domain) {
                		$_url .= "&confirm=1";
                        $actionText = "<font color=red>Confirm</font>";
                    } else {
                        $actionText = "Delete";
                    }
                    printf("
                    <tr bgcolor=%s>
                    <td>%s</td>
                    <td>%s</td>
                    <td>%s</td>
                    <td><a href=%s>%s</a></td>
                    </tr>",
                    $bgcolor,
                    $index,
                    $domain,
                    $domain->changeDate,
                    $_url,
                    $actionText
                    );
                    }

                    $i++;
                }
			}

            print "</table>";

	        if ($this->version > 1) {
            	$this->showPagination($maxrows);
            }

            return true;
        }
    }

    function showSeachFormCustom() {

        if ($this->version > 1) {
        	printf (" Domain<input type=text size=15 name=domain_filter value='%s'>",$this->filters['domain']);
        }
    }

    function deleteRecord() {
        if (!$_REQUEST['confirm']) {
        	print "<p><font color=red>Please press on Confirm to confirm the delete. </font>";
            return true;
        }

        if (!strlen($this->filters['domain']) || !strlen($this->filters['domain'])) {
            print "<p><font color=red>Error: missing SIP domain. </font>";
            return false;
        }

        $function=array('commit'   => array('name'       => 'deleteDomain',
                                            'parameters' => array($this->filters['domain']),
                                            'logs'       => array('success' => sprintf('SIP domain %s has been deleted',$this->filters['domain']))
                                           )
                                           );

        unset($this->filters);
        return $this->SOAPEngine->execute($function);
    }

    function showAddForm() {
		if ($this->selectionActive) return;
        print "
        <p>
        <table border=0 class=border width=100%>
        <tr>
            ";
            printf ("<form method=post name=addform action=%s>",$_SERVER['PHP_SELF']);
            print "
        	<td align=left>
            ";

            print "
            <input type=submit name=action value=Add>
            ";

            printf (" Domain<input type=text size=20 name=domain>");

            print "Customer";

            if ($this->adminonly) {
            	$this->showResellerForm('reseller');
                print ".";
            	$this->showCustomerForm('customer');
            } else {
            	$this->showCustomerForm('customer');
            }

            print "
	        </td>
        	<td align=right>
            ";
            print "
	        </td>
            ";
            $this->printHiddenFormElements();

            print "
            </form>
        </tr>
        </table>
        ";
    }

    function addRecord() {

        $domain   = trim($_REQUEST['domain']);

        if ($this->adminonly) {
        	$reseller = trim($_REQUEST['reseller']);
        	$customer = trim($_REQUEST['customer']);
        } else {
        	$reseller = $this->reseller;
        	$customer = trim($_REQUEST['customer']);
            if (!$customer) $customer=$reseller;
        }

        if ($this->version  >1 ) {
            $domainStructure=array('domain'   => $domain,
                                   'customer' => intval($customer),
                                   'reseller' => intval($reseller)
                                   );
            $parameter=$domainStructure;
        } else {
            $parameter=$domain;
        }

        $function=array('commit'   => array('name'       => 'addDomain',
                                            'parameters' => array($parameter),
                                            'logs'       => array('success' => sprintf('SIP domain %s has been added',$domain))),
                        'rollback' => array('name'       => 'deleteDomain',
                                            'parameters' => array($parameter))
                                           );

        return $this->SOAPEngine->execute($function);

    }

    function getRecordKeys() {

		if ($this->version > 1) {
            // Filter
            $filter=array(
                          'domain'    => $this->filters['domain'],
                          'customer'  => intval($this->filters['customer']),
                          'reseller'  => intval($this->filters['reseller'])
                          );
    
            // Range
            $range=array('start' => intval($this->next),
                         'count' => intval($this->maxrowsperpage)
                         );
    
            // Order
            if (!$this->sorting['sortBy'])    $this->sorting['sortBy']    = 'changeDate';
            if (!$this->sorting['sortOrder']) $this->sorting['sortOrder'] = 'DESC';
    
            $orderBy = array('attribute' => $this->sorting['sortBy'],
                             'direction' => $this->sorting['sortOrder']
                             );

            // Compose query
            $Query=array('filter'     => $filter,
                            'orderBy' => $orderBy,
                            'range'   => $range
                            );
    
            $this->SOAPEngine->soapclient->addHeader($this->SOAPEngine->SoapAuth);
            $result     = $this->SOAPEngine->soapclient->getDomains($Query);

		} else {
            $this->SOAPEngine->soapclient->addHeader($this->SOAPEngine->SoapAuth);
            $result     = $this->SOAPEngine->soapclient->getDomains();
        }

        if (PEAR::isError($result)) {
            $error_msg  = $result->getMessage();
            $error_fault= $result->getFault();
            $error_code = $result->getCode();
            printf ("<p><font color=red>Error in getAllowedDomains from %s: %s (%s): %s</font>",$this->SOAPEngine->SOAPurl,$error_msg, $error_fault->detail->exception->errorcode,$error_fault->detail->exception->errorstring);
            //return false;
        } else {
			if ($this->version > 1) {
				foreach ($result->domains as $_domain) {
            		$this->selectionKeys[]=$_domain->domain;
                }
            } else {
            	$this->selectionKeys[]=$result;
            }
        }
   }

}

class SIPAccounts extends Records {
    var $sortElements=array('changeDate' => 'Change date',
                            'username'   => 'Username',
                            'domain'     => 'Domain'
                            );

    function SIPAccounts(&$SOAPEngine) {
        $this->filters = array('username' => trim($_REQUEST['username_filter']),
                               'domain'   => trim($_REQUEST['domain_filter']),
                               'fullname' => trim($_REQUEST['fullname_filter'])
                              );

		$this->Records(&$SOAPEngine);

    }

    function getRecordKeys() {

		if (preg_match("/^(.*)@(.*)$/",$this->filters['username'],$m)) {
        	$this->filters['username'] = $m[1];
            $this->filters['domain']   = $m[2];
        }

        // Filter
        $filter=array('username' => $this->filters['username'],
                      'domain'   => $this->filters['domain'],
                      'name'     => $this->filters['fullname'],
                      'owner'    => intval($this->filters['owner']),
                      'customer' => intval($this->filters['customer']),
                      'reseller' => intval($this->filters['reseller'])
                      );

        // Range
        $range=array('start' => 0,
                     'count' => 1000
                     );

        // Order
        if (!$this->sorting['sortBy'])    $this->sorting['sortBy']    = 'changeDate';
        if (!$this->sorting['sortOrder']) $this->sorting['sortOrder'] = 'DESC';

        $orderBy = array('attribute' => $this->sorting['sortBy'],
                         'direction' => $this->sorting['sortOrder']
                         );

        // Compose query
        $Query=array('filter'  => $filter,
                        'orderBy' => $orderBy,
                        'range'   => $range
                        );

        // Insert credetials
        $this->SOAPEngine->soapclient->addHeader($this->SOAPEngine->SoapAuth);

        // Call function
        $result     = $this->SOAPEngine->soapclient->getAccounts($Query);

        if (PEAR::isError($result)) {
            $error_msg  = $result->getMessage();
            $error_fault= $result->getFault();
            $error_code = $result->getCode();
            printf ("<p><font color=red>Error from %s: %s (%s): %s</font>",$this->SOAPEngine->SOAPurl,$error_msg, $error_fault->detail->exception->errorcode,$error_fault->detail->exception->errorstring);
            return false;
        } else {
			foreach ($result->accounts as $account) {
                $this->selectionKeys[]=array('username' => $account->id->username,
                                             'domain'   => $account->id->domain
                                             );
            }

            return true;
        }

        return false;
    }

    function listRecords() {
        $this->getAllowedDomains();

		if (preg_match("/^(.*)@(.*)$/",$this->filters['username'],$m)) {
        	$this->filters['username'] = $m[1];
            $this->filters['domain']   = $m[2];
        }

		$this->showSeachForm();

        // Filter
        $filter=array('username' => $this->filters['username'],
                      'domain'   => $this->filters['domain'],
                      'name'     => $this->filters['fullname'],
                      'owner'    => intval($this->filters['owner']),
                      'customer' => intval($this->filters['customer']),
                      'reseller' => intval($this->filters['reseller'])
                      );

        // Range
        $range=array('start' => intval($this->next),
                     'count' => intval($this->maxrowsperpage)
                     );

        // Order
        if (!$this->sorting['sortBy'])    $this->sorting['sortBy']    = 'changeDate';
        if (!$this->sorting['sortOrder']) $this->sorting['sortOrder'] = 'DESC';

        $orderBy = array('attribute' => $this->sorting['sortBy'],
                         'direction' => $this->sorting['sortOrder']
                         );

        // Compose query
        $Query=array('filter'  => $filter,
                        'orderBy' => $orderBy,
                        'range'   => $range
                        );

        // Insert credetials
        $this->SOAPEngine->soapclient->addHeader($this->SOAPEngine->SoapAuth);

        // Call function
        $result     = $this->SOAPEngine->soapclient->getAccounts($Query);

        if (PEAR::isError($result)) {
            $error_msg  = $result->getMessage();
            $error_fault= $result->getFault();
            $error_code = $result->getCode();
            printf ("<p><font color=red>Error from %s: %s (%s): %s</font>",$this->SOAPEngine->SOAPurl,$error_msg, $error_fault->detail->exception->errorcode,$error_fault->detail->exception->errorstring);
            return false;
        } else {

			$this->rows = $result->total;

            if ($this->rows && $_REQUEST['action'] != 'PerformActions' && $_REQUEST['action'] != 'Delete') {
                $this->showActionsForm();
            }

            print "
            <p>
            <table border=0 align=center>
            <tr><td>$this->rows records found</td></tr>
            </table>
            <p>
            <table border=0 cellpadding=2 width=100%>
            <tr bgcolor=lightgrey>
                <td><b>Id</b></th>
                ";
                if ($this->version > 1) print "<td><b>Customer</b></td>";
                print"
                <td><b>SIP account</b></td>
                <td><b>Name</b></td>
                <td><b>Email</b></td>
                <td><b>Caller Id</b></td>
                <td><b>Quota</b></td>
                <td><b>Groups</b></td>
                <td><b>Owner</b></td>
                <td><b>Change date</b></td>
                <td><b>Action</b></td>
            </tr>
            ";

            if (!$this->next)  $this->next=0;

            if ($this->rows > $this->maxrowsperpage)  {
                $maxrows = $this->maxrowsperpage + $this->next;
                if ($maxrows > $this->rows) $maxrows = $this->maxrowsperpage;
            } else {
                $maxrows=$this->rows;
            }

            $i=0;

			//print "<pre>";
            //print_r($result->accounts);

			if ($this->rows) {
                while ($i < $maxrows)  {
    
                    if (!$result->accounts[$i]) break;
    
                    $account = $result->accounts[$i];
    
                    $index=$this->next+$i+1;
    
                    $rr=floor($index/2);
                    $mod=$index-$rr*2;
            
                    if ($mod ==0) {
                    	$bgcolor="lightgrey";
                    } else {
                        $bgcolor="white";
                    }

        			$_url = $this->url.sprintf("&service=%s&action=Delete&username_filter=%s&domain_filter=%s",
                    urlencode($this->SOAPEngine->service),
                    urlencode($account->id->username),
                    urlencode($account->id->domain)
                    );

                    if ($_REQUEST['action'] == 'Delete' &&
                    	$_REQUEST['username_filter'] == $account->id->username &&
                        $_REQUEST['domain_filter'] == $account->id->domain) {
                		$_url .= "&confirm=1";
                        $actionText = "<font color=red>Confirm</font>";
                    } else {
                        $actionText = "Delete";
                    }

					if ($account->reseller) {
                    	$resellerSipSettingsPage=$account->reseller;
                    } else {
                    	$resellerSipSettingsPage=$this->reseller;
                    }

                    if ($this->SipSettingsPage) {
                        $url=sprintf('%s?account=%s@%s&reseller=%s&soapEngineIdSipPort=%s',
                        $this->SipSettingsPage,$account->id->username,$account->id->domain,
                        $resellerSipSettingsPage,$this->SOAPEngine->soapEngineIdSettingsPage);

                        if ($this->adminonly) $url  .= sprintf('&adminonly=%s',$this->adminonly);

                        foreach (array_keys($this->SOAPEngine->extraFormElements) as $element) {
                            if (!strlen($this->SOAPEngine->extraFormElements[$element])) continue;
                            $url  .= sprintf('&%s=%s',$element,urlencode($this->SOAPEngine->extraFormElements[$element]));
                        }

                        $sip_account=sprintf("
                        <a href=\"javascript:void(null);\" onClick=\"return window.open('%s', 'SIP_Settings',
                        'toolbar=1,status=1,menubar=1,scrollbars=1,resizable=1,width=800,height=720')\">
                        %s@%s</a>",$url,$account->id->username,$account->id->domain);
                    } else {
						$sip_account=sprintf("%s@%s",$account->id->username,$account->id->domain);
                    }


                    unset($groups);
                    foreach ($account->groups as $_grp) $groups.=$_grp.' ';

                    if ($this->version > 1) {
                        $_customer_url = $this->url.sprintf("&service=customers@%s&customer_filter=%s",
                        urlencode($this->SOAPEngine->soapEngineId),
                        urlencode($account->customer));

						if ($account->owner) {
                            $_owner_url = sprintf
                            ("<a href=%s&service=customers@%s&customer_filter=%s>%s</a>",
                            $this->url,
                            urlencode($this->SOAPEngine->soapEngineId),
                            urlencode($account->owner),
                            $account->owner
                            );
                        } else {
                        	$_owner_url='';
                        }          

                        printf("
                        <tr bgcolor=%s>
                        <td>%s </td>
                        <td><a href=%s>%s.%s</a></td>
                        <td>%s</td>
                        <td>%s %s</td>
                        <td><a href=mailto:%s>%s</a></td>
                        <td>%s</td>
                        <td>%s</td>
                        <td>%s</td>
                        <td>%s</td>
                        <td>%s</td>
                        <td><a href=%s>%s</a></td>
                        </tr>
                        ",
                        $bgcolor,
                        $index,
                        $_customer_url,
                        $account->reseller,
                        $account->customer,
                        $sip_account,
                        $account->firstName,
                        $account->lastName,
                        $account->email,
                        $account->email,
                        $account->rpid,
                        $account->quota,
                        $groups,
                        $_owner_url,
                        $account->changeDate,
                        $_url,
                        $actionText
                        );
                    } else {
                        printf("
                        <tr bgcolor=%s>
                        <td>%s </td>
                        <td>%s</td>
                        <td>%s %s</td>
                        <td><a href=mailto:%s>%s</a></td>
                        <td>%s</td>
                        <td>%s</td>
                        <td>%s</td>
                        <td>%s</td>
                        <td>%s</td>
                        <td><a href=%s>%s</a></td>
                        </tr>
                        ",
                        $bgcolor,
                        $index,
                        $sip_account,
                        $account->firstName,
                        $account->lastName,
                        $account->email,
                        $account->email,
                        $account->rpid,
                        $account->quota,
                        $groups,
                        $account->owner,
                        $account->changeDate,
                        $_url,
                        $actionText
                        );
                    }

                    $i++;
                }
    
			}

            print "</table>";

            $this->showPagination($maxrows);

            return true;
        }
    }

    function showSeachFormCustom() {
        printf ("User<input type=text size=15 name=username_filter value='%s'>",$this->filters['username']);
        printf ("@");

        if (count($this->allowedDomains) > 0) {
            if ($this->filters['domain'] && !in_array($this->filters['domain'],$this->allowedDomains)) {
            	printf ("<input type=text size=15 name=domain_filter value='%s'>",$this->filters['domain']);
            } else {
                $selected_domain[$this->filters['domain']]='selected';
                printf ("<select name=domain_filter>
                <option>");
                foreach ($this->allowedDomains as $_domain) {
                    printf ("<option value='$_domain' %s>$_domain",$selected_domain[$_domain]);
                }
                printf ("</select>");
            }
        } else {
            printf ("<input type=text size=15 name=domain_filter value='%s'>",$this->filters['domain']);
        }

        printf (" Name<input type=text size=15 name=fullname_filter value='%s'>",$this->filters['fullname']);
    }

    function deleteRecord() {
        if (!$_REQUEST['confirm']) {
        	print "<p><font color=red>Please press on Confirm to confirm the delete. </font>";
            return true;
        }

        if (!strlen($this->filters['username']) || !strlen($this->filters['domain'])) {
            print "<p><font color=red>Error: missing SIP account username or domain. </font>";
            return false;
        }

        $account=array('username' => $this->filters['username'],
                       'domain'   => $this->filters['domain']
        			  );

        $function=array('commit'   => array('name'       => 'deleteAccount',
                                            'parameters' => array($account),
                                            'logs'       => array('success' => sprintf('<p>SIP account %s@%s has been deleted',$this->filters['username'],$this->filters['domain'])
                                                                  )
                                           )

                        );

        unset($this->filters);
        return $this->SOAPEngine->execute($function);
    }

    function showAddForm() {
		if ($this->selectionActive) return;
        if (!$this->adminonly && count($this->allowedDomains) < 1) return;

        print "
        <p>
        <table border=0 class=border width=100%>
        <tr>
            ";
            printf ("<form method=post name=addform action=%s>",$_SERVER['PHP_SELF']);
            print "
        	<td align=left>
            ";

            print "
            <input type=submit name=action value=Add>
            ";

            printf (" User<input type=text size=15 name=account value='%s'>",$_REQUEST['account']);
            if (count($this->allowedDomains) > 0) {
            	print "@<select name=domain>";
                foreach ($this->allowedDomains as $_domain) {
                    print "<option value=$_domain>$_domain\n";
                }
                print "</select>";

            } else {
                printf ("<input type=text name=domain size=10 value='%s'>",$_REQUEST['domain']);
            }

            printf (" Pass<input type=password size=10 name=password value='%s'>",$_REQUEST['password']);
            printf (" Name<input type=text size=15 name=fullname value='%s'>",$_REQUEST['fullname']);
            printf (" Email<input type=text size=15 name=email value='%s'>",$_REQUEST['email']);
            //printf (" CallerId<input type=text size=11 name=rpid value='%s'>",$_REQUEST['rpid']);
            printf ("<nobr>Owner<input type=text size=5 name=owner value='%s'></nobr> ",$_REQUEST['owner']);
            printf ("<nobr>PSTN<input type=checkbox name=pstn value=1></nobr> ");
            printf ("<nobr>Quota<input type=text size=5 name=quota value='%s'></nobr> ",$_REQUEST['quota']);
            printf ("<nobr>Prepaid<input type=checkbox name=prepaid value=1></nobr> ");
            print "<nobr>";
            print "Customer";
            if ($this->adminonly) {
            	$this->showResellerForm('reseller');
                print ".";
            	$this->showCustomerForm('customer');
            } else {
            	$this->showCustomerForm('customer');
            }
            print "</nobr>";

            print "
	        </td>
        	<td align=right>
            ";
            print "
	        </td>
            ";
            $this->printHiddenFormElements();

            print "
            </form>
        </tr>
        </table>
        ";
    }

    function addRecord($dictionary=array()) {

    	if ($dictionary['account']) {
    		$account_els  = explode("@", $dictionary['account']);
        } else {
    		$account_els  = explode("@", trim($_REQUEST['account']));
        }

        if ($this->adminonly) {
            if ($dictionary['reseller']) {
        		$reseller = $dictionary['reseller'];
            } else {
        		$reseller = trim($_REQUEST['reseller']);
            }
            if ($dictionary['customer']) {
        		$customer = $dictionary['customer'];
            } else {
        		$customer = trim($_REQUEST['customer']);
            }
            if (!$customer) $customer=$reseller;
        } else {
        	$reseller = $this->reseller;

            if ($dictionary['customer']) {
        		$customer = $dictionary['customer'];
            } else {
        		$customer = trim($_REQUEST['customer']);
            }

            if (!$customer) $customer=$reseller;
        }

        $username=$account_els[0];

        if (strlen($account_els[1])) {
        	$domain=$account_els[1];
        } else if ($dictionary['domain']) {
            $domain=$dictionary['domain'];
        } else if ($_REQUEST['domain']) {
            $domain=trim($_REQUEST['domain']);

        } else {
            printf ("<p><font color=red>Error: Missing SIP domain</font>");
            return false;
        }

        if ($dictionary['fullname']) {
        	$name_els  = explode(" ", $dictionary['fullname']);
        } else {
        	$name_els  = explode(" ", trim($_REQUEST['fullname']));
        }

		if (strlen($name_els[0])) {
            $firstName=$name_els[0];
        } else {
            $firstName='Account';
        }

		if (strlen($name_els[1])) {
            $lastName=$name_els[1];
        } else {
            $lastName=$username;
        }

        if (strlen($dictionary['timezone'])) {
            $timezone=$dictionary['timezone'];
		} else if (strlen(trim($_REQUEST['timezone']))) {
            $timezone=trim($_REQUEST['timezone']);
        } else {
            $timezone='Europe/Amsterdam';
        }

        if (strlen($dictionary['password'])) {
            $password=$dictionary['password'];
        } else if (strlen(trim($_REQUEST['password']))) {
            $password=trim($_REQUEST['password']);
        } else {
            $password=$this->RandomPassword(6);
        }

		$groups=array();
		if($dictionary['pstn'] || $_REQUEST['pstn']) $groups[]='free-pstn';

        if (strlen($dictionary['email'])) {
			$email=$dictionary['email'];
        } else {
			$email=trim($_REQUEST['email']);
        }

        if (strlen($dictionary['owner'])) {
			$owner=intval($dictionary['owner']);
        } else {
			$owner=intval($_REQUEST['owner']);
        }
        if (strlen($dictionary['quota'])) {
			$quota=intval($dictionary['quota']);
        } else {
			$quota=intval($_REQUEST['quota']);
        }
        if (strlen($dictionary['prepaid'])) {
			$prepaid=intval($dictionary['prepaid']);
        } else {
			$prepaid=intval($_REQUEST['prepaid']);
        }

    	$regexp = "/^([a-z0-9][a-z0-9_.-]*)@([a-z0-9][a-z0-9-]*\.)+([a-z0-9]{2,})$/i";
        if (!preg_match($regexp, $uri)) $email=$username.'@'.$domain;

        $account=array(
                     'id'     => array('username' => $username,
                                       'domain'   => $domain),
                     'firstName'  => $firstName,
                     'lastName'   => $lastName,
                     'password'   => $password,
                     'timezone'   => $timezone,
                     'email'      => $email,
                     'owner'      => $owner,
                     'customer'   => intval($customer),
                     'reseller'   => intval($reseller),
                     'groups'     => $groups,
                     'prepaid'    => $prepaid,
                     'quota'      => $quota,
                     'region'     => ''
        			);

        //print_r($account);
        $deleteAccount=array('username' => $username,
                             'domain'   => $domain);


        $function=array('commit'   => array('name'       => 'addAccount',
                                            'parameters' => array($account),
                                            'logs'       => array('success' => sprintf('<p>SIP account %s@%s has been added',$username,$domain))),
                        'rollback' => array('name'       => 'deleteAlias',
                                            'parameters' => array($deleteAccount)
                                            )
                        );
     
        return $this->SOAPEngine->execute($function);

    }

    function RandomPassword($len=11) {
        $alf=array("a","b","c","d","e","f",
               "h","i","j","k","l","m",
               "n","p","r","s","t","w",
               "x","y","1","2","3","4",
               "5","6","7","8","9");
        $i=0;
        while($i < $len) {
            srand((double)microtime()*1000000);
            $randval = rand(0,28);
            $string="$string"."$alf[$randval]";
            $i++;
        }
        return $string;
    }

    function getAllowedDomains() {

		if ($this->version > 1) {

            // Filter
            $filter=array(
                          'domain'    => ''
                          );
    
            // Range
            $range=array('start' => 0,
                         'count' => 1000
                         );
    
            $orderBy = array('attribute' => 'domain',
                             'direction' => 'ASC'
                             );
    
            // Compose query
            $Query=array('filter'     => $filter,
                            'orderBy' => $orderBy,
                            'range'   => $range
                            );
    
            $this->SOAPEngine->soapclient->addHeader($this->SOAPEngine->SoapAuth);
            $result     = $this->SOAPEngine->soapclient->getDomains($Query);
		} else {
            $this->SOAPEngine->soapclient->addHeader($this->SOAPEngine->SoapAuth);
            $result     = $this->SOAPEngine->soapclient->getDomains();
        }

        if (PEAR::isError($result)) {
            $error_msg  = $result->getMessage();
            $error_fault= $result->getFault();
            $error_code = $result->getCode();
            printf ("<p><font color=red>Error in getAllowedDomains from %s: %s (%s): %s</font>",$this->SOAPEngine->SOAPurl,$error_msg, $error_fault->detail->exception->errorcode,$error_fault->detail->exception->errorstring);
            //return false;
        } else {
			if ($this->version > 1) {
				foreach ($result->domains as $_domain) {
            		$this->allowedDomains[]=$_domain->domain;
                }
            } else {
            	$this->allowedDomains=$result;
            }
        }

     }
}

class SIPAliases extends Records {
    var $sortElements=array(
                            'aliasUsername'  => 'Alias user',
                            'aliasDomain'    => 'Alias domain',
                            'targetUsername' => 'Target user',
                            'targetDomain'   => 'Target domain'
                            );

    function SIPAliases(&$SOAPEngine) {
        $this->filters   = array('aliasUsername'     => trim($_REQUEST['alias_username_filter']),
                                 'aliasDomain'       => trim($_REQUEST['alias_domain_filter']),
                                 'targetUsername'    => trim($_REQUEST['target_username_filter']),
                                 'targetDomain'      => trim($_REQUEST['target_domain_filter'])
                           );

		$this->Records(&$SOAPEngine);

    }

    function getRecordKeys() {

        // Filter
        $filter=array('aliasUsername'  => $this->filters['aliasUsername'],
                      'aliasDomain'    => $this->filters['aliasDomain'],
                      'targetUsername' => $this->filters['targetUsername'],
                      'targetDomain'   => $this->filters['targetDomain'],
                      'owner'          => intval($this->filters['owner']),
                      'customer'       => intval($this->filters['customer']),
                      'reseller'       => intval($this->filters['reseller'])
                      );

        // Range
        $range=array('start' => 0,
                     'count' => 1000
                     );

        // Order
        if (!$this->sorting['sortBy'])    $this->sorting['sortBy']    = 'aliasUsername';
        if (!$this->sorting['sortOrder']) $this->sorting['sortOrder'] = 'DESC';

        $orderBy = array('attribute' => $this->sorting['sortBy'],
                         'direction' => $this->sorting['sortOrder']
                         );

        // Compose query
        $Query=array('filter'  => $filter,
                        'orderBy' => $orderBy,
                        'range'   => $range
                        );

        //print_r($Query);
        // Insert credetials
        $this->SOAPEngine->soapclient->addHeader($this->SOAPEngine->SoapAuth);

        // Call function
        $result     = $this->SOAPEngine->soapclient->getAliases($Query);

        if (PEAR::isError($result)) {
            $error_msg  = $result->getMessage();
            $error_fault= $result->getFault();
            $error_code = $result->getCode();
            printf ("<p><font color=red>Error from %s: %s (%s): %s</font>",$this->SOAPEngine->SOAPurl,$error_msg, $error_fault->detail->exception->errorcode,$error_fault->detail->exception->errorstring);
            return false;
        } else {
			foreach ($result->aliases as $alias) {
                $this->selectionKeys[]=array('username' => $alias->id->username,
                                             'domain'   => $alias->id->domain);
            }

            return true;
        }
    }


    function listRecords() {
        $this->getAllowedDomains();

        // Make sure we apply the domain filter from the login credetials

		$this->showSeachForm();

        // Filter
        $filter=array('aliasUsername'  => $this->filters['aliasUsername'],
                      'aliasDomain'    => $this->filters['aliasDomain'],
                      'targetUsername' => $this->filters['targetUsername'],
                      'targetDomain'   => $this->filters['targetDomain'],
                      'owner'          => intval($this->filters['owner']),
                      'customer'       => intval($this->filters['customer']),
                      'reseller'       => intval($this->filters['reseller'])

                      );

        // Range
        $range=array('start' => intval($this->next),
                     'count' => intval($this->maxrowsperpage)
                     );

        // Order
        if (!$this->sorting['sortBy'])    $this->sorting['sortBy']    = 'aliasUsername';
        if (!$this->sorting['sortOrder']) $this->sorting['sortOrder'] = 'DESC';

        $orderBy = array('attribute' => $this->sorting['sortBy'],
                         'direction' => $this->sorting['sortOrder']
                         );

        // Compose query
        $Query=array('filter'  => $filter,
                        'orderBy' => $orderBy,
                        'range'   => $range
                        );

        // Insert credetials
        $this->SOAPEngine->soapclient->addHeader($this->SOAPEngine->SoapAuth);

        // Call function
        $result     = $this->SOAPEngine->soapclient->getAliases($Query);

        if (PEAR::isError($result)) {
            $error_msg  = $result->getMessage();
            $error_fault= $result->getFault();
            $error_code = $result->getCode();
            printf ("<p><font color=red>Error from %s: %s (%s): %s</font>",$this->SOAPEngine->SOAPurl,$error_msg, $error_fault->detail->exception->errorcode,$error_fault->detail->exception->errorstring);
            return false;
        } else {

			$this->rows = $result->total;

     		if ($this->rows && $_REQUEST['action'] != 'PerformActions' && $_REQUEST['action'] != 'Delete') {
                $this->showActionsForm();
            }

            print "
            <p>
            <table border=0 align=center>
            <tr><td>$this->rows records found</td></tr>
            </table>
            <p>
            <table border=0 cellpadding=2 width=100%>
            <tr bgcolor=lightgrey>
                <td><b>Id</b></th>
                ";
                if ($this->version > 1) print "<td><b>Customer</b></td>";
                print"
                <td><b>Alias</b></td>
                <td><b>Target</b></td>
                <td><b>Owner</b></td>
                <td><b>Change date</b></td>
                <td><b>Action</b></td>
            </tr>
            ";

            if (!$this->next)  $this->next=0;

            if ($this->rows > $this->maxrowsperpage)  {
                $maxrows = $this->maxrowsperpage + $this->next;
                if ($maxrows > $this->rows) $maxrows = $this->maxrowsperpage;
            } else {
                $maxrows=$this->rows;
            }

            $i=0;

			if ($this->rows) {
                while ($i < $maxrows)  {
    
                    if (!$result->aliases[$i]) break;
    
                    $alias = $result->aliases[$i];
    
                    $index=$this->next+$i+1;
    
                    $rr=floor($index/2);
                    $mod=$index-$rr*2;
            
                    if ($mod ==0) {
                    	$bgcolor="lightgrey";
                    } else {
                        $bgcolor="white";
                    }

        			$_url = $this->url.sprintf("&service=%s&action=Delete&alias_username_filter=%s&alias_domain_filter=%s",
                    urlencode($this->SOAPEngine->service),
                    urlencode($alias->id->username),
                    urlencode($alias->id->domain)
                    );

                    if ($_REQUEST['action'] == 'Delete' &&
                    	$_REQUEST['alias_username_filter'] == $alias->id->username &&
                        $_REQUEST['alias_domain_filter'] == $alias->id->domain) {
                		$_url .= "&confirm=1";
                        $actionText = "<font color=red>Confirm</font>";
                    } else {
                        $actionText = "Delete";
                    }

                    if ($this->version > 1) {

                        $_customer_url = $this->url.sprintf("&service=customers@%s&customer_filter=%s",
                        urlencode($this->SOAPEngine->soapEngineId),
                        urlencode($alias->customer)
                        );
    
						if ($alias->owner) {
                            $_owner_url = sprintf
                            ("<a href=%s&service=customers@%s&customer_filter=%s>%s</a>",
                            $this->url,
                            urlencode($this->SOAPEngine->soapEngineId),
                            urlencode($alias->owner),
                            $alias->owner
                            );
                        } else {
                        	$_owner_url='';
                        }          

                    printf("
                    <tr bgcolor=%s>
                    <td>%s</td>
                    <td><a href=%s>%s.%s</a></td>
                    <td>%s@%s</td>
                    <td>%s@%s</td>
                    <td>%s</td>
                    <td>%s</td>
                    <td><a href=%s>%s</a></td>
                    </tr>
                    ",
                    $bgcolor,
                    $index,
                    $_customer_url,
                    $alias->reseller,
                    $alias->customer,
                    $alias->id->username,
                    $alias->id->domain,
                    $alias->target->username,
                    $alias->target->domain,
                    $_owner_url,
                    $alias->changeDate,
                    $_url,
                    $actionText
                    );
                    } else {
                    printf("
                    <tr bgcolor=%s>
                    <td>%s</td>
                    <td>%s@%s</td>
                    <td>%s@%s</td>
                    <td>%s</td>
                    <td>%s</td>
                    <td><a href=%s>%s</a></td>
                    </tr>
                    ",
                    $bgcolor,
                    $index,
                    $alias->id->username,
                    $alias->id->domain,
                    $alias->target->username,
                    $alias->target->domain,
                    $alias->owner,
                    $alias->changeDate,
                    $_url,
                    $actionText
                    );
                    }
                    $i++;
    
                }
    
			}

            print "</table>";

            $this->showPagination($maxrows);

            return true;
        }
    }

    function deleteRecord() {
        if (!$_REQUEST['confirm']) {
        	print "<p><font color=red>Please press on Confirm to confirm the delete. </font>";
            return true;
        }

        if (!strlen($this->filters['aliasUsername']) || !strlen($this->filters['aliasDomain'])) {
            print "<p><font color=red>Error: missing SIP alias username or domain. </font>";
            return false;
        }

        $alias=array('username' => $this->filters['aliasUsername'],
                     'domain'   => $this->filters['aliasDomain']
        			);

        $function=array('commit'   => array('name'       => 'deleteAlias',
                                            'parameters' => array($alias),
                                            'logs'       => array('success' => sprintf('<p>SIP alias %s@%s has been deleted',$this->filters['aliasUsername'],$this->filters['aliasDomain'])
                                                                  )
                                           )

                        );


        unset($this->filters);
        return $this->SOAPEngine->execute($function);
    }

    function showSeachFormCustom() {
        printf (" Alias<input type=text size=10 name=alias_username_filter value='%s'>",$this->filters['aliasUsername']);
        printf ("@");

        if (count($this->allowedDomains) > 0) {
            if ($this->filters['aliasDomain'] && !in_array($this->filters['aliasDomain'],$this->allowedDomains)) {
            	printf ("<input type=text size=10 name=alias_domain_filter value='%s'>",$this->filters['aliasDomain']);
            } else {
                $selected_domain[$this->filters['aliasDomain']]='selected';
                printf ("<select name=alias_domain_filter>
                <option>");
    
                foreach ($this->allowedDomains as $_domain) {
                    printf ("<option value='$_domain' %s>$_domain",$selected_domain[$_domain]);
                }
    
                printf ("</select>");
            }
        } else {
            printf ("<input type=text size=10 name=alias_domain_filter value='%s'>",$this->filters['aliasDomain']);
        }

        printf (" Target<input type=text size=10 name=target_username_filter value='%s'>",$this->filters['targetUsername']);
        printf (" @<input type=text size=10 name=target_domain_filter value='%s'>",$this->filters['targetDomain']);

    }

    function showAddForm() {
		if ($this->selectionActive) return;
        if (!$this->adminonly && count($this->allowedDomains) < 1) return;

        print "
        <p>
        <table border=0 class=border width=100%>
        <tr>
            ";
            printf ("<form method=post name=addform action=%s>",$_SERVER['PHP_SELF']);
            print "
        	<td align=left>
            ";

            print "
            <input type=submit name=action value=Add>
            ";

            printf (" Alias<input type=text size=15 name=alias>");

            if (is_array($this->allowedDomains)) {
            	print "@<select name=domain>";
                foreach ($this->allowedDomains as $_domain) {
                    print "<option value=$_domain>$_domain\n";
                }
                print "</select>";
            }

            printf (" Target<input type=text size=35 name=target>");

            print "Customer";
            if ($this->adminonly) {
            	$this->showResellerForm('reseller');
                print ".";
            	$this->showCustomerForm('customer');
            } else {
            	$this->showCustomerForm('customer');
            }

            printf (" Owner<input type=text size=5 name=owner>");

            print "
	        </td>
        	<td align=right>
            ";
            print "
	        </td>
            ";
            $this->printHiddenFormElements();

            print "
            </form>
        </tr>
        </table>
        ";
    }

    function addRecord() {
    	$alias_els  = explode("@", trim($_REQUEST['alias']));
        $target_els = explode("@", trim($_REQUEST['target']));

        $username=$alias_els[0];

        if (strlen($alias_els[1])) {
        	$domain=$alias_els[1];

        } else if (trim($_REQUEST['domain'])) {
            $domain=trim($_REQUEST['domain']);

        } else {
            printf ("<p><font color=red>Error: Missing SIP domain</font>");
            return false;
        }

        if ($this->adminonly) {
        	$reseller = trim($_REQUEST['reseller']);
        	$customer = trim($_REQUEST['customer']);
            if (!$customer) $customer=$reseller;
        } else {
        	$reseller = $this->reseller;
        	$customer = trim($_REQUEST['customer']);
            if (!$customer || !in_array($customer,array_keys($this->customers))) {
                $customer=$reseller;
            }
        }

        $alias=array(
                     'id'     => array('username' => $username,
                                       'domain'   => $domain
                                       ),
                     'target' => array('username' => $target_els[0],
                                       'domain'   => $target_els[1]
                                       ),
                     'owner'  => intval($_REQUEST['owner']),
                     'customer'   => intval($customer),
                     'reseller'   => intval($reseller)
        			);

        //print_r($alias);

        $deleteAlias=array('username' => $username,
                           'domain'   => $domain);

        $function=array('commit'   => array('name'       => 'addAlias',
                                            'parameters' => array($alias),
                                            'logs'       => array('success' => sprintf('<p>SIP alias %s@%s has been added',$username,$domain))),
                        'rollback' => array('name'       => 'deleteAlias',
                                            'parameters' => array($deleteAlias)
                                            )
                        );
     
        return $this->SOAPEngine->execute($function);
    }

    function getAllowedDomains() {
		if ($this->version > 1) {

            // Filter
            $filter=array(
                          'domain'    => ''
                          );
    
            // Range
            $range=array('start' => 0,
                         'count' => 1000
                         );
    
            $orderBy = array('attribute' => 'domain',
                             'direction' => 'ASC'
                             );
    
            // Compose query
            $Query=array('filter'     => $filter,
                            'orderBy' => $orderBy,
                            'range'   => $range
                            );
    
            $this->SOAPEngine->soapclient->addHeader($this->SOAPEngine->SoapAuth);
            $result     = $this->SOAPEngine->soapclient->getDomains($Query);
		} else {
            $this->SOAPEngine->soapclient->addHeader($this->SOAPEngine->SoapAuth);
            $result     = $this->SOAPEngine->soapclient->getDomains();
        }

        if (PEAR::isError($result)) {
            $error_msg  = $result->getMessage();
            $error_fault= $result->getFault();
            $error_code = $result->getCode();
            printf ("<p><font color=red>Error from %s: %s (%s): %s</font>",$this->SOAPEngine->SOAPurl,$error_msg, $error_fault->detail->exception->errorcode,$error_fault->detail->exception->errorstring);
            return false;
        } else {
			if ($this->version > 1) {
				foreach ($result->domains as $_domain) {
            		$this->allowedDomains[]=$_domain->domain;
                }
            } else {
            	$this->allowedDomains=$result;
            }
        }
    }
}

class ENUMranges extends Records {

    function ENUMranges(&$SOAPEngine) {
        $this->filters   = array('prefix'       => trim($_REQUEST['prefix_filter']),
                                 'tld'          => trim($_REQUEST['tld_filter'])
                                );
        
		$this->Records(&$SOAPEngine);

        if ($this->version > 1) {
        	$this->sortElements=array('changeDate' => 'Change date',
                  	        	      'prefix'     => 'Prefix',
                    	        	  'tld'        => 'TLD'
	                        	     );
        }
    }

    function listRecords() {
        $this->getAllowedDomains();

		$this->showSeachForm();

		if ($this->version > 1) {
            // Filter
            $filter=array('prefix'   => $this->filters['prefix'],
                          'tld'      => $this->filters['tld'],
  	                      'customer' => intval($this->filters['customer']),
    	                  'reseller' => intval($this->filters['reseller'])
                          );

            // Range
            $range=array('start' => intval($this->next),
                         'count' => intval($this->maxrowsperpage)
                         );
    
            // Order
            if (!$this->sorting['sortBy'])    $this->sorting['sortBy']    = 'changeDate';
            if (!$this->sorting['sortOrder']) $this->sorting['sortOrder'] = 'DESC';
    
            $orderBy = array('attribute' => $this->sorting['sortBy'],
                             'direction' => $this->sorting['sortOrder']
                             );
    
            // Compose query
            $Query=array('filter'  => $filter,
                         'orderBy' => $orderBy,
                         'range'   => $range
                         );
    
            $this->SOAPEngine->soapclient->addHeader($this->SOAPEngine->SoapAuth);
            $result     = $this->SOAPEngine->soapclient->getRanges($Query);
    
        } else {
        	$this->SOAPEngine->soapclient->addHeader($this->SOAPEngine->SoapAuth);
        	$result     = $this->SOAPEngine->soapclient->getRanges();
        }

        if (PEAR::isError($result)) {
            $error_msg  = $result->getMessage();
            $error_fault= $result->getFault();
            $error_code = $result->getCode();
            printf ("<p><font color=red>Error from %s: %s (%s): %s</font>",$this->SOAPEngine->SOAPurl,$error_msg, $error_fault->detail->exception->errorcode,$error_fault->detail->exception->errorstring);
            return false;
        } else {

			if ($this->version > 1) {
				$this->rows = $result->total;
            } else {
				$this->rows = count($result);
            }

     		if ($this->rows && $_REQUEST['action'] != 'PerformActions' && $_REQUEST['action'] != 'Delete') {
                $this->showActionsForm();
            }

            print "
            <p>
            <table border=0 align=center>
            <tr><td>$this->rows records found</td></tr>
            </table>
            <p>
            <table border=0 cellpadding=2 width=100%>
            <tr bgcolor=lightgrey>
                <td><b>Id</b></th>
                ";
                if ($this->version > 1) print "<td><b>Customer</b></td>";
                print"
                <td><b>Prefix </b></td>
                <td><b>TLD</b></td>
                <td><b>TTL</b></td>
                <td><b>Min digits</b></td>
                <td><b>Max digits</b></td>
                <td><b>Size</b></td>
                <td><b>Used</b></td>
                <td><b>Change date</b></td>
                <td><b>Action</b></td>
            </tr>
            ";

     		if (!$this->next)  $this->next=0;

            if ($this->rows > $this->maxrowsperpage)  {
                $maxrows = $this->maxrowsperpage + $this->next;
                if ($maxrows > $this->rows) $maxrows = $this->maxrowsperpage;
            } else {
                $maxrows=$this->rows;
            }

            $i=0;

			if ($this->rows) {
                while ($i < $maxrows)  {
    
					if ($this->version > 1) {
                    	if (!$result->ranges[$i]) break;
                    	$range = $result->ranges[$i];

                    } else {
                    	$range = $result[$i];
                    }

                    $index=$this->next+$i+1;
    
                    $rr=floor($index/2);
                    $mod=$index-$rr*2;
            
                    if ($mod ==0) {
                    	$bgcolor="lightgrey";
                    } else {
                        $bgcolor="white";
                    }

        			$_url = $this->url.sprintf("&service=%s&action=Delete&prefix_filter=%s&tld_filter=%s",
                    urlencode($this->SOAPEngine->service),
                    urlencode($range->id->prefix),
                    urlencode($range->id->tld)
                    );

                    if ($_REQUEST['action'] == 'Delete' &&
                        $_REQUEST['prefix_filter'] == $range->id->prefix &&
                        $_REQUEST['tld_filter'] == $range->id->tld) {
                		$_url .= "&confirm=1";
                        $actionText = "<font color=red>Confirm</font>";
                    } else {
                        $actionText = "Delete";
                    }

                    if (strlen($this->SOAPEngine->recordGenerator)) {
                        $range_link=sprintf('<a href=%s&generatorId=%s&range=%s@%s&len=%s&reseller_filter=%s target=generator>%s</a>',$this->url,$this->SOAPEngine->recordGenerator,$range->id->prefix,$range->id->tld,$range->maxDigits,$range->reseller,$range->id->prefix);
                    } else {
                    	$range_link=$range->id->prefix;
                    }

                    if ($this->version > 1) {
        			$_customer_url = $this->url.sprintf("&service=customers@%s&customer_filter=%s",
                    urlencode($this->SOAPEngine->soapEngineId),
                    urlencode($range->customer)
                    );
                    
                    printf("
                    <tr bgcolor=%s>
                    <td>%s</td>
                    <td><a href=%s>%s.%s</a></td>
                    <td>+%s</td>
                    <td>%s</td>
                    <td>%s</td>
                    <td>%s</td>
                    <td>%s</td>
                    <td>%s</td>
                    <td>%s</td>
                    <td>%s</td>
                    <td><a href=%s>%s</a></td>
                    </tr>",
                    $bgcolor,
                    $index,
                    $_customer_url,
                    $range->reseller,
                    $range->customer,
                    $range_link,
                    $range->id->tld,
                    $range->ttl,
                    $range->minDigits,
                    $range->maxDigits,
                    $range->size,
                    $range->used,
                    $range->changeDate,
                    $_url,
                    $actionText
                    );
                    } else {
                    printf("
                    <tr bgcolor=%s>
                    <td>%s</td>
                    <td>+%s</td>
                    <td>%s</td>
                    <td>%s</td>
                    <td>%s</td>
                    <td>%s</td>
                    <td>%s</td>
                    <td>%s</td>
                    <td><a href=%s>%s</a></td>
                    </tr>",
                    $bgcolor,
                    $index,
                    $range_link,
                    $range->id->tld,
                    $range->ttl,
                    $range->minDigits,
                    $range->maxDigits,
                    $range->used,
                    $range->changeDate,
                    $_url,
                    $actionText
                    );

                    }
                    printf("
                    </tr>
                    ");

                    $i++;
    
                }
    
			}

            print "</table>";

            $this->showPagination($maxrows);

            return true;
        }
    }

    function deleteRecord() {
        if (!$_REQUEST['confirm']) {
        	print "<p><font color=red>Please press on Confirm to confirm the delete. </font>";
            return true;
        }

        if (!strlen($this->filters['prefix']) || !strlen($this->filters['tld'])) {
            print "<p><font color=red>Error: missing ENUM range id </font>";
            return false;
        }

        $rangeId=array('prefix'=>$this->filters['prefix'],
                       'tld'=>$this->filters['tld']);

        $function=array('commit'   => array('name'       => 'deleteRange',
                                            'parameters' => array($rangeId),
                                            'logs'       => array('success' => sprintf('<p>ENUM range +%s under %s has been deleted',$this->filters['prefix'],$this->filters['tld'])
                                                                  )
                                            )
                        );

        unset($this->filters);
        return $this->SOAPEngine->execute($function);
    }

    function showAddForm() {
		if ($this->selectionActive) return;

        print "
        <p>
        <table border=0 class=border width=100%>
        <tr>
            ";
            printf ("<form method=post name=addform action=%s>",$_SERVER['PHP_SELF']);
            print "
        	<td align=left>
            ";

            print "
            <input type=submit name=action value=Add>
            ";
            printf ("Prefix +<input type=text size=5 name=prefix> ");
            printf (" TLD");
            /*
            if (is_array($this->allowedDomains)) {
            	print "<select name=tld>";
                foreach ($this->allowedDomains as $_tld) {
                    print "<option value=$_tld>$_tld\n";
                }
                print "</select>";
            } else {
                print "<input type=text size=15 name=tld>";
            }
            */
            print "<input type=text size=15 name=tld>";
            printf ("TTL<input type=text size=5 name=ttl value=3600> ");
            printf ("Min Digits<input type=text size=3 name=minDigits value=11> ");
            printf ("Max Digits<input type=text size=3 name=maxDigits value=11> ");
            print "Customer";
            if ($this->adminonly) {
            	$this->showResellerForm('reseller');
                print ".";
            	$this->showCustomerForm('customer');
            } else {
            	$this->showCustomerForm('customer');
            }
            //printf ("Info<input type=text size=15 name=info> ");

            print "
	        </td>
        	<td align=right>
            ";
            print "
	        </td>
            ";

            $this->printHiddenFormElements();

            print "
            </form>
        </tr>
        </table>
        ";
    }

    function addRecord() {
    	$tld    = trim($_REQUEST['tld']);
        $prefix = trim($_REQUEST['prefix']);
        $info   = trim($_REQUEST['info']);

        if (!strlen($tld)) {
            if (strlen($this->SOAPEngine->defaultEnumTLD)) {
                $tld=$this->SOAPEngine->defaultEnumTLD;
            } else {
        		$tld='e164.arpa';
            }
        }

		if (!strlen($tld) || !strlen($prefix) || !is_numeric($prefix)) {
            printf ("<p><font color=red>Error: Missing TLD or prefix. </font>");
            return false;
        }

        if ($this->adminonly) {
        	$reseller = trim($_REQUEST['reseller']);
        	$customer = trim($_REQUEST['customer']);
            if (!$customer) $customer=$reseller;
        } else {
        	$reseller = $this->reseller;
        	$customer = trim($_REQUEST['customer']);
            if (!$customer || !in_array($customer,array_keys($this->customers))) {
                $customer=$reseller;
            }
        }

		if (!trim($_REQUEST['ttl'])) {
            $ttl=3600;
        } else {
            $ttl=intval(trim($_REQUEST['ttl']));
        }

        $range=array(
                     'id'         => array('prefix' => $prefix,
                                           'tld'    => $tld),
                     'ttl'        => $ttl,
                     'minDigits'  => intval(trim($_REQUEST['minDigits'])),
                     'maxDigits'  => intval(trim($_REQUEST['maxDigits'])),
                     'customer'   => intval($customer),
                     'reseller'   => intval($reseller)
        			);

        $deleteRange=array('prefix'=>$prefix,
                           'tld'=>$tld);

        $function=array('commit'   => array('name'       => 'addRange',
                                            'parameters' => array($range),
                                            'logs'       => array('success' => sprintf('<p>ENUM range +%s under %s has been added',$prefix,$tld))),
                        'rollback' => array('name'       => 'deleteRange',
                                            'parameters' => array($deleteRange)
                                            )
                        );
     
        return $this->SOAPEngine->execute($function);

    }

    function showSeachFormCustom() {
        if ($this->version > 1) {
        	printf (" Prefix<input type=text size=10 name=prefix_filter value='%s'>",$this->filters['prefix']);
            printf (" TLD");

            if (count($this->allowedDomains) > 0) {
                $selected_tld[$this->filters['tld']]='selected';
                printf ("<select name=tld_filter>
                <option>");
    
                foreach ($this->allowedDomains as $_tld) {
                    printf ("<option value='%s' %s>%s",$_tld,$selected_tld[$_tld],$_tld);
                }
    
                printf ("</select>");
            } else {
                printf ("<input type=text size=10 name=tld_filter value='%s'>",$this->filters['tld']);
            }
        }
    }

    function getAllowedDomains() {
        // Insert credetials
		if ($this->version > 1) {
            // Filter
            $filter=array('prefix'   => '');
            // Range
            $range=array('start' => 0,
                         'count' => 200
                         );
    
            // Order
            if (!$this->sorting['sortBy'])    $this->sorting['sortBy']    = 'changeDate';
            if (!$this->sorting['sortOrder']) $this->sorting['sortOrder'] = 'DESC';
    
            $orderBy = array('attribute' => $this->sorting['sortBy'],
                             'direction' => $this->sorting['sortOrder']
                             );
    
            // Compose query
            $Query=array('filter'  => $filter,
                         'orderBy' => $orderBy,
                         'range'   => $range
                         );
    
            $this->SOAPEngine->soapclient->addHeader($this->SOAPEngine->SoapAuth);
            $result     = $this->SOAPEngine->soapclient->getRanges($Query);
    
        } else {
        	$this->SOAPEngine->soapclient->addHeader($this->SOAPEngine->SoapAuth);
        	$result     = $this->SOAPEngine->soapclient->getRanges();
        }

        if (PEAR::isError($result)) {
            $error_msg  = $result->getMessage();
            $error_fault= $result->getFault();
            $error_code = $result->getCode();
            printf ("<p><font color=red>Error from %s: %s (%s): %s</font>",$this->SOAPEngine->SOAPurl,$error_msg, $error_fault->detail->exception->errorcode,$error_fault->detail->exception->errorstring);
            return false;
        } else {
			if ($this->version > 1) {
                foreach($result->ranges as $range) {
                    $this->ranges[]=array('prefix'    => $range->id->prefix,
                                          'tld'       => $range->id->tld,
                                          'minDigits' => $range->minDigits,
                                          'maxDigits' => $range->maxDigits
                                          );
                    if (in_array($range->id->tld,$this->allowedDomains)) continue;
                    $this->allowedDomains[]=$range->id->tld;
                    $seen[$range->id->tld]++;
                }
            } else {
                foreach($result as $range) {
                    $this->ranges[]=array('prefix'    => $range->id->prefix,
                                          'tld'       => $range->id->tld,
                                          'minDigits' => $range->minDigits,
                                          'maxDigits' => $range->maxDigits
                                          );
                    if (in_array($range->id->tld,$this->allowedDomains)) continue;
                    $this->allowedDomains[]=$range->id->tld;
                    $seen[$range->id->tld]++;
                }
            }

            if (strlen($this->SOAPEngine->defaultEnumTLD) && !$seen[$this->SOAPEngine->defaultEnumTLD]) {
            	$this->allowedDomains[]=$this->SOAPEngine->defaultEnumTLD;
            }
        }
    }
}

class ENUMmappings extends Records {

    var $sortElements=array('changeDate' => 'Change date',
                            'number'     => 'Number',
                            'tld'        => 'TLD'
                            );

    var $ranges=array();

    var $FieldsReadOnly=array(
                              'reseller'
                              );
    var $Fields=array(
                              'customer' => array('type'=>'integer'),
                              'owner'    => array('type'=>'integer'),
                              'info'     => array('type'=>'string')
                              );

    var $mapping_fields=array('id'       => 'integer',
                              'type'     => 'string',
                              'mapto'    => 'string',
                              'priority' => 'integer',
                              'ttl'      => 'integer'
                              );

    var $NAPTR_services=array(
        "sip"    => array("service"=>"sip",
                              "webname"=>"SIP",
                              "schemas"=>array("sip:","sips:")),
        "mailto" => array("service"=>"mailto",
                              "webname"=>"Email",
                              "schemas"=>array("mailto:")),
        "web:http"   => array("service"=>"web:http",
                              "webname"=>"WEB (http)",
                              "schemas"=>array("http://")),
        "web:https"  => array("service"=>"web:https",
                              "webname"=>"WEB (https)",
                              "schemas"=>array("https://")),
        "x-skype:callto" => array("service"=>"x-skype:callto",
                              "webname"=>"Skype",
                              "schemas"=>array("callto:")),
        "h323"   => array("service"=>"h323",
                              "webname"=>"H323",
                              "schemas"=>array("h323:")),
        "iax"    => array("service"=>"iax",
                              "webname"=>"IAX",
                              "schemas"=>array("iax:")),
        "iax2"   => array("service"=>"iax2",
                              "webname"=>"IAX2",
                              "schemas"=>array("iax2:")),
        "mms"    => array("service"=>"mms",
                              "webname"=>"MMS",
                              "schemas"=>array("tel:","mailto:")),
        "sms"    => array("service"=>"sms",
                              "webname"=>"SMS",
                              "schemas"=>array("tel:","mailto:")),
        "ems"    => array("service"=>"ems",
                              "webname"=>"EMS",
                              "schemas"=>array("tel:","mailto:")),
        "im"     => array("service"=>"im",
                              "webname"=>"IM",
                              "schemas"=>array("im:")),
        "npd:tel"   => array("service"=>"npd+tel",
                              "webname"=>"Portability",
                              "schemas"=>array("tel:")),
        "void:mailto"  => array("service"=>"void:mailto",
                              "webname"=>"VOID(mail)",
                              "schemas"=>array("mailto:")),
        "void:http"  => array("service"=>"void:http",
                              "webname"=>"VOID(http)",
                              "schemas"=>array("http://")),
        "void:https" => array("service"=>"void:https",
                              "webname"=>"VOID(https)",
                              "schemas"=>array("https://")),
        "voice"  => array("service"=>"voice",
                              "webname"=>"Voice",
                              "schemas"=>array("voice:","tel:")),
        "tel"    => array("service"=>"tel",
                              "webname"=>"Tel",
                              "schemas"=>array("tel:")),
        "fax:tel"    => array("service"=>"fax:tel",
                              "webname"=>"Fax",
                              "schemas"=>array("tel:")),
        "ifax:mailto"   => array("service"=>"ifax:mailto",
                              "webname"=>"iFax",
                              "schemas"=>array("mailto:")),
        "pres"   => array("service"=>"pres",
                              "webname"=>"Presence",
                              "schemas"=>array("pres:")),
        "ft:ftp"    => array("service"=>"ft:ftp",
                              "webname"=>"FTP",
                              "schemas"=>array("ftp://")),
        "loc:http"  => array("service"=>"loc:http",
                              "webname"=>"GeoLocation",
                              "schemas"=>array("http://")),
        "key:http"  => array("service"=>"key:http",
                              "webname"=>"Public key",
                              "schemas"=>array("http://"))
        );

    function ENUMmappings(&$SOAPEngine) {
        $this->filters   = array('number'       => trim($_REQUEST['number_filter']),
                                 'tld'          => trim($_REQUEST['tld_filter']),
                                 'type'         => trim($_REQUEST['type_filter']),
                                 'mapto'        => trim($_REQUEST['mapto_filter']),
                                 'owner'        => trim($_REQUEST['owner_filter'])
                                );
		$this->Records(&$SOAPEngine);
    }


    function listRecords() {
        $this->getAllowedDomains();

		$this->showSeachForm();

        $filter=array('number'   => $this->filters['number'],
        			  'tld'      => $this->filters['tld'],
                      'type'     => $this->filters['type'],
                      'mapto'    => $this->filters['mapto'],
                      'owner'    => intval($this->filters['owner']),
                      'customer' => intval($this->filters['customer']),
                      'reseller' => intval($this->filters['reseller'])
                      );
        // Range
        $range=array('start' => intval($this->next),
                     'count' => intval($this->maxrowsperpage)
                     );

        // Order
        if (!$this->sorting['sortBy'])    $this->sorting['sortBy']    = 'changeDate';
        if (!$this->sorting['sortOrder']) $this->sorting['sortOrder'] = 'DESC';

        $orderBy = array('attribute' => $this->sorting['sortBy'],
                         'direction' => $this->sorting['sortOrder']
                         );

        // Compose query
        $Query=array('filter'  => $filter,
                     'orderBy' => $orderBy,
                     'range'   => $range
                     );

        // Insert credetials
        $this->SOAPEngine->soapclient->addHeader($this->SOAPEngine->SoapAuth);

        // Call function
        $result     = $this->SOAPEngine->soapclient->getNumbers($Query);

        if (PEAR::isError($result)) {
            $error_msg  = $result->getMessage();
            $error_fault= $result->getFault();
            $error_code = $result->getCode();
            printf ("<p><font color=red>Error from %s: %s (%s): %s</font>",$this->SOAPEngine->SOAPurl,$error_msg, $error_fault->detail->exception->errorcode,$error_fault->detail->exception->errorstring);
            return false;
        } else {

			$this->rows = $result->total;

     		if ($this->rows && $_REQUEST['action'] != 'PerformActions' && $_REQUEST['action'] != 'Delete') {
                $this->showActionsForm();
            }

            print "
            <p>
            <table border=0 align=center>
            <tr><td>$this->rows records found</td></tr>
            </table>
            <p>
            <table border=0 cellpadding=2 width=100%>
            <tr bgcolor=lightgrey>
                <td><b>Id</b></th>
                ";
                if ($this->version > 1) {
                    print "<td><b>Customer</b></td>
                    <td><b>Number</b></td>
                    <td><b>TLD</b></td>
                    <td><b>Srv</b></td>
                    <td><b>Map to</b></td>
                    <td><b>TTL</b></td>
                    <td><b>Prio</b></td>
                    <td><b>Owner</b></td>
                    <td><b>Info</b></td>
                    <td><b>Change date</b></td>
                    <td><b>Action</b></td>
                    ";
                } else {
                    print "
                    <td><b>Number</b></td>
                    <td><b>TLD</b></td>
                    <td><b>Srv</b></td>
                    <td><b>Map to</b></td>
                    <td><b>TTL</b></td>
                    <td><b>Prio</b></td>
                    <td><b>Owner</b></td>
                    <td><b>Info</b></td>
                    <td><b>Action</b></td>
                    ";
                }
                print "
            </tr>
            ";

            if (!$this->next)  $this->next=0;

            if ($this->rows > $this->maxrowsperpage)  {
                $maxrows = $this->maxrowsperpage + $this->next;
                if ($maxrows > $this->rows) $maxrows = $this->maxrowsperpage;
            } else {
                $maxrows=$this->rows;
            }

            $i=0;

			if ($this->rows) {
                while ($i < $maxrows)  {
    
                    if (!$result->numbers[$i]) break;
    
                    $number = $result->numbers[$i];
    
                    $index=$this->next+$i+1;
    
                    $rr=floor($index/2);
                    $mod=$index-$rr*2;
            
                    if ($mod ==0) {
                    	$bgcolor="lightgrey";
                    } else {
                        $bgcolor="white";
                    }

                    $j=1;

                    foreach ($number->mappings as $_mapping) {
                        $_url = $this->url.sprintf("&service=%s&action=Delete&number_filter=%s&tld_filter=%s&mapto_filter=%s",
                        urlencode($this->SOAPEngine->service),
                        urlencode($number->id->number),
                        urlencode($number->id->tld),
                        urlencode($_mapping->mapto)
                        );
    
                        if ($_REQUEST['action'] == 'Delete' &&
                            $_REQUEST['number_filter'] == $number->id->number &&
                            $_REQUEST['tld_filter'] == $number->id->tld &&
                            $_REQUEST['mapto_filter'] == $_mapping->mapto) {
                            $_url .= "&confirm=1";
                            $actionText = "<font color=red>Confirm</font>";
                        } else {
                            $actionText = "Delete";
                        }

                        if ($j==1) {

                            $_number_url = $this->url.sprintf("&service=%s&number_filter=%s&tld_filter=%s",
                            urlencode($this->SOAPEngine->service),
        	                urlencode($number->id->number),
    	                    urlencode($number->id->tld)
                            );

                    		if ($this->version > 1) {
                                $_customer_url = $this->url.sprintf("&service=customers@%s&customer_filter=%s",
                                urlencode($this->SOAPEngine->soapEngineId),
                                urlencode($number->customer)
                                );
    
                                if ($number->owner) {
                                    $_owner_url = sprintf
                                    ("<a href=%s&service=customers@%s&customer_filter=%s>%s</a>",
                                    $this->url,
                                    urlencode($this->SOAPEngine->soapEngineId),
                                    urlencode($number->owner),
                                    $number->owner
                                    );
                                } else {
                                    $_owner_url='';
                                }          
    
                                printf("
                                <tr bgcolor=%s>
                                <td>%s</td>
                                <td><a href=%s>%s.%s</a></td>
                                <td><a href=%s>+%s</a></td>
                                <td>%s</td>
                                <td>%s</td>
                                <td>%s</td>
                                <td>%s</td>
                                <td>%s</td>
                                <td>%s</td>
                                <td>%s</td>
                                <td>%s</td>
                                <td><a href=%s>%s</a></td>
                                </tr>",
                                $bgcolor,
                                $index,
                                $_customer_url,
                                $number->reseller,
                                $number->customer,
                                $_number_url,
                                $number->id->number,
                                $number->id->tld,
                                ucfirst($_mapping->type),
                                $_mapping->mapto,
                                $_mapping->ttl,
                                $_mapping->priority,
                                $_owner_url,
                                $number->info,
                                $number->changeDate,
                                $_url,
                                $actionText
                                );
                            } else {
                                printf("
                                <tr bgcolor=%s>
                                <td>%s</td>
                                <td>+%s</td>
                                <td>%s</td>
                                <td>%s</td>
                                <td>%s</td>
                                <td>%s</td>
                                <td>%s</td>
                                <td>%s</td>
                                <td>%s</td>
                                <td><a href=%s>%s</a></td>
                                </tr>",
                                $bgcolor,
                                $index,
                                $number->id->number,
                                $number->id->tld,
                                ucfirst($_mapping->type),
                                $_mapping->mapto,
                                $_mapping->ttl,
                                $_mapping->priority,
                                $number->owner,
                                $number->info,
                                $_url,
                                $actionText
                                );
                            }
                        } else {
                    		if ($this->version > 1) {
                                printf("
                                <tr bgcolor=%s>
                                <td></td>
                                <td></td>
                                <td></td>
                                <td></td>
                                <td>%s</td>
                                <td>%s</td>
                                <td>%s</td>
                                <td>%s</td>
                                <td></td>
                                <td></td>
                                <td>%s</td>
                                <td><a href=%s>%s</a></td>
                                </tr>",
                                $bgcolor,
                                ucfirst($_mapping->type),
                                $_mapping->mapto,
                                $_mapping->ttl,
                                $_mapping->priority,
                                $number->changeDate,
                                $_url,
                                $actionText
                                );
                            } else {
                                printf("
                                <tr bgcolor=%s>
                                <td></td>
                                <td></td>
                                <td></td>
                                <td>%s</td>
                                <td>%s</td>
                                <td>%s</td>
                                <td></td>
                                <td></td>
                                <td>%s</td>
                                <td><a href=%s>%s</a></td>
                                </tr>",
                                $bgcolor,
                                ucfirst($_mapping->type),
                                $_mapping->mapto,
                                $_mapping->ttl,
                                $_mapping->priority,
                                $_url,
                                $actionText
                                );
                            }
                        }
                        $j++;
                    }

                    printf("
                    </tr>
                    ");

                    $i++;
    
                }
    
			}

            print "</table>";

			if ($this->rows == 1 ) {
                $this->showRecord($number);
            } else {
            	$this->showPagination($maxrows);
            }

            return true;
        }
    }

    function getLastNumber() {

        // Filter
        $filter=array('number' => ''
                      );
        // Range
        $range=array('start' => 0,
                     'count' => 1
                     );

        // Order
        if (!$this->sorting['sortBy'])    $this->sorting['sortBy']    = 'changeDate';
        if (!$this->sorting['sortOrder']) $this->sorting['sortOrder'] = 'DESC';

        $orderBy = array('attribute' => $this->sorting['sortBy'],
                         'direction' => $this->sorting['sortOrder']
                         );

        // Compose query
        $Query=array('filter'  => $filter,
                     'orderBy' => $orderBy,
                     'range'   => $range
                     );

        // Insert credetials
        $this->SOAPEngine->soapclient->addHeader($this->SOAPEngine->SoapAuth);

        // Call function
        $result     = $this->SOAPEngine->soapclient->getNumbers($Query);

        if (PEAR::isError($result)) {
            $error_msg  = $result->getMessage();
            $error_fault= $result->getFault();
            $error_code = $result->getCode();
            printf ("<p><font color=red>Error from %s: %s (%s): %s</font>",$this->SOAPEngine->SOAPurl,$error_msg, $error_fault->detail->exception->errorcode,$error_fault->detail->exception->errorstring);
            return false;
        } else {

			if ($result->total) {
            	$number = array('number'   => $result->numbers[0]->id->number,
                                'tld'      => $result->numbers[0]->id->tld,
                                'mappings' => $result->numbers[0]->mappings
                                );

                return $number;
            }

        }

        return false;
    }

    function showSeachFormCustom() {

        printf (" Number<input type=text size=15 name=number_filter value='%s'>",$this->filters['number']);
        printf (" TLD");
        if (count($this->allowedDomains) > 0) {
            $selected_tld[$this->filters['tld']]='selected';
            printf ("<select name=tld_filter>
            <option>");

            foreach ($this->allowedDomains as $_tld) {
                printf ("<option value='$_tld' %s>$_tld",$selected_tld[$_tld]);
            }

            printf ("</select>");
        } else {
            printf ("<input type=text size=10 name=tld_filter value='%s'>",$this->filters['tld']);
        }

        printf (" Srv");
                    print "<select name=type_filter>
                    <option>
                    ";
                    reset($this->NAPTR_services);
                    $selected_naptr_service[$this->filters['mapto']];
                    while (list($k,$v) = each($this->NAPTR_services)) {
                    	printf ("<option value='%s' %s>%s",$k,$selected_naptr_service[$k],$this->NAPTR_services[$k]['webname']);
                    }
   
                    print "
                    </select>
                    ";
        printf (" <nobr>Map to<input type=text size=20 name=mapto_filter value='%s'></nobr>",$this->filters['mapto']);

    }

    function deleteRecord($dictionary=array()) {

        if (!$dictionary['confirm'] && !$_REQUEST['confirm']) {
        	print "<p><font color=red>Please press on Confirm to confirm the delete. </font>";
            return true;
        }

        if ($dictionary['number']) {
            $number=$dictionary['number'];
        } else {
            $number=$this->filters['number'];
        }

        if ($dictionary['tld']) {
            $tld=$dictionary['tld'];
        } else {
            $tld=$this->filters['tld'];
        }

        if ($dictionary['mapto']) {
            $mapto=$dictionary['mapto'];
        } else {
            $mapto=$this->filters['mapto'];
        }

        if (!strlen($number) || !strlen($tld)) {
            print "<p><font color=red>Error: missing ENUM number or TLD </font>";
            return false;
        }

        $enum_id=array('number'=>$number,
                       'tld'=>$tld);

        $this->SOAPEngine->soapclient->addHeader($this->SOAPEngine->SoapAuth);
        $result     = $this->SOAPEngine->soapclient->getNumber($enum_id);

        if (!PEAR::isError($result)) {
            // the number exists and we make an update
            $result_new=$result;

            if (count($result->mappings) > 1) {
                foreach ($result->mappings as $_mapping) {
                    if ($_mapping->mapto != $mapto) {
                        $mappings_new[]=array('type'     => $_mapping->type,
                                              'mapto'    => $_mapping->mapto,
                                              'ttl'      => $_mapping->ttl,
                                              'priority' => $_mapping->priority
                                          );
                    }
                }
    
                $result_new->mappings=$mappings_new;
    
                $function=array('commit'   => array('name'       => 'updateNumber',
                                                    'parameters' => array($result_new),
                                                    'logs'       => array('success' => sprintf('<p>ENUM mapping %s has been deleted',$mapto))),
                                'rollback' => array('name'       => 'updateNumber',
                                                    'parameters' => array($result)
                                                    )
                                );
    
            } else {
                $function=array('commit'   => array('name'       => 'deleteNumber',
                                                    'parameters' => array($enum_id),
                                                    'logs'       => array('success' => sprintf('<p>ENUM number +%s under %s has been deleted',$number,$tld))),
                                'rollback' => array('name'       => 'addNumber',
                                                    'parameters' => array($result)
                                                    )
                                );
            }

            unset($this->filters);
            return $this->SOAPEngine->execute($function);

        } else {
            return false;
        }

    }

    function showAddForm() {
		//if ($this->selectionActive) return;

        print "
        <p>
        <table border=0 class=border width=100%>
        <tr>
        ";

        printf ("<form method=post name=addform action=%s>",$_SERVER['PHP_SELF']);
        print "
        <td align=left>
        ";

        print "
        <input type=submit name=action value=Add>
        ";
        printf (" Number +<input type=text size=15 name=number value='%s'>",$this->filters['number']);
        printf (" TLD");
        if (count($this->allowedDomains) >0) {
            $selected_tld[$this->filters['tld']]='selected';
            print "<select name=tld>";
            foreach ($this->allowedDomains as $_tld) {
                printf ("<option value=%s %s>%s\n",$_tld,$selected_tld[$_tld],$_tld);
            }
            print "</select>";
        } else {
            printf ("<input type=text size=15 name=tld value='%s'>",$this->filters['tld']);
        }

        printf (" Map to");
                print "<select name=type>
                ";
                reset($this->NAPTR_services);
                while (list($k,$v) = each($this->NAPTR_services)) {
                    printf ("<option value='%s' %s>%s",$k,$selected_naptr_service[$k],$this->NAPTR_services[$k]['webname']);
                }

                print "
                </select>
                ";
        printf (" <input type=text size=25 name=mapto>");
        printf (" TTL<input type=text size=5 name=ttl value=3600>");
        print "Customer";

        if ($this->adminonly) {
            $this->showResellerForm('reseller');
            print ".";
            $this->showCustomerForm('customer');
        } else {
            $this->showCustomerForm('customer');
        }

        printf (" Owner<input type=text size=5 name=owner>");
        printf (" Prio<input type=text size=3 name=priority>");

        print "
        </td>
        <td align=right>
        ";
        print "
        </td>
        ";

        $this->printHiddenFormElements();

        print "
        </form>
        </tr>
        </table>
        ";
    }

    function getAllowedDomains() {
		if ($this->version > 1) {
            // Filter
            $filter=array('prefix'   => ''
                          );
            // Range
            $range=array('start' => 0,
                         'count' => 200
                         );
    
            // Order
            $orderBy = array('attribute' => 'changeDate',
                             'direction' => 'ASC'
                             );
    
            // Compose query
            $Query=array('filter'  => $filter,
                         'orderBy' => $orderBy,
                         'range'   => $range
                         );
    
            $this->SOAPEngine->soapclient->addHeader($this->SOAPEngine->SoapAuth);
            $result     = $this->SOAPEngine->soapclient->getRanges($Query);
    
        } else {
        	$this->SOAPEngine->soapclient->addHeader($this->SOAPEngine->SoapAuth);
        	$result     = $this->SOAPEngine->soapclient->getRanges();
        }

        if (PEAR::isError($result)) {
            $error_msg  = $result->getMessage();
            $error_fault= $result->getFault();
            $error_code = $result->getCode();
            printf ("<p><font color=red>Error from %s: %s (%s): %s</font>",$this->SOAPEngine->SOAPurl,$error_msg, $error_fault->detail->exception->errorcode,$error_fault->detail->exception->errorstring);
            return false;
        } else {
			if ($this->version > 1) {
                foreach($result->ranges as $range) {
                    $this->ranges[]=array('prefix'    => $range->id->prefix,
                                          'tld'       => $range->id->tld,
                                          'minDigits' => $range->minDigits,
                                          'maxDigits' => $range->maxDigits
                                          );
                    if (in_array($range->id->tld,$this->allowedDomains)) continue;
                    $this->allowedDomains[]=$range->id->tld;
                    $seen[$range->id->tld]++;
                }
            } else {
                foreach($result as $range) {
                    $this->ranges[]=array('prefix'    => $range->id->prefix,
                                          'tld'       => $range->id->tld,
                                          'minDigits' => $range->minDigits,
                                          'maxDigits' => $range->maxDigits
                                          );
                    if (in_array($range->id->tld,$this->allowedDomains)) continue;
                    $this->allowedDomains[]=$range->id->tld;
                    $seen[$range->id->tld]++;
                }
            }
            if (strlen($this->SOAPEngine->defaultEnumTLD) && !$seen[$this->SOAPEngine->defaultEnumTLD]) {
            	$this->allowedDomains[]=$this->SOAPEngine->defaultEnumTLD;
            }
        }
    }

    function addRecord($dictionary=array()) {
        if ($dictionary['tld']) {
            $tld=$dictionary['tld'];
        } else {
    		$tld      = trim($_REQUEST['tld']);
        }
        if ($dictionary['number']) {
            $number=$dictionary['number'];
        } else {
    		$number      = trim($_REQUEST['number']);
        }

        if (!strlen($tld)) {
            if (strlen($this->SOAPEngine->defaultEnumTLD)) {
                $tld=$this->SOAPEngine->defaultEnumTLD;
            } else {
        		$tld='e164.arpa';
            }
        }

		if (!strlen($tld) || !strlen($number) || !is_numeric($number)) {
            printf ("<p><font color=red>Error: Missing TLD or number. </font>");
            return false;
        }

        if ($this->adminonly) {
        	if ($dictionary['reseller']) {
                $reseller=$dictionary['reseller'];
            } else {
            	$reseller = trim($_REQUEST['reseller']);
            }
        	if ($dictionary['customer']) {
                $customer=$dictionary['customer'];
            } else {
            	$customer = trim($_REQUEST['customer']);
            }
            if (!$customer) $customer=$reseller;
        } else {
        	$reseller = $this->reseller;
        	if ($dictionary['customer']) {
                $customer=$dictionary['customer'];
            } else {
            	$customer = trim($_REQUEST['customer']);
            }
            if (!$customer || !in_array($customer,array_keys($this->customers))) {
                $customer=$reseller;
            }
        }

        if ($dictionary['ttl']) {
            $ttl = intval($dictionary['ttl']);
        } else {
    		$ttl = intval(trim($_REQUEST['ttl']));
        }

		if (!$ttl) $ttl=3600;

        if ($dictionary['priority']) {
            $priority = intval($dictionary['priority']);
        } else {
    		$priority = intval(trim($_REQUEST['priority']));
        }

        if ($dictionary['owner']) {
            $owner = intval($dictionary['owner']);
        } else {
    		$owner = intval(trim($_REQUEST['owner']));
        }

		if (!$priority) $priority=5;

        $enum_id=array('number' => $number,
                       'tld'    => $tld);

        if ($dictionary['mapto']) {
            $mapto = $dictionary['mapto'];
        } else {
    		$mapto = trim($_REQUEST['mapto']);
        }

        if ($dictionary['type']) {
            $type = $dictionary['type'];
        } else {
    		$type = trim($_REQUEST['type']);
        }

        if (preg_match("/^([a-z0-9]+:\/\/)(.*)$/i",$mapto,$m)) {
        	$_scheme = $m[1];
            $_value  = $m[2];
        } else if (preg_match("/^([a-z0-9]+:)(.*)$/i",$mapto,$m)) {
        	$_scheme = $m[1];
            $_value  = $m[2];
        } else {
            $_scheme = '';
        	$_value  = $mapto;
        }

		if (!$_value) {
            $lastNumber=$this->getLastNumber();
            foreach($lastNumber['mappings'] as $_mapping) {
                if ($_mapping->type == trim($type)) {
                    if (preg_match("/^(.*)@(.*)$/",$_mapping->mapto,$m)) {
        				$_value = $number.'@'.$m[2];
                    	break;
                	}
                }
            }
        }

        if (!$_scheme || !in_array($_scheme,$this->NAPTR_services[trim($type)]['schemas'])) {
            $_scheme=$this->NAPTR_services[trim($type)]['schemas'][0];
        }

        $mapto=$_scheme.$_value;

        $enum_number=array('id'       => $enum_id,
                           'owner'    => $owner,
                           'customer' => intval($customer),
                           'reseller' => intval($reseller),
                           'mappings' => array(array('type'     => $type,
                                                     'mapto'    => $mapto,
                                                     'ttl'      => $ttl,
                                                     'priority' => $priority
                                                    )
                                               )
                           );

        $this->SOAPEngine->soapclient->addHeader($this->SOAPEngine->SoapAuth);
        $result     = $this->SOAPEngine->soapclient->getNumber($enum_id);

        if (PEAR::isError($result)) {
            $error_msg=$result->getMessage();
            $error_fault=$result->getFault();
            $error_code=$result->getCode();

            if ($error_fault->detail->exception->errorcode == "3002") {

                $function=array('commit'   => array('name'       => 'addNumber',
                                                    'parameters' => array($enum_number),
                                                    'logs'       => array('success' => sprintf('<p>ENUM number +%s under %s has been added',$number,$tld))),
                                'rollback' => array('name'       => 'deleteNumber',
                                                    'parameters' => array($enumId)
                                                    )
                                );
             
                return $this->SOAPEngine->execute($function);
            } else {
                printf ("<p><font color=red>Error from %s: %s (%s): %s</font>",$this->SOAPEngine->SOAPurl,$error_msg, $error_fault->detail->exception->errorcode,$error_fault->detail->exception->errorstring);
                return false;
            }
        } else {
            // the number exists and we make an update
            $result_new=$result;
            foreach ($result->mappings as $_mapping) {
                $mappings_new[]=array('type'     => $_mapping->type,
                                      'mapto'    => $_mapping->mapto,
                                      'ttl'      => $_mapping->ttl,
                                      'priority' => $_mapping->priority
                                      );

                if ($_mapping->mapto == $mapto) {
            		printf ("<p><font color=blue>Info: ENUM mapping %s for number %s already exists</font>",$mapto,$number);
                    return true;
                    break;
                }
            }

			$mappings_new[]=array('type'    => trim($type),
                                  'mapto'   => $mapto,
                                  'ttl'     => intval(trim($_REQUEST['ttl'])),
                                  'priority'=> intval(trim($_REQUEST['priority'])),
                                 );
            // add mapping
            $result_new->mappings=$mappings_new;

            $function=array('commit'   => array('name'       => 'updateNumber',
                                                'parameters' => array($result_new),
                                                'logs'       => array('success' => sprintf('<p>ENUM number +%s under %s has been updated',$number,$tld))),
                            'rollback' => array('name'       => 'updateNumber',
                                                'parameters' => array($result))
                            );
             
            return $this->SOAPEngine->execute($function);
        }
    }

    function getRecordKeys() {

        // Filter
        $filter=array('number' => $this->filters['number'],
                      'tld'    => $this->filters['tld'],
                      'type'   => $this->filters['type'],
                      'mapto'  => $this->filters['mapto']
                      );
        // Range
        $range=array('start' => 0,
                     'count' => 1000
                     );

        // Order
        if (!$this->sorting['sortBy'])    $this->sorting['sortBy']    = 'changeDate';
        if (!$this->sorting['sortOrder']) $this->sorting['sortOrder'] = 'DESC';

        $orderBy = array('attribute' => $this->sorting['sortBy'],
                         'direction' => $this->sorting['sortOrder']
                         );

        // Compose query
        $Query=array('filter'  => $filter,
                     'orderBy' => $orderBy,
                     'range'   => $range
                     );

        // Insert credetials
        $this->SOAPEngine->soapclient->addHeader($this->SOAPEngine->SoapAuth);

        // Call function
        $result     = $this->SOAPEngine->soapclient->getNumbers($Query);

        if (PEAR::isError($result)) {
            $error_msg  = $result->getMessage();
            $error_fault= $result->getFault();
            $error_code = $result->getCode();
            printf ("<p><font color=red>Error from %s: %s (%s): %s</font>",$this->SOAPEngine->SOAPurl,$error_msg, $error_fault->detail->exception->errorcode,$error_fault->detail->exception->errorstring);
            return false;
        } else {
			foreach ($result->numbers as $number) {
                $this->selectionKeys[]=array('number' => $number->id->number,
                                             'tld'    => $number->id->tld);
            }
            return true;
        }
    }

    function showRecord($number) {

        print "<table border=0 cellpadding=10>";
        print "
        <tr>
        <td valign=top>
        <h3>ENUM number</h3>
        <table border=0>";
        printf ("<form method=post name=addform action=%s>",$_SERVER['PHP_SELF']);
        print "<input type=hidden name=action value=Update>";

        print "<tr>
        <td colspan=2 class=border><input type=submit value=Update>
        </td></tr>";

        printf ("<tr bgcolor=lightgrey>
        <td class=border>Field</td>
        <td class=border>Value</td>
        </tr>");

        printf ("<tr><td class=border>DNS name</td><td class=border>%s</td></td>",
        $this->tel2enum($number->id->number,$number->id->tld));

        foreach ($this->FieldsReadOnly as $item) {
            printf ("<tr>
            <td class=border valign=top>%s</td>
            <td class=border>%s</td>
            </tr>",
            ucfirst($item),
            $number->$item
            );
        }

        foreach (array_keys($this->Fields) as $item) {
            if ($this->Fields[$item]['name']) {
                $item_name=$this->Fields[$item]['name'];
            } else {
            	$item_name=ucfirst($item);
            }

            if ($this->Fields[$item]['type'] == 'text') {
                printf ("<tr>
                <td class=border valign=top>%s</td>
                <td class=border><textarea cols=30 name=%s_form rows=4>%s</textarea></td>
                </tr>",
                $item_name,
                $item,
                $number->$item
                );
            } else {
                printf ("<tr>
                <td class=border valign=top>%s</td>
                <td class=border><input name=%s_form size=30 type=text value='%s'></td>
                </tr>",
                $item_name,
                $item,
                $number->$item
                );
            }
        }

        printf ("<input type=hidden name=tld_filter value='%s'",$number->id->tld);
        printf ("<input type=hidden name=number_filter value='%s'",$number->id->number);
        $this->printFiltersToForm();
        $this->printHiddenFormElements();

        print "</form>";
        print "
        </table>
        ";
    }

    function getRecord($enumid) {

        $this->SOAPEngine->soapclient->addHeader($this->SOAPEngine->SoapAuth);
        $result     = $this->SOAPEngine->soapclient->getNumber($enumid);

        if (PEAR::isError($result)) {
            $error_msg  = $result->getMessage();
            $error_fault= $result->getFault();
            $error_code = $result->getCode();
            printf ("<p><font color=red>Error from %s: %s (%s): %s</font>",$this->SOAPEngine->SOAPurl,$error_msg, $error_fault->detail->exception->errorcode,$error_fault->detail->exception->errorstring);
            return false;
        } else {
        	return $result;
        }
    }

    function updateRecord () {
        //print "<p>Updating number ...";

        if (!$_REQUEST['number_filter'] || !$_REQUEST['tld_filter']) return;

        $enumid=array('number' => $_REQUEST['number_filter'],
                      'tld'    => $_REQUEST['tld_filter']
                     );

        if (!$number = $this->getRecord($enumid)) {
            return false;
        }

        $number_old=$number;

        $new_mappings=array();

        foreach ($number->mappings as $_mapping) {
            foreach (array_keys($this->mapping_fields) as $field) {
                if ($this->mapping_fields[$field] == 'integer') {
                    $new_mapping[$field]=intval($_mapping->$field);
                } else {
                    $new_mapping[$field]=$_mapping->$field;
                }
            }

            $new_mappings[]=$new_mapping;
        }

        $number->mappings=$new_mappings;

        foreach (array_keys($this->Fields) as $item) {
            $var_name=$item.'_form';
            //printf ("<br>%s=%s",$var_name,$_REQUEST[$var_name]);
            if ($this->Fields[$item]['type'] == 'integer') {
                $number->$item = intval($_REQUEST[$var_name]);
            } else {
                $number->$item = trim($_REQUEST[$var_name]);
            }
        }

        //print_r($number);
        $function=array('commit'   => array('name'       => 'updateNumber',
                                            'parameters' => array($number),
                                            'logs'       => array('success' => sprintf('<p>ENUM number +%s under %s has been updated',$enumid['number'],$enumid['tld']))),
                        'rollback' => array('name'       => 'updateNumber',
                                            'parameters' => array($number_old))
                        );
     
        return $this->SOAPEngine->execute($function);

    }
}

class TrustedPeers extends Records {

    var $sortElements=array(
                            'description'   => 'Description',
                            'ip' =>'IP address'
                            );

    function TrustedPeers(&$SOAPEngine) {
    	$this->filters   = array('ip'     => trim($_REQUEST['ip_filter']),
                                 'description'  => trim($_REQUEST['description_filter'])
                                 );

		$this->Records(&$SOAPEngine);
    }

    function listRecords() {

		$this->showSeachForm();

        // Insert credetials
        $this->SOAPEngine->soapclient->addHeader($this->SOAPEngine->SoapAuth);

        // Filter
        $filter=array('ip' => $this->filters['ip'],
                      'description'   => $this->filters['description']
                      );

        // Range
        $range=array('start' => intval($this->next),
                     'count' => intval($this->maxrowsperpage)
                     );

        // Order
        if (!$this->sorting['sortBy'])    $this->sorting['sortBy']    = 'description';
        if (!$this->sorting['sortOrder']) $this->sorting['sortOrder'] = 'ASC';

        $orderBy = array('attribute' => $this->sorting['sortBy'],
                         'direction' => $this->sorting['sortOrder']
                         );

        // Compose query
        $Query=array('filter'  => $filter,
                        'orderBy' => $orderBy,
                        'range'   => $range
                        );

        // Call function
        $result     = $this->SOAPEngine->soapclient->getTrustedPeers($Query);

        if (PEAR::isError($result)) {
            $error_msg  = $result->getMessage();
            $error_fault= $result->getFault();
            $error_code = $result->getCode();
            printf ("<p><font color=red>Error from %s: %s (%s): %s</font>",$this->SOAPEngine->SOAPurl,$error_msg, $error_fault->detail->exception->errorcode,$error_fault->detail->exception->errorstring);
            return false;
        } else {

			$this->rows = $result->total;

     		if ($this->rows && $_REQUEST['action'] != 'PerformActions' && $_REQUEST['action'] != 'Delete') {
                $this->showActionsForm();
            }

            print "
            <table border=0 align=center>
            <tr><td>$this->rows records found</td></tr>
            </table>
            <p>
            <table border=0 cellpadding=2 width=100%>
            <tr bgcolor=lightgrey>
                <td><b>Id</b></th>
                ";
                if ($this->version > 1) print "<td><b>Customer</b></td>";
                print"
                <td><b>IP address</b></td>
                <td><b>Protocol</b></td>
                <td><b>From pattern</b></td>
                <td><b>Description</b></td>
                <td><b>Owner</b></td>
                <td><b>Action</b></td>
            </tr>
            ";

            if (!$this->next)  $this->next=0;

            if ($this->rows > $this->maxrowsperpage)  {
                $maxrows = $this->maxrowsperpage + $this->next;
                if ($maxrows > $this->rows) $maxrows = $this->maxrowsperpage;
            } else {
                $maxrows=$this->rows;
            }

            $i=0;

			if ($this->rows) {
                while ($i < $maxrows)  {
    
                    if (!$result->peers[$i]) break;
    
                    $peer = $result->peers[$i];
    
                    $index=$this->next+$i+1;

                    $rr=floor($index/2);
                    $mod=$index-$rr*2;
            
                    if ($mod ==0) {
                    	$bgcolor="lightgrey";
                    } else {
                        $bgcolor="white";
                    }

                    $_url = $this->url.sprintf("&service=%s&action=Delete&ip_filter=%s",
                    urlencode($this->SOAPEngine->service),
                    urlencode($peer->ip)
                    );

                    if ($_REQUEST['action'] == 'Delete' &&
                    	$_REQUEST['ip_filter'] == $peer->ip) {
                		$_url .= "&confirm=1";
                        $actionText = "<font color=red>Confirm</font>";
                    } else {
                        $actionText = "Delete";
                    }

               		if ($this->version > 1) {

                    printf("
                    <tr bgcolor=%s>
                    <td>%s</td>
                    <td>%s.%s</td>
                    <td>%s</td>
                    <td>%s</td>
                    <td>%s</td>
                    <td>%s</td>
                    <td>%s</td>
                    <td><a href=%s>%s</a></td>
                    </tr>",
                    $bgcolor,
                    $index,
                    $peer->reseller,
                    $peer->customer,
                    $peer->ip,
                    $peer->protocol,
                    $peer->fromPattern,
                    $peer->description,
                    $peer->owner,
                    $_url,
                    $actionText
                    );
                    } else {
                    printf("
                    <tr bgcolor=%s>
                    <td>%s</td>
                    <td>%s</td>
                    <td>%s</td>
                    <td>%s</td>
                    <td>%s</td>
                    <td>%s</td>
                    <td><a href=%s>%s</a></td>
                    </tr>",
                    $bgcolor,
                    $index,
                    $peer->ip,
                    $peer->protocol,
                    $peer->fromPattern,
                    $peer->description,
                    $peer->owner,
                    $_url,
                    $actionText
                    );

                    }
                    printf("
                    </tr>
                    ");

                    $i++;
    
                }
    
			}

            print "</table>";

            $this->showPagination($maxrows);

            return true;
        }
    }

    function showAddForm() {
		if ($this->selectionActive) return;
        print "
        <p>
        <table border=0 class=border width=100%>
        <tr>
            ";
            printf ("<form method=post name=addform action=%s>",$_SERVER['PHP_SELF']);
            print "
        	<td align=left>
            ";

            print "
            <input type=submit name=action value=Add>
            ";
            printf (" IP address<input type=text size=20 name=ipaddress>");
            printf (" Description<input type=text size=30 name=description>");
            print "Customer";
            if ($this->adminonly) {
            	$this->showResellerForm('reseller');
                print ".";
            	$this->showCustomerForm('customer');
            } else {
            	$this->showCustomerForm('customer');
            }
            printf (" Owner<input type=text size=5 name=owner>");

            print "
	        </td>
        	<td align=right>
            ";
            print "
	        </td>
            ";

            $this->printHiddenFormElements();

            print "
            </form>
        </tr>
        </table>
        ";
    }

    function addRecord() {
    	$ipaddress   = trim($_REQUEST['ipaddress']);
        $description = trim($_REQUEST['description']);
        $owner       = trim($_REQUEST['owner']);

        if ($this->adminonly) {
        	$reseller = trim($_REQUEST['reseller']);
        	$customer = trim($_REQUEST['customer']);
            if (!$customer) $customer=$reseller;
        } else {
        	$reseller = $this->reseller;
        	$customer = trim($_REQUEST['customer']);
            if (!$customer || !in_array($customer,array_keys($this->customers))) {
                $customer=$reseller;
            }
        }

		if (!strlen($ipaddress) || !strlen($description)) {
            printf ("<p><font color=red>Error: Missing IP or description. </font>");
            return false;
        }

        $peer=array(
                     'ip'          => $ipaddress,
                     'description' => $description,
                     'owner'       => intval($_REQUEST['owner']),
                     'customer'    => intval($customer),
                     'reseller'    => intval($reseller)
        			);

        $function=array('commit'   => array('name'       => 'addTrustedPeer',
                                            'parameters' => array($peer),
                                            'logs'       => array('success' => sprintf('<p>Trusted peers %s has been added',$ipaddress))),
                        'rollback' => array('name'       => 'deleteTrustedPeer',
                                            'parameters' => array($peer)
                                            )
                        );
     
        return $this->SOAPEngine->execute($function);
    }

    function deleteRecord() {
        if (!$_REQUEST['confirm']) {
        	print "<p><font color=red>Please press on Confirm to confirm the delete. </font>";
            return true;
        }

        if (!strlen($this->filters['ip'])) {
            print "<p><font color=red>Error: missing IP address. </font>";
            return false;
        }

        $function=array('commit'   => array('name'       => 'deleteTrustedPeer',
                                            'parameters' => array($this->filters['ip']),
                                            'logs'       => array('success' => sprintf('<p>Trusted peers %s has been deleted',$this->filters['ip'])))
                        );
     
        return $this->SOAPEngine->execute($function);
    }
}

class GatewayGroups extends Records {

    var $sortElements=array(
                            'name'   => 'Name'
                            );

    function GatewayGroups(&$SOAPEngine) {
    	$this->filters   = array('group'   => trim($_REQUEST['group_filter'])
                                 );

		$this->Records(&$SOAPEngine);
    }

    function listRecords() {

		$this->showSeachForm();

        // Insert credetials
        $this->SOAPEngine->soapclient->addHeader($this->SOAPEngine->SoapAuth);

        // Filter
        $filter=array('name'  => $this->filters['group']
                      );

        // Range
        $range=array('start' => intval($this->next),
                     'count' => intval($this->maxrowsperpage)
                     );

        // Order
        if (!$this->sorting['sortBy'])    $this->sorting['sortBy']    = 'name';
        if (!$this->sorting['sortOrder']) $this->sorting['sortOrder'] = 'ASC';

        $orderBy = array('attribute' => $this->sorting['sortBy'],
                         'direction' => $this->sorting['sortOrder']
                         );

        // Compose query
        $Query=array('filter'  => $filter,
                        'orderBy' => $orderBy,
                        'range'   => $range
                        );

        // Call function
        $result     = $this->SOAPEngine->soapclient->getGatewayGroups($Query);

        if (PEAR::isError($result)) {
            $error_msg  = $result->getMessage();
            $error_fault= $result->getFault();
            $error_code = $result->getCode();
            printf ("<p><font color=red>Error from %s: %s (%s): %s</font>",$this->SOAPEngine->SOAPurl,$error_msg, $error_fault->detail->exception->errorcode,$error_fault->detail->exception->errorstring);
            return false;
        } else {

			$this->rows = $result->total;

            print "
            <table border=0 align=center>
            <tr><td>$this->rows records found</td></tr>
            </table>
            <p>
            <table border=0 cellpadding=2 width=100%>
            <tr bgcolor=lightgrey>
                <td><b>Id</b></th>
                <td><b>Name</b></th>
                <td><b>Action</b></td>
            </tr>
            ";

            if (!$this->next)  $this->next=0;

            if ($this->rows > $this->maxrowsperpage)  {
                $maxrows = $this->maxrowsperpage + $this->next;
                if ($maxrows > $this->rows) $maxrows = $this->maxrowsperpage;
            } else {
                $maxrows=$this->rows;
            }

            $i=0;

			if ($this->rows) {
                while ($i < $maxrows)  {
    
                    if (!$result->groups[$i]) break;
    
                    $group = $result->groups[$i];
    
                    $index=$this->next+$i+1;

                    $rr=floor($index/2);
                    $mod=$index-$rr*2;
            
                    if ($mod ==0) {
                    	$bgcolor="lightgrey";
                    } else {
                        $bgcolor="white";
                    }

                    $_url = $this->url.sprintf("&service=%s&action=Delete&group_filter=%s",
                    urlencode($this->SOAPEngine->service),
                    urlencode($group)
                    );

                    if ($_REQUEST['action'] == 'Delete' &&
                    	$_REQUEST['group_filter'] == $group) {
                		$_url .= "&confirm=1";
                        $actionText = "<font color=red>Confirm</font>";
                    } else {
                        $actionText = "Delete";
                    }

                    printf("
                    <tr bgcolor=%s>
                    <td>%s</td>
                    <td>%s</td>
                    <td><a href=%s>%s</a></td>
                    </tr>",
                    $bgcolor,
                    $index,
                    $group,
                    $_url,
                    $actionText
                    );

                    printf("
                    </tr>
                    ");

                    $i++;
    
                }
    
			}

            print "</table>";

            $this->showPagination($maxrows);

            return true;
        }
    }

    function showAddForm() {
		if ($this->selectionActive) return;
        print "
        <p>
        <table border=0 class=border width=100%>
        <tr>
            ";
            printf ("<form method=post name=addform action=%s>",$_SERVER['PHP_SELF']);
            print "
        	<td align=left>
            ";

            print "
            <input type=submit name=action value=Add>
            ";

            printf (" Name<input type=text size=20 name=name>");

            $this->SOAPEngine->soapclient->addHeader($this->SOAPEngine->SoapAuth);
            $result     = $this->SOAPEngine->soapclient->getGatewayGroups();

            print "
	        </td>
        	<td align=right>
            ";
            print "
	        </td>
            ";
            $this->printHiddenFormElements();

            print "
            </form>
        </tr>
        </table>
        ";
    }

    function addRecord() {
    	$name     = trim($_REQUEST['name']);

		if (!strlen($name)) {
            printf ("<p><font color=red>Error: Missing name. </font>");
            return false;
        }

        $function=array('commit'   => array('name'       => 'addGatewayGroup',
                                            'parameters' => array($name),
                                            'logs'       => array('success' => sprintf('<p>Gateway group %s has been added',$name))),
                        'rollback' => array('name'       => 'deleteGatewayGroup',
                                            'parameters' => array($name)
                                            )
                        );
     
        return $this->SOAPEngine->execute($function);
    }

    function deleteRecord() {
        if (!$_REQUEST['confirm']) {
        	print "<p><font color=red>Please press on Confirm to confirm the delete. </font>";
            return true;
        }

        if (!strlen($this->filters['group'])) {
            print "<p><font color=red>Error: missing gateway group. </font>";
            return false;
        }

        $function=array('commit'   => array('name'       => 'deleteGatewayGroup',
                                            'parameters' => array($this->filters['group']),
                                            'logs'       => array('success' => sprintf('<p>Gateway group %s has been deleted',$this->filters['group']))),
                        'rollback' => array('name'       => 'addGatewayGroup',
                                            'parameters' => array($this->filters['group'])
                                            )
                        );
     
        return $this->SOAPEngine->execute($function);
    }

    function showSeachFormCustom() {
        printf (" Group<input type=text size=15 name=group_filter value='%s'>",$this->filters['group']);
    }

}

class Gateways extends Records {

    var $sortElements=array(
                            'name'   => 'Name',
                            'group'  => 'Group',
                            'ip'     => 'IP address',
                            'prefix' => 'Prefix'
                            );

    function Gateways(&$SOAPEngine) {
    	$this->filters   = array('name'   => trim($_REQUEST['name_filter']),
                                 'group'  => trim($_REQUEST['group_filter'])
                                 );

		$this->Records(&$SOAPEngine);
    }

    function listRecords() {

		$this->showSeachForm();

        // Insert credetials
        $this->SOAPEngine->soapclient->addHeader($this->SOAPEngine->SoapAuth);

        // Filter
        $filter=array('name'  => $this->filters['name'],
                      'group' => $this->filters['group']
                      );

        // Range
        $range=array('start' => intval($this->next),
                     'count' => intval($this->maxrowsperpage)
                     );

        // Order
        if (!$this->sorting['sortBy'])    $this->sorting['sortBy']    = 'name';
        if (!$this->sorting['sortOrder']) $this->sorting['sortOrder'] = 'ASC';

        $orderBy = array('attribute' => $this->sorting['sortBy'],
                         'direction' => $this->sorting['sortOrder']
                         );

        // Compose query
        $Query=array('filter'  => $filter,
                        'orderBy' => $orderBy,
                        'range'   => $range
                        );

        // Call function
        $result     = $this->SOAPEngine->soapclient->getGateways($Query);

        if (PEAR::isError($result)) {
            $error_msg  = $result->getMessage();
            $error_fault= $result->getFault();
            $error_code = $result->getCode();
            printf ("<p><font color=red>Error from %s: %s (%s): %s</font>",$this->SOAPEngine->SOAPurl,$error_msg, $error_fault->detail->exception->errorcode,$error_fault->detail->exception->errorstring);
            return false;
        } else {

			$this->rows = $result->total;

            print "
            <table border=0 align=center>
            <tr><td>$this->rows records found</td></tr>
            </table>
            <p>
            <table border=0 cellpadding=2 width=100%>
            <tr bgcolor=lightgrey>
                <td><b>Id</b></th>
                <td><b>Name</b></th>
                <td><b>Group</b></td>
                <td><b>Address</b></td>
                <td><b>Strip</b></td>
                <td><b>Prefix</b></td>
                <td><b>Action</b></td>
            </tr>
            ";

            if (!$this->next)  $this->next=0;

            if ($this->rows > $this->maxrowsperpage)  {
                $maxrows = $this->maxrowsperpage + $this->next;
                if ($maxrows > $this->rows) $maxrows = $this->maxrowsperpage;
            } else {
                $maxrows=$this->rows;
            }

            $i=0;

			if ($this->rows) {
                while ($i < $maxrows)  {
    
                    if (!$result->gateways[$i]) break;
    
                    $gateway = $result->gateways[$i];
    
                    $index=$this->next+$i+1;

                    $rr=floor($index/2);
                    $mod=$index-$rr*2;
            
                    if ($mod ==0) {
                    	$bgcolor="lightgrey";
                    } else {
                        $bgcolor="white";
                    }

                    $_url = $this->url.sprintf("&service=%s&action=Delete&name_filter=%s",
                    urlencode($this->SOAPEngine->service),
                    urlencode($gateway->name)
                    );

                    if ($_REQUEST['action'] == 'Delete' &&
                    	$_REQUEST['name_filter'] == $gateway->name) {
                		$_url .= "&confirm=1";
                        $actionText = "<font color=red>Confirm</font>";
                    } else {
                        $actionText = "Delete";
                    }

                    printf("
                    <tr bgcolor=%s>
                    <td>%s</td>
                    <td>%s</td>
                    <td>%s</td>
                    <td>%s:%s:%s</td>
                    <td>%s</td>
                    <td>%s</td>
                    <td><a href=%s>%s</a></td>
                    </tr>",
                    $bgcolor,
                    $index,
                    $gateway->name,
                    $gateway->group,
                    $gateway->transport,
                    $gateway->ip,
                    $gateway->port,
                    $gateway->strip,
                    $gateway->prefix,
                    $_url,
                    $actionText
                    );

                    printf("
                    </tr>
                    ");

                    $i++;
    
                }
    
			}

            print "</table>";

            $this->showPagination($maxrows);

            return true;
        }
    }

    function showAddForm() {
		if ($this->selectionActive) return;
        print "
        <p>
        <table border=0 class=border width=100%>
        <tr>
            ";
            printf ("<form method=post name=addform action=%s>",$_SERVER['PHP_SELF']);
            print "
        	<td align=left>
            ";

            print "
            <input type=submit name=action value=Add>
            ";

            printf (" Name<input type=text size=20 name=name>");

            $this->SOAPEngine->soapclient->addHeader($this->SOAPEngine->SoapAuth);
            $result     = $this->SOAPEngine->soapclient->getGatewayGroups();

            printf (" Group: ");

            // Compose query
            $Query=array('filter'  => array('name'=>''),
                         'orderBy' => array('attribute' => 'name',
                                            'direction' => 'ASC'
                                      ),
                         'range'   => array('start' => 0,
			                                'count' => 1000)
                         );

            $this->SOAPEngine->soapclient->addHeader($this->SOAPEngine->SoapAuth);
            $result     = $this->SOAPEngine->soapclient->getGatewayGroups($Query);

            if (PEAR::isError($result)) {
                $error_msg  = $result->getMessage();
                $error_fault= $result->getFault();
                $error_code = $result->getCode();
                printf ("<p><font color=red>Error from %s: %s (%s): %s</font>",$this->SOAPEngine->SOAPurl,$error_msg, $error_fault->detail->exception->errorcode,$error_fault->detail->exception->errorstring);
                return false;
            } else {
            	print "<select name=group> ";
                foreach ($result->groups as $_grp) {
                	printf ("<option value='%s'>%s",$_grp,$_grp);
                }
            	printf (" </select>");
            }
            printf (" Address<input type=text size=25 name=address>");
            printf (" Strip: <select name=strip>");
            $t=0;
            while ($t<10) {
                print "<option value=$t>$t";
                $t++;
            }

            print "</select>";
            printf (" Prefix<input type=text size=5 name=prefix>");

            print "
	        </td>
        	<td align=right>
            ";
            print "
	        </td>
            ";
            $this->printHiddenFormElements();

            print "
            </form>
        </tr>
        </table>
        ";
    }

    function addRecord() {
    	$name     = trim($_REQUEST['name']);
        $group    = trim($_REQUEST['group']);
        $address  = trim($_REQUEST['address']);
        $strip    = trim($_REQUEST['strip']);
        $prefix   = trim($_REQUEST['prefix']);

		if (!strlen($name) || !strlen($group) || !strlen($address)) {
            printf ("<p><font color=red>Error: Missing name, group or address. </font>");
            return false;
        }

        $address_els=explode(':',$address);

        if (count($address_els) == 1) {
            $ip=$address_els[0];
            $transport='udp';
            $port='5060';
        } else if (count($address_els) == 2) {
            $ip=$address_els[0];
            $port=$address_els[1];
            $transport='udp';
        } else if (count($address_els) == 3) {
            $ip=$address_els[1];
            $port=intval($address_els[2]);
            if ($address_els[0] == 'tcp' || $address_els[0] == 'tls' || $address_els[0] == 'udp') {
            	$transport=$address_els[0];
            } else {
            	$transport='udp';
            }
        }

        $gateway=array(
                     'name'      => $name,
                     'group'     => $group,
                     'ip'        => $ip,
                     'port'      => intval($port),
                     'uriScheme' => 'sip',
                     'transport' => $transport,
                     'strip'     => intval($_REQUEST['strip']),
                     'prefix'    => $_REQUEST['prefix']
        			);

        $function=array('commit'   => array('name'       => 'addGateway',
                                            'parameters' => array($gateway),
                                            'logs'       => array('success' => sprintf('<p>Gateway grup %s has been added',$address))),
                        'rollback' => array('name'       => 'deleteGateway',
                                            'parameters' => array($name)
                                            )
                        );
     
        return $this->SOAPEngine->execute($function);
    }

    function deleteRecord() {
        if (!$_REQUEST['confirm']) {
        	print "<p><font color=red>Please press on Confirm to confirm the delete. </font>";
            return true;
        }

        if (!strlen($this->filters['name'])) {
            print "<p><font color=red>Error: missing gateway name. </font>";
            return false;
        }

        $function=array('commit'   => array('name'       => 'deleteGateway',
                                            'parameters' => array($this->filters['name']),
                                            'logs'       => array('success' => sprintf('<p>Gateway grup %s has been deleted',$this->filters['name'])))
                        );
        return $this->SOAPEngine->execute($function);

    }

    function showSeachFormCustom() {
        printf (" Name<input type=text size=15 name=name_filter value='%s'>",$this->filters['name']);
        printf (" Group<input type=text size=15 name=group_filter value='%s'>",$this->filters['group']);
    }

}

class Routes extends Records {
    var $gatewayGroups=array();

    var $sortElements=array(
                            'prefix'       => 'Prefix',
                            'fromURI'      => 'From URI',
                            'priority'     => 'Priority'
                            );

    function Routes(&$SOAPEngine) {
    	$this->filters   = array('prefix'       => trim($_REQUEST['prefix_filter']),
                                 'gatewayGroup' => trim($_REQUEST['gatewayGroup_filter']),
                                 'fromURI'      => trim($_REQUEST['fromURI_filter'])
                                 );

		$this->Records(&$SOAPEngine);
    }

    function listRecords() {

        // Get gateway groups
        $Query=array('filter'  => array('name'=>''),
                     'orderBy' => array('attribute' => 'name',
                                        'direction' => 'ASC'
                                  ),
                     'range'   => array('start' => 0,
                                        'count' => 1000)
                     );

        $this->SOAPEngine->soapclient->addHeader($this->SOAPEngine->SoapAuth);
        $result     = $this->SOAPEngine->soapclient->getGatewayGroups($Query);

        if (PEAR::isError($result)) {
            $error_msg  = $result->getMessage();
            $error_fault= $result->getFault();
            $error_code = $result->getCode();
            printf ("<p><font color=red>Error from %s: %s (%s): %s</font>",$this->SOAPEngine->SOAPurl,$error_msg, $error_fault->detail->exception->errorcode,$error_fault->detail->exception->errorstring);
            return false;
        } else {
            $this->gatewayGroups=$result->groups;
        }


		$this->showSeachForm();

        // Insert credetials
        $this->SOAPEngine->soapclient->addHeader($this->SOAPEngine->SoapAuth);

        // Filter
        $filter=array('prefix'       => $this->filters['prefix'],
                      'gatewayGroup' => $this->filters['gatewayGroup'],
                      'fromURI'      => $this->filters['fromURI']
                      );

        // Range
        $range=array('start' => intval($this->next),
                     'count' => intval($this->maxrowsperpage)
                     );

        // Order
        if (!$this->sorting['sortBy'])    $this->sorting['sortBy']    = 'prefix';
        if (!$this->sorting['sortOrder']) $this->sorting['sortOrder'] = 'ASC';

        $orderBy = array('attribute' => $this->sorting['sortBy'],
                         'direction' => $this->sorting['sortOrder']
                         );

        // Compose query
        $Query=array('filter'  => $filter,
                        'orderBy' => $orderBy,
                        'range'   => $range
                        );

        // Call function
        $result     = $this->SOAPEngine->soapclient->getRoutes($Query);

        if (PEAR::isError($result)) {
            $error_msg  = $result->getMessage();
            $error_fault= $result->getFault();
            $error_code = $result->getCode();
            printf ("<p><font color=red>Error from %s: %s (%s): %s</font>",$this->SOAPEngine->SOAPurl,$error_msg, $error_fault->detail->exception->errorcode,$error_fault->detail->exception->errorstring);
            return false;
        } else {

			$this->rows = $result->total;

            print "
            <table border=0 align=center>
            <tr><td>$this->rows records found</td></tr>
            </table>
            <p>
            <table border=0 cellpadding=2 width=100%>
            <tr bgcolor=lightgrey>
                <td><b>Id</b></th>
                <td><b>Prefix</b></th>
                <td><b>Gateway Group</b></td>
                <td><b>From URI</b></td>
                <td><b>Priority</b></td>
                <td><b>Action</b></td>
            </tr>
            ";

            if (!$this->next)  $this->next=0;

            if ($this->rows > $this->maxrowsperpage)  {
                $maxrows = $this->maxrowsperpage + $this->next;
                if ($maxrows > $this->rows) $maxrows = $this->maxrowsperpage;
            } else {
                $maxrows=$this->rows;
            }

            $i=0;

			if ($this->rows) {
                while ($i < $maxrows)  {
    
                    if (!$result->routes[$i]) break;
    
                    $route = $result->routes[$i];
    
                    $index=$this->next+$i+1;

                    $rr=floor($index/2);
                    $mod=$index-$rr*2;
            
                    if ($mod ==0) {
                    	$bgcolor="lightgrey";
                    } else {
                        $bgcolor="white";
                    }

                    $_url = $this->url.sprintf("&service=%s&action=Delete&prefix_filter=%s&gatewayGroup_filter=%s&fromURI_filter=%s&priority_filter=%s",
                    urlencode($this->SOAPEngine->service),
                    urlencode($route->prefix),
                    urlencode($route->gatewayGroup),
                    urlencode($route->fromURI),
                    urlencode($route->priority)
                    );

                    if ($_REQUEST['action'] == 'Delete' &&
                    	$_REQUEST['prefix_filter'] == $route->prefix &&
                        $_REQUEST['gatewayGroup_filter'] == $route->gatewayGroup &&
                        $_REQUEST['fromURI_filter'] == $route->fromURI &&
                        $_REQUEST['priority_filter'] == $route->priority) {

                		$_url .= "&confirm=1";
                        $actionText = "<font color=red>Confirm</font>";
                    } else {
                        $actionText = "Delete";
                    }

                    printf("
                    <tr bgcolor=%s>
                    <td>%s</td>
                    <td>%s</td>
                    <td>%s</td>
                    <td>%s</td>
                    <td>%s</td>
                    <td><a href=%s>%s</a></td>
                    </tr>",
                    $bgcolor,
                    $index,
                    $route->prefix,
                    $route->gatewayGroup,
                    $route->fromURI,
                    $route->priority,
                    $_url,
                    $actionText
                    );

                    printf("
                    </tr>
                    ");

                    $i++;
    
                }
    
			}

            print "</table>";

            $this->showPagination($maxrows);

            return true;
        }
    }

    function showAddForm() {
		if ($this->selectionActive) return;
        print "
        <p>
        <table border=0 class=border width=100%>
        <tr>
            ";
            printf ("<form method=post name=addform action=%s>",$_SERVER['PHP_SELF']);
            print "
        	<td align=left>
            ";

            print "
            <input type=submit name=action value=Add>
            ";

            printf (" Prefix<input type=text size=20 name=prefix>");

            printf (" Group: ");

            print "<select name=gatewayGroup> ";
            foreach ($this->gatewayGroups as $_grp) {
                printf ("<option value='%s'>%s",$_grp,$_grp);
            }
            printf (" </select>");
            printf (" From<input type=text size=25 name=fromURI>");
            printf (" Priority<input type=text size=5 name=priority>");

            print "
	        </td>
        	<td align=right>
            ";
            print "
	        </td>
            ";

            $this->printHiddenFormElements();

            print "
            </form>
        </tr>
        </table>
        ";
    }

    function addRecord() {

    	$prefix       = trim($_REQUEST['prefix']);
        $gatewayGroup = trim($_REQUEST['gatewayGroup']);
        $fromURI         = trim($_REQUEST['fromURI']);
        $priority     = trim($_REQUEST['priority']);

		if (!strlen($prefix) || !strlen($gatewayGroup)) {
            printf ("<p><font color=red>Error: Missing prefix or gatewayGroup. </font>");
            return false;
        }

        $route=array(
                     'prefix'       => $prefix,
                     'gatewayGroup' => $gatewayGroup,
                     'fromURI'      => $fromURI,
                     'priority'     => intval($priority)
        			);

		$routes=array($route);

        $function=array('commit'   => array('name'       => 'addRoutes',
                                            'parameters' => array($routes),
                                            'logs'       => array('success' => sprintf('<p>Route %s has been added',$prefix))),
                        'rollback' => array('name'       => 'deleteRoutes',
                                            'parameters' => array($routes)
                                            )
                        );
     
        return $this->SOAPEngine->execute($function);

    }

    function deleteRecord() {
        if (!$_REQUEST['confirm']) {
        	print "<p><font color=red>Please press on Confirm to confirm the delete. </font>";
            return true;
        }

        if (!strlen($this->filters['prefix']) || !strlen($this->filters['gatewayGroup'])) {
            print "<p><font color=red>Error: missing route prefix or gatewayGroup. </font>";
            return false;
        }

        $route=array(
                     'prefix'       => $this->filters['prefix'],
                     'gatewayGroup' => $this->filters['gatewayGroup'],
                     'fromURI'      => $this->filters['fromURI'],
                     'priority'     => intval($this->filters['priority'])
        			);

        $routes=array($route);

        $function=array('commit'   => array('name'       => 'deleteRoutes',
                                            'parameters' => array($routes),
                                            'logs'       => array('success' => sprintf('<p>Route %s has been added',$prefix)))
                        );
     
        return $this->SOAPEngine->execute($function);
    }

    function showSeachFormCustom() {
        printf (" Prefix<input type=text size=15 name=prefix_filter value='%s'>",$this->filters['prefix']);
        print "<select name=gatewayGroup_filter>
        	<option>";
		$selected_gatewayGroups[$this->filters['gatewayGroup']]='selected';
        foreach ($this->gatewayGroups as $_grp) {
            printf ("<option value='%s' %s>%s",$_grp,$selected_gatewayGroups[$_grp],$_grp);
        }
        printf (" </select>");

        printf (" From URI<input type=text size=15 name=fromURI_filter value='%s'>",$this->filters['fromURI']);
    }

}

class DomainStatistics extends Records {

    var $maxrowsperpage= 200;

    function DomainStatistics(&$SOAPEngine) {
        $this->filters   = array('domain'       => trim($_REQUEST['domain_filter']));

		$this->Records(&$SOAPEngine);
    }

    function listRecords() {

		$this->showSeachForm();

        // Insert credetials
        $this->SOAPEngine->soapclient->addHeader($this->SOAPEngine->SoapAuth);

		$filter=$this->filters['domain'];

        // Call function
        $result     = $this->SOAPEngine->soapclient->getDomainStatistics($filter);

        if (PEAR::isError($result)) {
            $error_msg  = $result->getMessage();
            $error_fault= $result->getFault();
            $error_code = $result->getCode();
            printf ("<p><font color=red>Error from %s: %s (%s): %s</font>",$this->SOAPEngine->SOAPurl,$error_msg, $error_fault->detail->exception->errorcode,$error_fault->detail->exception->errorstring);
            return false;

        } else {

			$this->rows = count($result);

            //print_r($result);

            print "
            <table border=0 align=center>
            <tr><td>$this->rows records found</td></tr>
            </table>
            <p>
            <table border=0 cellpadding=2 width=100%>
            <tr bgcolor=lightgrey>
                <td><b>Id</b></th>
                <td><b>SIP domain</b></td>
                <td><b>SIP subscribers</b></td>
                <td><b>Online subscribers</b></td>
                <td><b>Online SIP devices</b></td>
            </tr>
            ";

            if (!$this->next)  $this->next=0;

            if ($this->rows > $this->maxrowsperpage)  {
                $maxrows = $this->maxrowsperpage + $this->next;
                if ($maxrows > $this->rows) $maxrows = $this->maxrowsperpage;
            } else {
                $maxrows=$this->rows;
            }

            $i=0;

			if ($this->rows) {
                while ($i < $maxrows)  {
    
                    $domain = $result[$i];
                    if (!strlen($domain->users)) break;

                    $index = $this->next+$i+1;
    
                    $rr=floor($index/2);
                    $mod=$index-$rr*2;
            
                    if ($mod ==0) {
                    	$bgcolor="lightgrey";
                    } else {
                        $bgcolor="white";
                    }

        			$_url = $this->url.sprintf("&service=%s&action=Delete&domain_filter=%s",
                    urlencode($this->SOAPEngine->service),
                    urlencode($domain->domain)
                    );

                    if ($_REQUEST['action'] == 'Delete' &&
                        $_REQUEST['domain_filter'] == $domain->domain) {
                		$_url .= "&confirm=1";
                        $actionText = "<font color=red>Confirm</font>";
                    } else {
                        $actionText = "Delete";
                    }

                    printf("
                    <tr bgcolor=%s>
                    <td>%s</td>
                    <td>%s</td>
                    <td>%s</td>
                    <td>%s</td>
                    <td>%s</td>
                    </tr>",
                    $bgcolor,
                    $index,
                    $domain->domain,
                    $domain->users,
                    $domain->onlineUsers,
                    $domain->onlineDevices
                    );

                    $i++;
                }
			}

            print "</table>";

            $this->showPagination($maxrows);

            return true;
        }
    }

    function showSeachFormCustom() {
        printf (" Domain<input type=text size=15 name=domain_filter value='%s'>",$this->filters['domain']);
    }

}

class Customers extends Records {

    var $maxrowsperpage= 20;
    var $sortElements=array(
							'changeDate'   => 'Change date',
                            'username'     => 'Username',
                            'firstName'    => 'First name',
                            'lastName'     => 'Last name',
                            'organization' => 'Organization',
                            'customer'     => 'Customer'
                            );

    var $propertiesItems = array('sip_credit'          => array('name'     => 'Credit for SIP account creation',
                                                               'category' => 'admin'),
                                 'sipa_credit'         => array('name'     => 'Credit for SIP alias creation',
                                                               'category' => 'admin'),
                                 'enum_range_credit'   => array('name'     => 'Credit for ENUM range creation',
                                                               'category' => 'admin'),
                                 'enum_number_credit'  => array('name'     => 'Credit for ENUM numbers creation',
                                                               'category' => 'admin'),
                                 'pstn_access'         => array('name'     => 'Access to PSTN',
                                                               'category' => 'admin',
                                                               'type'     => 'boolean'),
                                 'pstn_gateways'       => array('name'     => 'PSTN gateways',
                                                               'category' => 'admin'),
                                 'voicemail_server'    => array('name'     => 'Voicemail server address',
                                                               'category' => 'sip'),
                                 'sip_proxy_server'    => array('name'     => 'SIP Proxy server address',
                                                               'category' => 'sip'),
                                 'support_web'         => array('name'     => 'Support web site',
                                                               'category' => 'sip'),
                                 'support_email'       => array('name'     => 'Support email address',
                                                               'category' => 'sip'),
                                 'support_organization'=> array('name'     => 'Support organization',
                                                               'category' => 'sip'),
                                 'cdrtool_address'     => array('name'     => 'CDRTool address',
                                                               'category' => 'sip'),
                                 'sip_settings_page'   => array('name'     => 'SIP settings page',
                                                               'category' => 'sip'),
                                 'default_sip_domain'  => array('name'     => 'Default SIP domain',
                                                               'category' => 'sip'),
                                 'default_enum_range'  => array('name'     => 'Default ENUM range',
                                                               'category' => 'enum'),
                                 'default_enum_tld'    => array('name'     => 'Default ENUM Top Level Domain',
                                                               'category' => 'enum'),
                                 'records_per_page'    => array('name'     => 'Records per page',
                                                               'category' => 'web')
                                 );

    var $FieldsReadOnly=array(
                              'id'          => array('type'=>'integer'),
                              'reseller'    => array('type'=>'integer')
                              );
    var $Fields=array(
                              'aliasOf'     => array('type'       =>'integer',
                                                     'name'       =>'Impersonate'),
                              'companyCode' => array('type'       =>'text',
                                                     'name'       =>'Company code',
                                                     'adminonly'  => true
                                                     ),
                              'balance'     => array('type'       => 'float',
                                                     'adminonly'  => true
                                                     ),
                              'credit'      => array('type'       => 'float',
                                                     'adminonly'  => true
                                                     ),
                           'resellerActive' => array ('type'      => 'boolean',
                                                      'name'      => 'Reseller active',
                                                      'adminonly' => true
                                                     ),
                              'username'    => array('type'       =>'text',
                                                     'adminonly'  => true
                                                     ),
                              'password'    => array('type'=>'text',
                                                     'name'=>'Password'),
                              'firstName'   => array('type'=>'text',
                                                     'name'=>'First name'),
                              'lastName'    => array('type'=>'text',
                                                     'name'=>'Last name'),
                              'organization'=> array('type'=>'text'),
                              'tel'         => array('type'=>'text'),
                              'fax'         => array('type'=>'text'),
                              'sip'         => array('type'=>'text'),
                              'enum'        => array('type'=>'text'),
                              'mobile'      => array('type'=>'text'),
                              'email'       => array('type'=>'text'),
                              'web'         => array('type'=>'text'),
                              'address'     => array('type'=>'textarea'),
                              'postcode'    => array('type'=>'text'),
                              'city'        => array('type'=>'text'),
                              'state'       => array('type'=>'text'),
                              'country'     => array('type'=>'text'),
                              'timezone'    => array('type'=>'text'),
                              'language'    => array('type'=>'text'),
                              'vatNumber'   => array('type'=>'text',
                                                     'name'=>'VAT number'),
                              'bankAccount' => array('type'=>'text',
                                                     'name'=>'Bank account'
                                                     ),
                           'billingAddress' => array('type'=>'textarea',
                                                     'name'=>'Billing address'
                                                     )
                              );

        var $states=array(
        array("label"=>"", "value"=>"N/A"),
        array("label"=>"-- CANADA --", "value"=>"-"),
        array("label"=>"Alberta", "value"=>"AB"),
        array("label"=>"British Columbia", "value"=>"BC"),
        array("label"=>"Manitoba", "value"=>"MB"),
        array("label"=>"New Brunswick", "value"=>"NB"),
        array("label"=>"Newfoundland/Labrador", "value"=>"NL"),
        array("label"=>"Northwest Territory", "value"=>"NT"),
        array("label"=>"Nova Scotia", "value"=>"NS"),
        array("label"=>"Nunavut", "value"=>"NU"),
        array("label"=>"Ontario", "value"=>"ON"),
        array("label"=>"Prince Edward Island", "value"=>"PE"),
        array("label"=>"Quebec", "value"=>"QC"),
        array("label"=>"Saskatchewan", "value"=>"SN"),
        array("label"=>"Yukon", "value"=>"YT"),
        array("label"=>"---- US -----", "value"=>"-"),
        array("label"=>"Alabama", "value"=>"AL"),
        array("label"=>"Alaska", "value"=>"AK"),
        array("label"=>"American Samoa", "value"=>"AS"),
        array("label"=>"Arizona", "value"=>"AZ"),
        array("label"=>"Arkansas", "value"=>"AR"),
        array("label"=>"California", "value"=>"CA"),
        array("label"=>"Canal Zone", "value"=>"CZ"),
        array("label"=>"Colorado", "value"=>"CO"),
        array("label"=>"Connecticut", "value"=>"CT"),
        array("label"=>"Delaware", "value"=>"DE"),
        array("label"=>"District of Columbia", "value"=>"DC"),
        array("label"=>"Florida", "value"=>"FL"),
        array("label"=>"Georgia", "value"=>"GA"),
        array("label"=>"Guam", "value"=>"GU"),
        array("label"=>"Hawaii", "value"=>"HI"),
        array("label"=>"Idaho", "value"=>"ID"),
        array("label"=>"Illinois", "value"=>"IL"),
        array("label"=>"Indiana", "value"=>"IN"),
        array("label"=>"Iowa", "value"=>"IA"),
        array("label"=>"Kansas", "value"=>"KS"),
        array("label"=>"Kentucky", "value"=>"KY"),
        array("label"=>"Louisiana", "value"=>"LA"),
        array("label"=>"Maine", "value"=>"ME"),
        array("label"=>"Mariana Islands", "value"=>"MP"),
        array("label"=>"Maryland", "value"=>"MD"),
        array("label"=>"Massachusetts", "value"=>"MA"),
        array("label"=>"Michigan", "value"=>"MI"),
        array("label"=>"Minnesota", "value"=>"MN"),
        array("label"=>"Mississippi", "value"=>"MS"),
        array("label"=>"Missouri", "value"=>"MO"),
        array("label"=>"Montana", "value"=>"MT"),
        array("label"=>"Nebraska", "value"=>"NE"),
        array("label"=>"Nevada", "value"=>"NV"),
        array("label"=>"New Hampshire", "value"=>"NH"),
        array("label"=>"New Jersey", "value"=>"NJ"),
        array("label"=>"New Mexico", "value"=>"NM"),
        array("label"=>"New York", "value"=>"NY"),
        array("label"=>"North Carolina", "value"=>"NC"),
        array("label"=>"North Dakota", "value"=>"ND"),
        array("label"=>"Ohio", "value"=>"OH"),
        array("label"=>"Oklahoma", "value"=>"OK"),
        array("label"=>"Oregon", "value"=>"OR"),
        array("label"=>"Pennsylvania", "value"=>"PA"),
        array("label"=>"Puerto Rico", "value"=>"PR"),
        array("label"=>"Rhode Island", "value"=>"RI"),
        array("label"=>"South Carolina", "value"=>"SC"),
        array("label"=>"South Dakota", "value"=>"SD"),
        array("label"=>"Tennessee", "value"=>"TN"),
        array("label"=>"Texas", "value"=>"TX"),
        array("label"=>"Utah", "value"=>"UT"),
        array("label"=>"Vermont", "value"=>"VT"),
        array("label"=>"Virgin Islands", "value"=>"VI"),
        array("label"=>"Virginia", "value"=>"VA"),
        array("label"=>"Washington", "value"=>"WA"),
        array("label"=>"West Virginia", "value"=>"WV"),
        array("label"=>"Wisconsin", "value"=>"WI"),
        array("label"=>"Wyoming", "value"=>"WY"),
        array("label"=>"APO", "value"=>"AP"),
        array("label"=>"AEO", "value"=>"AE"),
        array("label"=>"AAO", "value"=>"AA"),
        array("label"=>"FPO", "value"=>"FP")
        );
        
        var $countries=array(
        array("label"=>"Ascension Island",	"value"=>"AC"),
        array("label"=>"Afghanistan",		"value"=>"AF"),
        array("label"=>"Albania",		"value"=>"AL"),
        array("label"=>"Algeria",		"value"=>"DZ"),
        array("label"=>"American Samoa",	"value"=>"AS"),
        array("label"=>"Andorra",		"value"=>"AD"),
        array("label"=>"Angola",		"value"=>"AO"),
        array("label"=>"Anguilla",		"value"=>"AI"),
        array("label"=>"Antarctica",		"value"=>"AQ"),
        array("label"=>"Antigua And Barbuda",	"value"=>"AG"),
        array("label"=>"Argentina",		"value"=>"AR"),
        array("label"=>"Armenia",		"value"=>"AM"),
        array("label"=>"Aruba",			"value"=>"AW"),
        array("label"=>"Australia",		"value"=>"AU"),
        array("label"=>"Austria",		"value"=>"AT"),
        array("label"=>"Azerbaijan",		"value"=>"AZ"),
        array("label"=>"Bahamas",		"value"=>"BS"),
        array("label"=>"Bahrain",		"value"=>"BH"),
        array("label"=>"Bangladesh",	        "value"=>"BD"),
        array("label"=>"Barbados",	        "value"=>"BB"),
        array("label"=>"Belarus",	        "value"=>"BY"),
        array("label"=>"Belgium",	        "value"=>"BE"),
        array("label"=>"Belize",	        "value"=>"BZ"),
        array("label"=>"Benin",		        "value"=>"BJ"),
        array("label"=>"Bermuda",	        "value"=>"BM"),
        array("label"=>"Bhutan",	        "value"=>"BT"),
        array("label"=>"Bolivia",	        "value"=>"BO"),
        array("label"=>"Bosnia And Herzegowina","value"=>"BA"),
        array("label"=>"Botswana",		"value"=>"BW"),
        array("label"=>"Bouvet Island",		"value"=>"BV"),
        array("label"=>"Brazil",		"value"=>"BR"),
        array("label"=>"British Indian Ocean Territory",	"value"=>"IO"),
        array("label"=>"Brunei Darussalam",	"value"=>"BN"),
        array("label"=>"Bulgaria",	        "value"=>"BG"),
        array("label"=>"Burkina Faso",	        "value"=>"BF"),
        array("label"=>"Burundi",	        "value"=>"BI"),
        array("label"=>"Cambodia",	        "value"=>"KH"),
        array("label"=>"Cameroon",	        "value"=>"CM"),
        array("label"=>"Canada",	        "value"=>"CA"),
        array("label"=>"Cape Verde",	        "value"=>"CV"),
        array("label"=>"Cayman Islands",        "value"=>"KY"),
        array("label"=>"Central African Republic",	"value"=>"CF"),
        array("label"=>"Chad",			"value"=>"TD"),
        array("label"=>"Chile",			"value"=>"CL"),
        array("label"=>"China",			"value"=>"CN"),
        array("label"=>"Christmas Island",	"value"=>"CX"),
        array("label"=>"Cocos (Keeling) Islands",	"value"=>"CC"),
        array("label"=>"Colombia",		"value"=>"CO"),
        array("label"=>"Comoros",		"value"=>"KM"),
        array("label"=>"Congo",			"value"=>"CG"),
        array("label"=>"Congo, Democratic People's Republic",	"value"=>"CD"),
        array("label"=>"Cook Islands", 		"value"=>"CK"),
        array("label"=>"Costa Rica",		"value"=>"CR"),
        array("label"=>"Cote d'Ivoire",		"value"=>"CI"),
        array("label"=>"Croatia (local name: Hrvatska)",	"value"=>"HR"),
        array("label"=>"Cuba",		"value"=>"CU"),
        array("label"=>"Cyprus",	"value"=>"CY"),
        array("label"=>"Czech Republic","value"=>"CZ"),
        array("label"=>"Denmark",	"value"=>"DK"),
        array("label"=>"Djibouti",	"value"=>"DJ"),
        array("label"=>"Dominica",	"value"=>"DM"),
        array("label"=>"Dominican Republic",	"value"=>"DO"),
        array("label"=>"East Timor",	"value"=>"TP"),
        array("label"=>"Ecuador",	"value"=>"EC"),
        array("label"=>"Egypt",		"value"=>"EG"),
        array("label"=>"El Salvador",	"value"=>"SV"),
        array("label"=>"Equatorial Guinea",	"value"=>"GQ"),
        array("label"=>"Eritrea",	"value"=>"ER"),
        array("label"=>"Estonia",	"value"=>"EE"),
        array("label"=>"Ethiopia",	"value"=>"ET"),
        array("label"=>"Falkland Islands (Malvinas)",	"value"=>"FK"),
        array("label"=>"Faroe Islands",	"value"=>"FO"),
        array("label"=>"Fiji",		"value"=>"FJ"),
        array("label"=>"Finland",	"value"=>"FI"),
        array("label"=>"France",	"value"=>"FR"),
        array("label"=>"French Guiana",	"value"=>"GF"),
        array("label"=>"French Polynesia",	"value"=>"PF"),
        array("label"=>"French Southern Territories",	"value"=>"TF"),
        array("label"=>"Gabon",		"value"=>"GA"),
        array("label"=>"Gambia",	"value"=>"GM"),
        array("label"=>"Georgia",	"value"=>"GE"),
        array("label"=>"Germany",	"value"=>"DE"),
        array("label"=>"Ghana",	"value"=>"GH"),
        array("label"=>"Gibraltar",	"value"=>"GI"),
        array("label"=>"Greece",	"value"=>"GR"),
        array("label"=>"Greenland",	"value"=>"GL"),
        array("label"=>"Grenada",	"value"=>"GD"),
        array("label"=>"Guadeloupe",	"value"=>"GP"),
        array("label"=>"Guam",	"value"=>"GU"),
        array("label"=>"Guatemala",	"value"=>"GT"),
        array("label"=>"Guernsey",	"value"=>"GG"),
        array("label"=>"Guinea",	"value"=>"GN"),
        array("label"=>"Guinea-Bissau",	"value"=>"GW"),
        array("label"=>"Guyana",	"value"=>"GY"),
        array("label"=>"Haiti",	"value"=>"HT"),
        array("label"=>"Heard And Mc Donald Islands",	"value"=>"HM"),
        array("label"=>"Honduras",	"value"=>"HN"),
        array("label"=>"Hong Kong",	"value"=>"HK"),
        array("label"=>"Hungary",	"value"=>"HU"),
        array("label"=>"Iceland",	"value"=>"IS"),
        array("label"=>"India",	"value"=>"IN"),
        array("label"=>"Indonesia",	"value"=>"ID"),
        array("label"=>"Iran (Islamic Republic Of)",	"value"=>"IR"),
        array("label"=>"Iraq",	"value"=>"IQ"),
        array("label"=>"Ireland",	"value"=>"IE"),
        array("label"=>"Isle of Man",	"value"=>"IM"),
        array("label"=>"Israel",	"value"=>"IL"),
        array("label"=>"Italy",	"value"=>"IT"),
        array("label"=>"Jamaica",	"value"=>"JM"),
        array("label"=>"Japan",	"value"=>"JP"),
        array("label"=>"Jersey",	"value"=>"JE"),
        array("label"=>"Jordan",	"value"=>"JO"),
        array("label"=>"Kazakhstan",	"value"=>"KZ"),
        array("label"=>"Kenya",	"value"=>"KE"),
        array("label"=>"Kiribati",	"value"=>"KI"),
        array("label"=>"Korea, Democratic People's Republic Of",	"value"=>"KP"),
        array("label"=>"Korea, Republic Of",	"value"=>"KR"),
        array("label"=>"Kuwait",	"value"=>"KW"),
        array("label"=>"Kyrgyzstan",	"value"=>"KG"),
        array("label"=>"Lao People's Democratic Republic",	"value"=>"LA"),
        array("label"=>"Latvia",	"value"=>"LV"),
        array("label"=>"Lebanon",	"value"=>"LB"),
        array("label"=>"Lesotho",	"value"=>"LS"),
        array("label"=>"Liberia",	"value"=>"LR"),
        array("label"=>"Libyan Arab Jamahiriya",	"value"=>"LY"),
        array("label"=>"Liechtenstein",	"value"=>"LI"),
        array("label"=>"Lithuania",	"value"=>"LT"),
        array("label"=>"Luxembourg",	"value"=>"LU"),
        array("label"=>"Macau",	"value"=>"MO"),
        array("label"=>"Macedonia, The Former Yugoslav",	"value"=>"MK"),
        array("label"=>"Of",	"value"=>"Republic"),
        array("label"=>"Madagascar",	"value"=>"MG"),
        array("label"=>"Malawi",	"value"=>"MW"),
        array("label"=>"Malaysia",	"value"=>"MY"),
        array("label"=>"Maldives",	"value"=>"MV"),
        array("label"=>"Mali",	"value"=>"ML"),
        array("label"=>"Malta",	"value"=>"MT"),
        array("label"=>"Marshall Islands",	"value"=>"MH"),
        array("label"=>"Martinique",	"value"=>"MQ"),
        array("label"=>"Mauritania",	"value"=>"MR"),
        array("label"=>"Mauritius",	"value"=>"MU"),
        array("label"=>"Mayotte",	"value"=>"YT"),
        array("label"=>"Mexico",	"value"=>"MX"),
        array("label"=>"Micronesia, Federated States Of",	"value"=>"FM"),
        array("label"=>"Moldova, Republic Of",	"value"=>"MD"),
        array("label"=>"Monaco",	"value"=>"MC"),
        array("label"=>"Mongolia",	"value"=>"MN"),
        array("label"=>"Montserrat",	"value"=>"MS"),
        array("label"=>"Morocco",	"value"=>"MA"),
        array("label"=>"Mozambique",	"value"=>"MZ"),
        array("label"=>"Myanmar",	"value"=>"MM"),
        array("label"=>"Namibia",	"value"=>"NA"),
        array("label"=>"Nauru",	"value"=>"NR"),
        array("label"=>"Nepal",	"value"=>"NP"),
        array("label"=>"Netherlands",	"value"=>"NL"),
        array("label"=>"Netherlands Antilles",	"value"=>"AN"),
        array("label"=>"New Caledonia",	"value"=>"NC"),
        array("label"=>"New Zealand",	"value"=>"NZ"),
        array("label"=>"Nicaragua",	"value"=>"NI"),
        array("label"=>"Niger",	"value"=>"NE"),
        array("label"=>"Nigeria",	"value"=>"NG"),
        array("label"=>"Niue",	"value"=>"NU"),
        array("label"=>"Norfolk Island",	"value"=>"NF"),
        array("label"=>"Northern Mariana Islands",	"value"=>"MP"),
        array("label"=>"Norway",	"value"=>"NO"),
        array("label"=>"Oman",	"value"=>"OM"),
        array("label"=>"Pakistan",	"value"=>"PK"),
        array("label"=>"Palau",	"value"=>"PW"),
        array("label"=>"Palestinian Territories",	"value"=>"PS"),
        array("label"=>"Panama",	"value"=>"PA"),
        array("label"=>"Papua New Guinea",	"value"=>"PG"),
        array("label"=>"Paraguay",	"value"=>"PY"),
        array("label"=>"Peru",	"value"=>"PE"),
        array("label"=>"Philippines",	"value"=>"PH"),
        array("label"=>"Pitcairn",	"value"=>"PN"),
        array("label"=>"Poland",	"value"=>"PL"),
        array("label"=>"Portugal",	"value"=>"PT"),
        array("label"=>"Puerto Rico",	"value"=>"PR"),
        array("label"=>"Qatar",	"value"=>"QA"),
        array("label"=>"Reunion",	"value"=>"RE"),
        array("label"=>"Romania",	"value"=>"RO"),
        array("label"=>"Russian Federation",	"value"=>"RU"),
        array("label"=>"Rwanda",	"value"=>"RW"),
        array("label"=>"Saint Kitts And Nevis",	"value"=>"KN"),
        array("label"=>"Saint Lucia",	"value"=>"LC"),
        array("label"=>"Saint Vincent And The Grenadines",	"value"=>"VC"),
        array("label"=>"Samoa",	"value"=>"WS"),
        array("label"=>"San Marino",	"value"=>"SM"),
        array("label"=>"Sao Tome And Principe",	"value"=>"ST"),
        array("label"=>"Saudi Arabia",	"value"=>"SA"),
        array("label"=>"Senegal",	"value"=>"SN"),
        array("label"=>"Seychelles",	"value"=>"SC"),
        array("label"=>"Sierra Leone",	"value"=>"SL"),
        array("label"=>"Singapore",	"value"=>"SG"),
        array("label"=>"Slovakia (Slovak Republic)",	"value"=>"SK"),
        array("label"=>"Slovenia",	"value"=>"SI"),
        array("label"=>"Solomon Islands",	"value"=>"SB"),
        array("label"=>"Somalia",	"value"=>"SO"),
        array("label"=>"South Africa",	"value"=>"ZA"),
        array("label"=>"South Georgia And South Sandwich",	"value"=>"GS"),
        array("label"=>"Spain",	"value"=>"ES"),
        array("label"=>"Sri Lanka",	"value"=>"LK"),
        array("label"=>"St. Helena",	"value"=>"SH"),
        array("label"=>"St. Pierre And Miquelon",	"value"=>"PM"),
        array("label"=>"Sudan",	"value"=>"SD"),
        array("label"=>"Suriname",	"value"=>"SR"),
        array("label"=>"Svalbard And Jan Mayen Islands",	"value"=>"SJ"),
        array("label"=>"Swaziland",	"value"=>"SZ"),
        array("label"=>"Sweden",	"value"=>"SE"),
        array("label"=>"Switzerland",	"value"=>"CH"),
        array("label"=>"Syrian Arab Republic",	"value"=>"SY"),
        array("label"=>"Taiwan, Province Of China",	"value"=>"TW"),
        array("label"=>"Tajikistan",	"value"=>"TJ"),
        array("label"=>"Tanzania, United Republic Of",	"value"=>"TZ"),
        array("label"=>"Thailand",	"value"=>"TH"),
        array("label"=>"Togo",	"value"=>"TG"),
        array("label"=>"Tokelau",	"value"=>"TK"),
        array("label"=>"Tonga",	"value"=>"TO"),
        array("label"=>"Trinidad And Tobago",	"value"=>"TT"),
        array("label"=>"Tunisia",	"value"=>"TN"),
        array("label"=>"Turkey",	"value"=>"TR"),
        array("label"=>"Turkmenistan",	"value"=>"TM"),
        array("label"=>"Turks And Caicos Islands",	"value"=>"TC"),
        array("label"=>"Tuvalu",	"value"=>"TV"),
        array("label"=>"Uganda",	"value"=>"UG"),
        array("label"=>"Ukraine",	"value"=>"UA"),
        array("label"=>"United Arab Emirates",	"value"=>"AE"),
        array("label"=>"United Kingdom",	"value"=>"UK"),
        array("label"=>"United States",	"value"=>"US"),
        array("label"=>"United States Minor Outlying Islands",	"value"=>"UM"),
        array("label"=>"Uruguay",	"value"=>"UY"),
        array("label"=>"Uzbekistan",	"value"=>"UZ"),
        array("label"=>"Vanuatu",	"value"=>"VU"),
        array("label"=>"Vatican City State (Holy See)",	"value"=>"VA"),
        array("label"=>"Venezuela",	"value"=>"VE"),
        array("label"=>"Viet Nam",	"value"=>"VN"),
        array("label"=>"Virgin Islands (British)",	"value"=>"VG"),
        array("label"=>"Virgin Islands (U.S.)",	"value"=>"VI"),
        array("label"=>"Wallis And Futuna Islands",	"value"=>"WF"),
        array("label"=>"Western Sahara",	"value"=>"EH"),
        array("label"=>"Yemen",	"value"=>"YE"),
        array("label"=>"Yugoslavia",	"value"=>"YU"),
        array("label"=>"Zaire",	"value"=>"ZR"),
        array("label"=>"Zambia",	"value"=>"ZM"),
        array("label"=>"Zimbabwe",	"value"=>"ZW"),
        array("label"=>"Undefined",	"value"=>"N/A")
        );

    function Customers(&$SOAPEngine) {
        $this->filters   = array(
                           'username'       => trim($_REQUEST['username_filter']),
                           'firstName'      => trim($_REQUEST['firstName_filter']),
                           'lastName'       => trim($_REQUEST['lastName_filter']),
                           'organization'   => trim($_REQUEST['organization_filter']),
                           'tel'            => trim($_REQUEST['tel_filter']),
                           'email'          => trim($_REQUEST['email_filter']),
                           'web'            => trim($_REQUEST['web_filter']),
                           'country'        => trim($_REQUEST['country_filter']),
                           'city'           => trim($_REQUEST['city_filter']),
                           'only_resellers' => trim($_REQUEST['only_resellers_filter'])
                           );

		$this->Records(&$SOAPEngine);

    }

    function listRecords() {

        // Filter
        $filter=array('username'     => $this->filters['username'],
                      'firstName'    => $this->filters['firstName'],
                      'lastName'     => $this->filters['lastName'],
                      'organization' => $this->filters['organization'],
                      'tel'          => $this->filters['tel'],
                      'email'        => $this->filters['email'],
                      'web'          => $this->filters['web'],
                      'city'         => $this->filters['city'],
                      'country'      => $this->filters['country'],
                      'only_resellers' => $this->filters['only_resellers'],
                      'customer'     => intval($this->filters['customer']),
                      'reseller'     => intval($this->filters['reseller'])
                      );

        // Range
        $range=array('start' => intval($this->next),
                     'count' => intval($this->maxrowsperpage)
                     );

        // Order
        if (!$this->sorting['sortBy'])    $this->sorting['sortBy']    = 'customer';
        if (!$this->sorting['sortOrder']) $this->sorting['sortOrder'] = 'DESC';

        $orderBy = array('attribute' => $this->sorting['sortBy'],
                         'direction' => $this->sorting['sortOrder']
                         );

        // Compose query
        $Query=array('filter'     => $filter,
                        'orderBy' => $orderBy,
                        'range'   => $range
                        );

		$this->showSeachForm();

        // Insert credetials
        $this->SOAPEngine->soapclient->addHeader($this->SOAPEngine->SoapAuth);

        // Call function
        if ($this->adminonly && $this->filters['only_resellers']) {
        	$result     = $this->SOAPEngine->soapclient->getResellers($Query);
        } else {
        	$result     = $this->SOAPEngine->soapclient->getCustomers($Query);
        }

        if (PEAR::isError($result)) {
            $error_msg  = $result->getMessage();
            $error_fault= $result->getFault();
            $error_code = $result->getCode();
            printf ("<p><font color=red>Error from %s: %s (%s): %s</font>",$this->SOAPEngine->SOAPurl,$error_msg, $error_fault->detail->exception->errorcode,$error_fault->detail->exception->errorstring);
            return false;
        } else {

			$this->rows = $result->total;

            if ($this->rows && $_REQUEST['action'] != 'PerformActions' && $_REQUEST['action'] != 'Delete') {
                $this->showActionsForm();
            }

            print "
            <table border=0 align=center>
            <tr><td>$this->rows records found</td></tr>
            </table>
            <p>
            <table border=0 cellpadding=2 width=100%>
            <tr bgcolor=lightgrey>
                <td><b>Id</b></th>
                ";
                if ($this->version > 1) print "<td><b>Customer</b></td>";
                print"
                <td><b>Username</b></td>
                <td><b>Name</b></td>
                <td><b>Organization</b></td>
                <td><b>Country</b></td>
                <td><b>E-mail</b></td>
                <td><b>Telephone</b></td>
                <td><b>Change date</b></td>
                <td><b>Action</b></td>
            </tr>
            ";

            if (!$this->next)  $this->next=0;

            if ($this->rows > $this->maxrowsperpage)  {
                $maxrows = $this->maxrowsperpage + $this->next;
                if ($maxrows > $this->rows) $maxrows = $this->maxrowsperpage;
            } else {
                $maxrows=$this->rows;
            }

            $i=0;

			if ($this->rows) {
                while ($i < $maxrows)  {

                    if (!$result->accounts[$i]) break;
    
                    $customer = $result->accounts[$i];

                    $index = $this->next+$i+1;
    
                    $rr=floor($index/2);
                    $mod=$index-$rr*2;
            
                    if ($mod ==0) {
                    	$bgcolor="lightgrey";
                    } else {
                        $bgcolor="white";
                    }

        			$_url = $this->url.sprintf("&service=%s&action=Delete&reseller_filter=%s&customer_filter=%s",
                    urlencode($this->SOAPEngine->service),
                    urlencode($customer->reseller),
                    urlencode($customer->id)
                    );

                    if ($_REQUEST['action'] == 'Delete' &&
                        $_REQUEST['customer_filter'] == $customer->id) {
                		$_url .= "&confirm=1";
                        $actionText = "<font color=red>Confirm</font>";
                    } else {
                        $actionText = "Delete";
                    }

        			$_customer_url = $this->url.sprintf("&service=%s&reseller_filter=%s&customer_filter=%s",
                    urlencode($this->SOAPEngine->service),
                    urlencode($customer->reseller),
                    urlencode($customer->id)
                    );

                    printf("
                    <tr bgcolor=%s>
                    <td>%s</td>
                    <td><a href=%s>%s.%s</a></td>
                    <td>%s</td>
                    <td>%s %s</td>
                    <td>%s</td>
                    <td>%s</td>
                    <td><a href=mailto:%s>%s</a></td>
                    <td>%s</td>
                    <td>%s</td>
                    <td><a href=%s>%s</a></td>
                    </tr>",
                    $bgcolor,
                    $index,
                    $_customer_url,
                    $customer->reseller,
                    $customer->id,
                    $customer->username,
                    $customer->firstName,
                    $customer->lastName,
                    $customer->organization,
                    $customer->country,
                    $customer->email,
                    $customer->email,
                    $customer->tel,
                    $customer->changeDate,
                    $_url,
                    $actionText
                    );

                    $i++;
                }
			}

            print "</table>";

			if ($this->rows == 1 ) {
                $this->showRecord($customer);
            } else {
            	$this->showPagination($maxrows);
            }

            return true;
        }
    }

    function showSeachFormCustom() {
        printf (" Username<input type=text size=10 name=username_filter value='%s'>",$this->filters['username']);
        printf (" FName<input type=text size=7 name=firstName_filter value='%s'>",$this->filters['firstName']);
        printf (" LName<input type=text size=7 name=lastName_filter value='%s'>",$this->filters['lastName']);
        printf (" Org<input type=text size=10 name=organization_filter value='%s'>",$this->filters['organization']);

        if ($this->adminonly) {
            if ($this->filters['only_resellers']) $check_only_resellers_filter='checked';
        	printf (" Resellers<input type=checkbox name=only_resellers_filter value=1 %s>",$check_only_resellers_filter);
        }
    }

    function deleteRecord() {
        if (!$_REQUEST['confirm']) {
        	print "<p><font color=red>Please press on Confirm to confirm the delete. </font>";
            return true;
        }

        if (!strlen($this->filters['customer'])) {
            print "<p><font color=red>Error: missing customer id. </font>";
            return false;
        }

        $function=array('commit'   => array('name'       => 'deleteAccount',
                                            'parameters' => array(intval($this->filters['customer'])),
                                            'logs'       => array('success' => sprintf('<p>Customer id %s has been deleted',$this->filters['customer'])))
                        );
     
        return $this->SOAPEngine->execute($function);
    }

    function getRecord($id) {

        $this->SOAPEngine->soapclient->addHeader($this->SOAPEngine->SoapAuth);
        $result     = $this->SOAPEngine->soapclient->getAccount(intval($id));

        if (PEAR::isError($result)) {
            $error_msg  = $result->getMessage();
            $error_fault= $result->getFault();
            $error_code = $result->getCode();
            printf ("<p><font color=red>Error from %s: %s (%s): %s</font>",$this->SOAPEngine->SOAPurl,$error_msg, $error_fault->detail->exception->errorcode,$error_fault->detail->exception->errorstring);
            return false;
        } else {
        	return $result;
        }
    }

    function showRecord($customer){

        /*
        print "<pre>";
        print_r($customer);
        print "</pre>";
        */

        print "<table border=0 cellpadding=10>";
        print "
        <tr>
        <td valign=top>
        <h3>Customer data</h3>
        <table border=0>
        ";

        printf ("<form method=post name=addform action=%s>",$_SERVER['PHP_SELF']);
        print "<input type=hidden name=action value=Update>";
        print "<input type=hidden name=section value=customer_data>";

        print "<tr>
        <td colspan=2 class=border><input type=submit value=Update>
        </td></tr>";

        printf ("<tr bgcolor=lightgrey>
        <td class=border>Field</td>
        <td class=border>Value</td>
        </tr>");
        foreach (array_keys($this->FieldsReadOnly) as $item) {
            printf ("<tr>
            <td class=border valign=top>%s</td>
            <td class=border>%s</td>
            </tr>",
            ucfirst($item),
            $customer->$item
            );
        }
        foreach (array_keys($this->Fields) as $item) {
            if ($this->Fields[$item]['name']) {
                $item_name=$this->Fields[$item]['name'];
            } else {
            	$item_name=ucfirst($item);
            }

            if ($item=='timezone') {
                printf ("<tr>
                <td class=border valign=top>%s</td>",
                $item_name
                );
                print "<td class=border>";

                $this->showTimezones($customer->$item);

                print "</td>
                </tr>
                ";
            } else if ($item=='country') {
                printf ("<tr>
                <td class=border valign=top>%s</td>",
                $item_name
                );
                print "<td class=border>
                <select name=country_form>";

				$selected_country[$customer->country]='selected';

                foreach ($this->countries as $_country) {
                    printf ("<option value='%s' %s>%s",$_country['value'],$selected_country[$_country['value']],$_country['label']);
                }

                print "
                </select>
                </td>
                </tr>
                ";


            } else if ($item=='state') {
                printf ("<tr>
                <td class=border valign=top>%s</td>",
                $item_name
                );

                print "<td class=border>
                <select name=state_form>";

				$selected_state[$customer->state]='selected';

                foreach ($this->states as $_state) {
                    printf ("<option value='%s' %s>%s",$_state['value'],$selected_state[$_state['value']],$_state['label']);
                }

                print "
                </select>
                </td>
                </tr>
                ";

            } else {
                if ($this->Fields[$item]['type'] == 'textarea') {
                    printf ("
                    <tr>
                    <td class=border valign=top>%s</td>
                    <td class=border><textarea cols=30 name=%s_form rows=4>%s</textarea></td>
                    </tr>
                    ",
                    $item_name,
                    $item,
                    $customer->$item
                    );
                } elseif ($this->Fields[$item]['type'] == 'boolean') {
                    if ($this->Fields[$item]['adminonly'] && !$this->adminonly) {
                        printf ("
                        <tr>
                        <td class=border valign=top>%s</td>
                        <td class=border><input name=%s_form type=hidden value='%s'>%s</td>
                        </tr>
                        ",
                        $item_name,
                        $item,
                        $customer->$item,
                        $customer->$item
                        );
                    } else {
                    	$_var='select_'.$item;
                        ${$_var}[$customer->$item]='selected';

                        printf ("
                        <tr>
                        <td class=border valign=top>%s</td>
                        <td class=border>
                        <select name=%s_form>
                        <option value='0' %s>False
                        <option value='1' %s>True
                        </select>
                        </td>
                        </tr>
                        ",
                        $item_name,
                        $item,
                        ${$_var}[0],
                        ${$_var}[1]
                        );
                    }
                } else {
                    if ($this->Fields[$item]['adminonly'] && !$this->adminonly) {
                        printf ("
                        <tr>
                        <td class=border valign=top>%s</td>
                        <td class=border><input name=%s_form type=hidden value='%s'>%s</td>
                        </tr>
                        ",
                        $item_name,
                        $item,
                        $customer->$item,
                        $customer->$item
                        );
                    } else {
                        printf ("
                        <tr>
                        <td class=border valign=top>%s</td>
                        <td class=border><input name=%s_form size=30 type=text value='%s'></td>
                        </tr>
                        ",
                        $item_name,
                        $item,
                        $customer->$item
                        );
                    }
                }
            }
        }

        $this->printFiltersToForm();

        $this->printHiddenFormElements();

        print "</form>";
        print "
        </table>
        ";

        /*
        print "<pre>";
        print_r($customer);
        print "</pre>";
        */

		foreach ($customer->properties as $_property) {
        	$this->propertiesItems[$_property->name]['value']=$_property->value;
        }


        print "</td>
        <td valign=top>
        <h3>Customer properties</h3>
        <table border=0>";
        printf ("<form method=post name=addform action=%s>",$_SERVER['PHP_SELF']);
        print "<input type=hidden name=action value=Update>";
        print "<input type=hidden name=section value=customer_properties>";
        print "<tr>
        <td colspan=4 class=border><input type=submit value=Update>
        </td></tr>";

        printf ("<tr bgcolor=lightgrey>
        <td class=border>Category</td>
        <td class=border>Property</td>
        <td class=border>Value</td>
        <td class=border>Description</td>
        </tr>");

        foreach (array_keys($this->propertiesItems) as $item) {
        	$item_print=ucfirst (preg_replace("/_/"," ",$item));
            printf ("<tr>
            <td class=border>%s</td>
            <td class=border>%s</td>
            <td class=border><input type=text size=45 name='%s_form' value='%s'></td>
            <td class=border>%s</td>
            </tr>",
            ucfirst($this->propertiesItems[$item]['category']),
            $item_print,
            $item,
            $this->propertiesItems[$item]['value'],
            $this->propertiesItems[$item]['name']
            );
        }

		if (count($this->customerProperties) > 0) {
            printf ("<tr bgcolor=lightgrey>
            <td class=border colspan=4>Extra properties</td>
            </tr>");
            foreach (array_keys($this->customerProperties) as $item) {
                $item_print=ucfirst (preg_replace("/_/"," ",$item));
                printf ("<tr>
                <td class=border>%s</td>
                <td class=border>%s</td>
                <td class=border><input type=text size=45 name='%s_form' value='%s'></td>
                <td class=border>%s</td>
                </tr>",
                ucfirst($this->customerProperties[$item]['category']),
                $item_print,
                $item,
                $this->propertiesItems[$item]['value'],
                $this->propertiesItems[$item]['name']
                );
            }
        }

        $this->printFiltersToForm();

        $this->printHiddenFormElements();

        print "</form>";

        print "
        </table>
        </td>
        </tr>
        </table>
        ";
    }

    function updateRecord () {
        //print "<p>Updating customer ...";

        if (!strlen($this->filters['customer'])) {
            return false;
        }

        if (!$customer=$this->getRecord($this->filters['customer'])) {
            return false;
        }

        $customer->credit      = floatval($customer->credit);
        $customer->balance     = floatval($customer->balance);

        $customer_old = $customer;

		$properties=array();

		if ($_REQUEST['section'] == 'customer_properties') {
            foreach (array_keys($this->propertiesItems) as $item) {
                $var_name=$item.'_form';
                $var_value=trim($_REQUEST[$var_name]);
                if (strlen($var_value)) {
                    $properties[]=array('name'     => $item,
                                        'value'    => $var_value,
                                        'category' => $this->propertiesItems[$item]['category']
                                        );
                }
    
            }

            foreach (array_keys($this->customerProperties) as $item) {
                $var_name=$item.'_form';
                $var_value=trim($_REQUEST[$var_name]);
                if (strlen($var_value)) {
                    $properties[]=array('name'     => $item,
                                        'value'    => $var_value,
                                        'category' => $this->customerProperties[$item]['category']
                                        );
                }
    
            }

            $customer->properties=$properties;

        } else {
            foreach (array_keys($this->Fields) as $item) {
                $var_name=$item.'_form';
                //printf ("<br>%s=%s",$var_name,$_REQUEST[$var_name]);
                if ($this->Fields[$item]['type'] == 'integer' || $this->Fields[$item]['type'] == 'boolean') {
                	$customer->$item = intval($_REQUEST[$var_name]);
                } else if ($this->Fields[$item]['type'] == 'float') {
                	$customer->$item = floatval($_REQUEST[$var_name]);
                } else {
                	$customer->$item = trim($_REQUEST[$var_name]);
                }
            }

            foreach ($customer->properties as $_property) {
        		$properties[]=$_property;
        	}

            $customer->properties=$properties;
        }

        $function=array('commit'   => array('name'       => 'updateAccount',
                                            'parameters' => array($customer),
                                            'logs'       => array('success' => sprintf('<p>Customer id %s has been updated',strlen($this->filters['customer'])))
                                            ),
                        'rollback' => array('name'       => 'updateAccount',
                                            'parameters' => array($customer_old)
                                            )
                        );
     
        return $this->SOAPEngine->execute($function);
    }

    function showTimezones($timezone) {
        if (!$fp = fopen("timezones", "r")) {
        	print _("Failed to open timezone file.");
            return false;
        }

        print "<select name=timezone_form>";
        print "\n<option>";
        while ($buffer = fgets($fp,1024)) {
        	$buffer=trim($buffer);
            if ($timezone==$buffer) {
                $selected="selected";
            } else {
                $selected="";
            }
            print "\n<option $selected>";
            print "$buffer";
        }
        fclose($fp);
        print "</select>";
    }
}

class recordGenerator extends SOAPEngine {
	//this class generates in bulk enum numbers and sip accounts

	var $template     = array();
    var $allowedPorts = array();

    function recordGenerator($generatorId,$recordGenerators,$soapEngines,$extraFormElements,$loginCredentials) {
    	$this->recordGenerators = $recordGenerators;
        $this->generatorId      = $generatorId;
		$this->loginCredentials = $loginCredentials;

        dprint_r($this->loginCredentials);
		$keys = array_keys($this->recordGenerators);
		if (!$generatorId) $generatorId=$keys[0];

		if (!in_array($generatorId,array_keys($this->recordGenerators))) {
            return false;
        }

        if (strlen($this->loginCredentials['soapFilter'])) {
            $this->soapEngines = $this->getSoapEngineAllowed($soapEngines,$this->loginCredentials['soapFilter']);
        } else {
        	$this->soapEngines = $soapEngines;
        }

        if (in_array($this->recordGenerators[$generatorId]['sipEngineId'],array_keys($this->soapEngines))) {
            // sip zones
            if (count($this->allowedPorts[$this->recordGenerators[$generatorId]['sipEngineId']]) > 1 && !in_array('sip_accounts',$this->allowedPorts[$this->recordGenerators[$generatorId]['sipEngineId']])) {
                // sip port not available
                dprint("sip port not avaliable");
            } else {
                $sipEngine           = 'sip_accounts@'.$this->recordGenerators[$generatorId]['sipEngineId'];
                $this->SipSOAPEngine = new SOAPEngine($sipEngine,$soapEngines,$extraFormElements,$loginCredentials);
                $_sip_class          = $this->SipSOAPEngine->recordsClass;
                $this->sipRecords    = new $_sip_class(&$this->SipSOAPEngine);
                $this->sipRecords->getAllowedDomains();
            }
        } else {
            printf ("<font color=red>Error: soapengineId %s does not exist</font>",$this->recordGenerators[$generatorId]['sipEngineId']);
        }

        if (in_array($this->recordGenerators[$generatorId]['enumEngineId'],array_keys($this->soapEngines))) {
            if (count($this->allowedPorts[$this->recordGenerators[$generatorId]['enumEngineId']]) > 1 && !in_array('enum_numbers',$this->allowedPorts[$this->recordGenerators[$generatorId]['enumEngineId']])) {
                dprint("enum port not avaliable");
                // enum port not available
            } else {
                // enum mappings
                $enumEngine           = 'enum_numbers@'.$this->recordGenerators[$generatorId]['enumEngineId'];
                $this->EnumSOAPEngine = new SOAPEngine($enumEngine,$soapEngines,$extraFormElements,$loginCredentials);
                $_enum_class          = $this->EnumSOAPEngine->recordsClass;
                $this->enumRecords    = new $_enum_class(&$this->EnumSOAPEngine);
                $this->enumRecords->getAllowedDomains();
            }
        } else {
            printf ("<font color=red>Error: soapengineId %s does not exist</font>",$this->recordGenerators[$generatorId]['enumEngineId']);
        }

		if ($_REQUEST['reseller_filter']) $this->template['reseller']=intval($_REQUEST['reseller_filter']);
        if ($_REQUEST['customer_filter']) $this->template['customer']=intval($_REQUEST['customer_filter']);
    }

    function generateRecords() {

        print "<p>";
        if (!$this->checkGenerateRequest()) {
        	return false;
        }
        print "<p>Generating records
        <ol>";


        $i=0;

        while ($i < $this->template['nr_records']) {

            $number   = sprintf("%.0f", $this->start_padded + $i);
            $username = substr($number,$this->template['strip_digits']);
			$mapto    = 'sip:'.$username.'@'.$this->template['domain'];

            print "<li>";
            printf ('Generating number +%s with mapping %s ',$number,$mapto);
            flush();

            $enumMapping = array('tld'      => $this->template['tld'],
                                 'number'   => $number,
                                 'type'     => 'sip',
                                 'mapto'    => $mapto,
                                 'owner'    => $this->template['owner'],
                                 'customer' => $this->template['customer'],
                                 'reseller' => $this->template['reseller']
                                );

            if ($this->template['create_sip']) {
                $groups=array();
                if ($this->template['pstn']) $groups[]='free-pstn';
            	printf ('and sip account %s@%s ',$username,$this->template['domain']);
    
                $sipAccount = array('account'  => $username.'@'.$this->template['domain'],
                                    'quota'    => $this->template['quota'],
                                    'prepaid'  => $this->template['prepaid'],
                                    'password' => $this->template['password'],
                                    'groups'   => $groups,
                                    'owner'    => $this->template['owner'],
                                    'customer' => $this->template['customer'],
                                    'reseller' => $this->template['reseller']
                                    );
            } else {
                unset($sipAccount);
            }

            if (is_array($enumMapping)) $this->enumRecords->addRecord($enumMapping);
            if (is_array($sipAccount))  $this->sipRecords->addRecord($sipAccount);

            $i++;
        }

        print "</ol>";
        return true;
	}

    function checkGenerateRequest() {
        // check number of records
        $this->template['create_sip']=trim($_REQUEST['create_sip']);

        $nr_records=trim($_REQUEST['nr_records']);
        if (!is_numeric($nr_records) || $nr_records < 1 || $nr_records > 200) {
            print "<font color=red>Error: number of records must be a number between 1 and 200</font>";
            return false;
        }
        $this->template['nr_records'] = $nr_records;

        // length of generated record
        $len=trim($_REQUEST['len']);
        if (!is_numeric($len) || $len < 4 || $len > 15) {
            print "<font color=red>Error: number length must be a number between 4 and 15</font>";
            return false;
        }
        $this->template['len'] = $len;

        // sip domain
        $domain=trim($_REQUEST['domain']);
        if (!strlen($domain)) {
            print "<font color=red>Error: SIP domain missing</font>";
            return false;
        }
        $this->template['domain'] = $domain;

        $nr_start=trim($_REQUEST['nr_start']);
        if (strlen($nr_start) && !is_numeric($nr_start)) {
            print "<font color=red>Error: Prefix must be numeric</font>";
            return false;
        }
        $this->template['nr_start'] = $nr_start;

        // check ENUM TLD
        list($prefix,$tld)=explode('@',trim($_REQUEST['range']));

        $this->template['prefix']   = intval($prefix);
        $this->template['tld']      = $tld;
        $this->template['quota']    = intval($_REQUEST['quota']);
        $this->template['owner']    = intval($_REQUEST['owner']);
        $this->template['pstn']     = intval($_REQUEST['pstn']);
        $this->template['prepaid']  = intval($_REQUEST['prepaid']);
        $this->template['password'] = trim($_REQUEST['password']);

        ///////////////////////////////////////
        // logical checks
        if (strlen($this->template['nr_start'])) {
            $start = $this->template['nr_start'];
        } else {
            $start = 0;
        }

		$digits             = $this->template['len']-strlen($this->template['prefix']);
        $this->start_padded = $this->template['prefix'].str_pad($start,$digits,'0');
        $this->top          = sprintf("%.0f", $this->start_padded + pow(10,$digits-strlen($this->template['nr_start'])));
        $maxNumbers         = pow(10,$digits-strlen($this->template['nr_start']));

        if ($maxNumbers < $this->template['nr_records']) {
            printf ("<font color=red>Error: Insufficient numbers in range, requested = %d, available = %d</font>",$this->template['nr_records'],$maxNumbers);
            return false;
        }

        return true;
    }

    function showGeneratorForm() {
    	if (!count($this->enumRecords->ranges)) {
            print "<font color=red>Error: No ENUM ranges available</font>";
        	return false;
        }
        print "
        <form method=post target=_new>
        <table cellspacing=1 cellpadding=1 bgcolor=black>
        <tr>
        <td>
        <table cellspacing=3 cellpadding=4 width=100% bgcolor=#444444>
        <tr>
        <td>
        <font color=white>
        <b>";
        print _("Record generator");
        print "</b>
        </font>
        </td>
        </tr>
        </table>
        </tr>
        <tr>
        <td colspan=100%>

        <table cellpadding=2 bgcolor=white width=100%>
        <tr>
        <td colspan=3>
        </td>
        </tr>
        ";
    
        print "
        <tr>
        <td>";
        print _("ENUM range");
        print "
        <td align=right>";

        if (is_array($this->enumRecords->ranges)) {
            print "<select name=range>";
            $selected_range[$_REQUEST['range']]='selected';
            foreach ($this->enumRecords->ranges as $_range) {
                $rangeId=$_range['prefix'].'@'.$_range['tld'];
                printf ("<option value=%s %s>+%s under %s",$rangeId,$selected_range[$rangeId],$_range['prefix'],$_range['tld']);
            }
            print "</select>";
        }

        print "<td>
        </tr>
        ";

        print "
        <tr>
        <td colspan=2>
        ";
        print "<b>";
        print _("ENUM mapping template");
        print "</b>";
        print "</td>
        </tr>
        ";

        print "
        <tr>
        <td>";
        print _("Add prefix:");
        printf ("
        <td align=right>
        <input type=text name=nr_start size=10 maxsize=15 value='%s'>
        </td>
        </tr>
        ",$_REQUEST['nr_start']);
        print "
        <tr>
        <td>";
        print _("Number length:");
        printf ("
        <td align=right>
        <input type=text name=len size=10 maxsize=15 value='%s'>
        <tr>
        <td>
        ",$_REQUEST['len']);
    
        print _("SIP domain:");
        print "
        <td align=right>
        ";

        if (count($this->sipRecords->allowedDomains) > 0) {
            print "
            <select name=domain>
            ";
            $selected_range[$_REQUEST['domain']]='selected';

            foreach ($this->sipRecords->allowedDomains as $domain) {
                printf ("<option value='%s' %s>%s",$domain,$selected_range[$domain],$domain);
            }
            print "</select>  ";
        } else {
            print "<input type=text size=15 name=domain>";
        }

        print "
        </td>
        <td>";
        print "
        </td>
        </tr>
        ";

        if ($_REQUEST['strip_digits']) {
            $strip_digits=$_REQUEST['strip_digits'];
        } else {
            $strip_digits=0;
        }

        print "
        <tr>
        <td>";
        print _("Strip first digits:");
        printf ("
        <td align=right>
        <input type=text size=10 name=strip_digits value='%s'>
        </td>
        </tr>
        ",$strip_digits);
        print "
        <tr>
        <td>";
        print _("Owner:");
        printf ("
        <td align=right><input type=text size=10 name=owner value='%s'>
        <td>",$_REQUEST['owner']);
        print "
        </td>
        </tr>";

        if (count($this->sipRecords->allowedDomains) > 0) {
            print "
            <tr>
            <td colspan=3><hr noshade size=1>
            </td>
            </tr>
            ";
    
            print "
            <tr>
            <td colspan=2>
            ";
            print "<b>";
            print _("SIP account template");
            print "</b>";
            print "</td>
            </tr>
            ";

            print "
            <tr>
            <td>";
            print _("Create SIP records");
            if ($_REQUEST['create_sip']) {
            	$checked_create_sip='checked';
            } else {
            	$checked_create_sip='';
            }
            printf ("
            <td align=right><input type=checkbox name=create_sip value=1 %s>
            </td>
            </tr>
            ",$checked_create_sip);

            if ($_REQUEST['pstn']) {
            	$checked_pstn='checked';
            } else {
            	$checked_pstn='';
            }

            print "
            <tr>
            <td>";
            print _("PSTN");
            printf ("
            <td align=right><input type=checkbox name=pstn value=1 %s>
            </td>
            </tr>
            ",$checked_pstn);

            if ($_REQUEST['prepaid']) {
            	$checked_prepaid='checked';
            } else {
            	$checked_prepaid='';
            }

            print "
            <tr>
            <td>";
            print _("Prepaid");
            printf ("
            <td align=right><input type=checkbox name=prepaid value=1 %s>
            </td>
            </tr>
            ",$checked_prepaid);

            print "
            <tr>
            <td>";
            print _("Prefix Caller-ID");
            printf ("
            <td align=right><input type=text size=10 name=rpid_prefix value='%s'>
            </td>
            </tr>
            ",$_REQUEST['rpid_prefix']);

            print "
            <tr>
            <td>";
            print _("Quota");
            printf ("
            <td align=right><input type=text size=10 name=quota value='%s'>
            </td>
            </tr>
            ",$_REQUEST['quota']);

            print "
            <tr>
            <td>";
            print _("Password");
            printf ("
            <td align=right><input type=text size=10 name=password value='%s'>
            </td>
            </tr>
            ",$_REQUEST['password']);

        }

        if ($_REQUEST['nr_records']) {
            $nr_records=$_REQUEST['nr_records'];
        } else {
            $nr_records=1;
        }

        print "
        <tr>
        <td colspan=3>
        <hr noshade size=1 with=100%>
        </td>
        </tr>
        ";
        print "
        <tr>
        <td>
        ";

        print "<input type=hidden value=Generate>";
        print "<input type=submit value=Generate>";
        printf ("<td align=right>
        Number of records:<input type=text size=10 name=nr_records value='%s'>
        ",$nr_records);
        print "<td>";
        print "
        </tr>
        ";

        print "
        <tr>
        <td colspan=2>
        <br>
        <input type=hidden name=action value=Generate>
        <p>";
        print _("Existing records will not be overwritten. ");
        print "</td>
        </tr>
        ";

        $this->printHiddenFormElements();

        print "
        </table>
        </form>
        </td>
        </tr>
        </table>
        ";
    }

    function printHiddenFormElements () {
        printf("<input type=hidden name=generatorId value='%s'>",$this->generatorId);

        if ($this->adminonly) {
        	printf("<input type=hidden name=adminonly value='%s'>",$this->adminonly);
        }

        if ($this->template['customer']) {
        	printf("<input type=hidden name=customer_filter value='%s'>",$this->template['customer']);
        }

        if ($this->template['reseller']) {
        	printf("<input type=hidden name=reseller_filter value='%s'>",$this->template['reseller']);
        }

        foreach (array_keys($this->extraFormElements) as $element) {
        	if (!strlen($this->extraFormElements[$element])) continue;
            printf ("<input type=hidden name=%s value='%s'>\n",$element,$this->extraFormElements[$element]);
        }

    }

    function getSoapEngineAllowed($soapEngines,$filter) {

        // filter syntax:
        // $filter="engine1:port1,port2,port3 engine2 engine3";
        // where engine is a connection from ngnpro_engines.inc and
        // port is valid port from that engine like sip_accounts or enum_numbers

    	$_filter_els=explode(" ",trim($filter));
		foreach(array_keys($soapEngines) as $_engine) {
            //dprint("check engine $_engine");
        	foreach ($_filter_els as $_filter) {
                unset($_allowed_engine);
                $_allowed_ports=array();

                list($_allowed_engine,$_allowed_ports_els) = explode(":",$_filter);

                //dprint ("_allowed_engine=$_allowed_engine, _allowed_ports=$_allowed_ports_els");
                if ($_allowed_ports_els) {
                	$_allowed_ports = explode(",",$_allowed_ports_els);
                }

            	if ($_engine == $_allowed_engine) {
                	$soapEngines_checked[$_engine]=$soapEngines[$_engine];
                    $this->allowedPorts[$_engine]=$_allowed_ports;
                	continue;
            	} else {
                    //dprint ("$_engine != $_allowed_engine");
                }
        	}
    	}

		//dprint_r($soapEngines_checked);

        return $soapEngines_checked;
    }

}

class Actions {
    // this class perfom actions on an array of entities returned by selections

    var $actions = array();
    var $version = 1;

    function Actions(&$SOAPEngine) {
		$this->SOAPEngine = $SOAPEngine;
        $this->version    = $this->SOAPEngine->version;
        $this->adminonly  = $this->SOAPEngine->adminonly;
    }

    function performActions($selectionKeys,$action,$sub_action_parameter) {
    }

    function showActionsForm($filters,$sorting,$hideParameter=false) {
        if (!count($this->actions)) return;

        print "
        <p>
        <table border=0 class=border width=100%>
        <tr>
        ";

        printf ("<form method=post name=actionform action=%s>",$_SERVER['PHP_SELF']);
        print "
        <td align=left>
        ";

        print "
        <input type=submit value='Perform this action on the selection:'>
        <input type=hidden name=action value=PerformActions>
        ";
        if ($this->adminonly) {
            print "
            <input type=hidden name=adminonly value=$this->adminonly>
            ";
        }


        print "<select name=sub_action>";
        $j=0;
        foreach (array_keys($this->actions) as $_action) {
            $j++;
            printf ("<option value='%s'>%d. %s",$_action,$j,$this->actions[$_action]);
        }
        print "</select>";


		if (!$hideParameter) {
        	print "
        	<input type=text size=15 name=sub_action_parameter>
        	";
        }
        print "
        </td>
        <td align=right>
        ";
        print "
	    </td>
        ";

        foreach (array_keys($filters) as $_filter) {
            printf ("<input type=hidden name='%s_filter' value='%s'>\n", $_filter,$filters[$_filter]);
        }

        foreach (array_keys($sorting) as $_sorting) {
            printf ("<input type=hidden name='%s' value='%s'>\n", $_sorting,$sorting[$_sorting]);
        }

        printf("<input type=hidden name=service value='%s'>",$this->SOAPEngine->service);

        foreach (array_keys($this->SOAPEngine->extraFormElements) as $element) {
        	if (!strlen($this->SOAPEngine->extraFormElements[$element])) continue;
            printf ("<input type=hidden name=%s value='%s'>\n",$element,$this->SOAPEngine->extraFormElements[$element]);
        }
            print "
            </form>
        </tr>
        </table>
        ";

    }
}

class SIPAccountsActions extends Actions {
    var $actions=array('block'          => 'Block SIP accounts',
                       'deblock'        => 'Deblock SIP accounts',
                       'enable_pstn'    => 'Enable access to PSTN for the SIP accounts',
                       'disable_pstn'   => 'Disable access to PSTN for the SIP accounts',
                       'deblock_quota'  => 'Deblock SIP accounts blocked by quota',
                       'prepaid'        => 'Make SIP accounts prepaid',
                       'postpaid'       => 'Make SIP accounts postpaid',
                       'delete'         => 'Delete SIP accounts',
                       'setquota'       => 'Set quota of SIP account to:',
                       'rpidasusername' => 'Set PSTN caller ID as the username',
                       'prefixtorpid'   => 'Add to PSTN caller ID this prefix:',
                       'rmdsfromrpid'   => 'Remove from PSTN caller ID digits:',
                       'addtogroup'     => 'Add SIP accounts to group:',
                       'removefromgroup'=> 'Remove SIP accounts from group:',
                       'addbalance'     => 'Add to prepaid balance value:',
                       'changeowner'    => 'Change owner to:'
                       );

    function SIPAccountsActions(&$SOAPEngine) {
        $this->Actions(&$SOAPEngine);
        if ($this->version > 1) {
            $this->actions['changecustomer']='Change customer to:';
        }
    }

    function performActions($selectionKeys,$action,$sub_action_parameter) {
        if (!in_array($action,array_keys($this->actions))) {
            print "<font color=red>Error: Invalid action $action</font>";
        	return false;
        }

        print "<ol>";
        foreach($selectionKeys as $key) {
            print "<li>";

            flush();
            //printf ("Performing action=%s on key=%s",$action,$key);

        	$account=array('username' => $key['username'],
                           'domain'   => $key['domain']
        			      );

        	if ($action=='block') {

                $function=array('commit'   => array('name'       => 'addToGroup',
                                                    'parameters' => array($account,'block'),
                                                    'logs'       => array('success' => sprintf('SIP account %s@%s has been blocked',$key['username'],$key['domain'])
                                                                          )
                                                   )
        
                                );

                $this->SOAPEngine->execute($function);

        	} else if ($action=='deblock') {

                $function=array('commit'   => array('name'       => 'removeFromGroup',
                                                    'parameters' => array($account,'block'),
                                                    'logs'       => array('success' => sprintf('SIP account %s@%s has been de-blocked',$key['username'],$key['domain'])
                                                                          )
                                                   )
        
                                );

                $this->SOAPEngine->execute($function);

        	} else if ($action=='removefromgroup') {
            	if (!strlen($sub_action_parameter)) {
            		printf ("<font color=red>Error: you must enter a group name</font>");
                    break;
                }

                $function=array('commit'   => array('name'       => 'removeFromGroup',
                                                    'parameters' => array($account,$sub_action_parameter),
                                                    'logs'       => array('success' => sprintf('SIP account %s@%s has been removed from group',$key['username'],$key['domain'],$sub_action_parameter)
                                                                          )
                                                   )
        
                                );

                $this->SOAPEngine->execute($function);

        	} else if ($action=='addtogroup') {
            	if (!strlen($sub_action_parameter)) {
            		printf ("<font color=red>Error: you must enter a group name</font>");
                    break;
                }

                $function=array('commit'   => array('name'       => 'addToGroup',
                                                    'parameters' => array($account,$sub_action_parameter),
                                                    'logs'       => array('success' => sprintf('SIP account %s@%s is now in group %s',$key['username'],$key['domain'],$sub_action_parameter)
                                                                          )
                                                   )
        
                                );

                $this->SOAPEngine->execute($function);

        	} else if ($action=='deblock_quota') {

                $function=array('commit'   => array('name'       => 'removeFromGroup',
                                                    'parameters' => array($account,'quota'),
                                                    'logs'       => array('success' => sprintf('SIP account %s@%s has been deblocked from quota',$key['username'],$key['domain'])
                                                                          )
                                                   )
        
                                );

                $this->SOAPEngine->execute($function);

        	} else if ($action=='disable_pstn') {

                $function=array('commit'   => array('name'       => 'removeFromGroup',
                                                    'parameters' => array($account,'free-pstn'),
                                                    'logs'       => array('success' => sprintf('SIP account %s@%s has no access to the PSTN',$key['username'],$key['domain'])
                                                                          )
                                                   )
        
                                );

                $this->SOAPEngine->execute($function);

        	} else if ($action=='enable_pstn') {

                $function=array('commit'   => array('name'       => 'addToGroup',
                                                    'parameters' => array($account,'free-pstn'),
                                                    'logs'       => array('success' => sprintf('SIP account %s@%s has access to the PSTN',$key['username'],$key['domain'])
                                                                          )
                                                   )
        
                                );

                $this->SOAPEngine->execute($function);

        	} else if ($action=='delete') {

                $function=array('commit'   => array('name'       => 'deleteAccount',
                                                    'parameters' => array($account),
                                                    'logs'       => array('success' => sprintf('SIP account %s@%s has been deleted',$key['username'],$key['domain'])
                                                                          )
                                                   )
        
                                );

                $this->SOAPEngine->execute($function);

        	} else if ($action=='prepaid') {
        		$this->SOAPEngine->soapclient->addHeader($this->SOAPEngine->SoapAuth);
		        $result     = $this->SOAPEngine->soapclient->getAccount($account);

        		if (PEAR::isError($result)) {
            		$error_msg  = $result->getMessage();
            		$error_fault= $result->getFault();
            		$error_code = $result->getCode();
            		printf ("<font color=red>Error: %s (%s): %s</font>",$error_msg, $error_fault->detail->exception->errorcode,$error_fault->detail->exception->errorstring);
            		break;
        		} else {
                    //print_r($result);
                    // Sanitize data types due to PHP bugs

                    if (!is_array($result->properties))   $result->properties=array();
        			if (!is_array($result->groups)) 	  $result->groups=array();
                    $result->quota         = intval($result->quota);
                    $result->answerTimeout = intval($result->answerTimeout);

                    $result->prepaid=1;

                    $function=array('commit'   => array('name'       => 'updateAccount',
                                                        'parameters' => array($result),
                                                        'logs'       => array('success' => sprintf('SIP account %s@%s is now prepaid',$key['username'],$key['domain'])
                                                                              )
                                                       )
            
                                    );
                	$this->SOAPEngine->execute($function);
        		}
        	} else if ($action=='postpaid') {
        		$this->SOAPEngine->soapclient->addHeader($this->SOAPEngine->SoapAuth);
		        $result     = $this->SOAPEngine->soapclient->getAccount($account);

        		if (PEAR::isError($result)) {
            		$error_msg  = $result->getMessage();
            		$error_fault= $result->getFault();
            		$error_code = $result->getCode();
            		printf ("<font color=red>Error: %s (%s): %s</font>",$error_msg, $error_fault->detail->exception->errorcode,$error_fault->detail->exception->errorstring);
            		break;
        		} else {
                    //print_r($result);
                    // Sanitize data types due to PHP bugs

                    if (!is_array($result->properties))   $result->properties=array();
        			if (!is_array($result->groups)) 	  $result->groups=array();
                    $result->quota         = intval($result->quota);
                    $result->answerTimeout = intval($result->answerTimeout);

                    $result->prepaid=0;

                    $function=array('commit'   => array('name'       => 'updateAccount',
                                                        'parameters' => array($result),
                                                        'logs'       => array('success' => sprintf('SIP account %s@%s is now postpaid',$key['username'],$key['domain'])
                                                                              )
                                                       )
            
                                    );
                	$this->SOAPEngine->execute($function);

        		}
        	} else if ($action=='setquota') {
        		$this->SOAPEngine->soapclient->addHeader($this->SOAPEngine->SoapAuth);
		        $result     = $this->SOAPEngine->soapclient->getAccount($account);

        		if (PEAR::isError($result)) {
            		$error_msg  = $result->getMessage();
            		$error_fault= $result->getFault();
            		$error_code = $result->getCode();
            		printf ("<font color=red>Error: %s (%s): %s</font>",$error_msg, $error_fault->detail->exception->errorcode,$error_fault->detail->exception->errorstring);
            		break;
        		} else {
                    //print_r($result);
                    // Sanitize data types due to PHP bugs

                    if (!is_array($result->properties))   $result->properties=array();
        			if (!is_array($result->groups)) 	  $result->groups=array();
                    $result->quota         = intval($sub_action_parameter);
                    $result->answerTimeout = intval($result->answerTimeout);

                    $function=array('commit'   => array('name'       => 'updateAccount',
                                                        'parameters' => array($result),
                                                        'logs'       => array('success' => sprintf('SIP account %s@%s has quota set to %s',$key['username'],$key['domain'],$sub_action_parameter)
                                                                              )
                                                       )
            
                                    );
                	$this->SOAPEngine->execute($function);

        		}
                
        	} else if ($action=='rmdsfromrpid') {
        		$this->SOAPEngine->soapclient->addHeader($this->SOAPEngine->SoapAuth);
		        $result     = $this->SOAPEngine->soapclient->getAccount($account);

        		if (PEAR::isError($result)) {
            		$error_msg  = $result->getMessage();
            		$error_fault= $result->getFault();
            		$error_code = $result->getCode();
            		printf ("<font color=red>Error: %s (%s): %s</font>",$error_msg, $error_fault->detail->exception->errorcode,$error_fault->detail->exception->errorstring);
            		break;
        		} else {
                    //print_r($result);
                    // Sanitize data types due to PHP bugs

                    if (!is_array($result->properties)) $result->properties=array();
        			if (!is_array($result->groups)) 	$result->groups=array();
                    if (is_numeric($sub_action_parameter) && strlen($result->rpid) > $sub_action_parameter) {
                        printf("%s %s",$result->rpid,$sub_action_parameter);
                    	$result->rpid=substr($result->rpid,$sub_action_parameter);
                        printf("%s %s",$result->rpid,$sub_action_parameter);
                    } else {
            			printf ("<font color=red>Error: '%s' must be numeric and less than caller if length</font>",$sub_action_parameter);
                        continue;
                    }

                    $result->quota         = intval($result->quota);
                    $result->answerTimeout = intval($result->answerTimeout);

                    $function=array('commit'   => array('name'       => 'updateAccount',
                                                        'parameters' => array($result),
                                                        'logs'       => array('success' => sprintf('SIP account %s@%s has PSTN caller ID set to %s',$key['username'],$key['domain'],$result->rpid)
                                                                              )
                                                       )
            
                                    );
                	$this->SOAPEngine->execute($function);

        		}
        	} else if ($action=='rpidasusername') {
        		$this->SOAPEngine->soapclient->addHeader($this->SOAPEngine->SoapAuth);
		        $result     = $this->SOAPEngine->soapclient->getAccount($account);

        		if (PEAR::isError($result)) {
            		$error_msg  = $result->getMessage();
            		$error_fault= $result->getFault();
            		$error_code = $result->getCode();
            		printf ("<font color=red>Error: %s (%s): %s</font>",$error_msg, $error_fault->detail->exception->errorcode,$error_fault->detail->exception->errorstring);
            		break;
        		} else {
                    //print_r($result);
                    // Sanitize data types due to PHP bugs

                    if (!is_array($result->properties)) $result->properties=array();
        			if (!is_array($result->groups)) 	$result->groups=array();
                    if (is_numeric($key['username']))   $result->rpid=$key['username'];

                    $result->quota         = intval($result->quota);
                    $result->answerTimeout = intval($result->answerTimeout);

                    $function=array('commit'   => array('name'       => 'updateAccount',
                                                        'parameters' => array($result),
                                                        'logs'       => array('success' => sprintf('SIP account %s@%s has PSTN caller ID set to %s',$key['username'],$key['domain'],$key['username'])
                                                                              )
                                                       )
            
                                    );
                	$this->SOAPEngine->execute($function);

        		}
        	} else if ($action=='prefixtorpid') {
        		$this->SOAPEngine->soapclient->addHeader($this->SOAPEngine->SoapAuth);
		        $result     = $this->SOAPEngine->soapclient->getAccount($account);

        		if (PEAR::isError($result)) {
            		$error_msg  = $result->getMessage();
            		$error_fault= $result->getFault();
            		$error_code = $result->getCode();
            		printf ("<font color=red>Error: %s (%s): %s</font>",$error_msg, $error_fault->detail->exception->errorcode,$error_fault->detail->exception->errorstring);
            		break;
        		} else {
                    //print_r($result);
                    // Sanitize data types due to PHP bugs

                    if (!is_array($result->properties))   $result->properties=array();
        			if (!is_array($result->groups)) 	  $result->groups=array();
                    if (is_numeric($sub_action_parameter)) {
                    	$result->rpid=$sub_action_parameter.$result->rpid;
                    } else {
            			printf ("<font color=red>Error: '%s' must be numeric</font>",$sub_action_parameter);
                        continue;
                    }
                    $result->quota         = intval($result->quota);
                    $result->answerTimeout = intval($result->answerTimeout);

                    $function=array('commit'   => array('name'       => 'updateAccount',
                                                        'parameters' => array($result),
                                                        'logs'       => array('success' => sprintf('SIP account %s@%s has PSTN caller ID set to %s ',$key['username'],$key['domain'],$result->rpid)
                                                                              )
                                                       )
            
                                    );
                	$this->SOAPEngine->execute($function);

        		}
        	} else if ($action=='changecustomer' && $this->version > 1) {
        		$this->SOAPEngine->soapclient->addHeader($this->SOAPEngine->SoapAuth);
		        $result     = $this->SOAPEngine->soapclient->getAccount($account);

        		if (PEAR::isError($result)) {
            		$error_msg  = $result->getMessage();
            		$error_fault= $result->getFault();
            		$error_code = $result->getCode();
            		printf ("<font color=red>Error: %s (%s): %s</font>",$error_msg, $error_fault->detail->exception->errorcode,$error_fault->detail->exception->errorstring);
            		break;
        		} else {
                    //print_r($result);
                    // Sanitize data types due to PHP bugs

                    if (!is_array($result->properties))   $result->properties=array();
        			if (!is_array($result->groups)) 	  $result->groups=array();
                    if (is_numeric($sub_action_parameter)) {
                    	$result->customer=intval($sub_action_parameter);
                    } else {
            			printf ("<font color=red>Error: '%s' must be numeric</font>",$sub_action_parameter);
                        continue;
                    }
                    $result->quota         = intval($result->quota);
                    $result->answerTimeout = intval($result->answerTimeout);

                    $function=array('commit'   => array('name'       => 'updateAccount',
                                                        'parameters' => array($result),
                                                        'logs'       => array('success' => sprintf('SIP account %s@%s has customer set to %s ',$key['username'],$key['domain'],$result->customer)
                                                                              )
                                                       )
            
                                    );
                	$this->SOAPEngine->execute($function);

        		}
        	} else if ($action=='changeowner') {
        		$this->SOAPEngine->soapclient->addHeader($this->SOAPEngine->SoapAuth);
		        $result     = $this->SOAPEngine->soapclient->getAccount($account);

        		if (PEAR::isError($result)) {
            		$error_msg  = $result->getMessage();
            		$error_fault= $result->getFault();
            		$error_code = $result->getCode();
            		printf ("<font color=red>Error: %s (%s): %s</font>",$error_msg, $error_fault->detail->exception->errorcode,$error_fault->detail->exception->errorstring);
            		break;
        		} else {
                    //print_r($result);
                    // Sanitize data types due to PHP bugs

                    if (!is_array($result->properties))   $result->properties=array();
        			if (!is_array($result->groups)) 	  $result->groups=array();
                    if (is_numeric($sub_action_parameter)) {
                    	$result->owner=intval($sub_action_parameter);
                    } else {
            			printf ("<font color=red>Error: '%s' must be numeric</font>",$sub_action_parameter);
                        continue;
                    }
                    $result->quota         = intval($result->quota);
                    $result->answerTimeout = intval($result->answerTimeout);

                    $function=array('commit'   => array('name'       => 'updateAccount',
                                                        'parameters' => array($result),
                                                        'logs'       => array('success' => sprintf('SIP account %s@%s has owner set to %s ',$key['username'],$key['domain'],$result->customer)
                                                                              )
                                                       )
            
                                    );
                	$this->SOAPEngine->execute($function);

        		}
        	} else if ($action=='addbalance') {
            	if (!is_numeric($sub_action_parameter)) {
            		printf ("<font color=red>Error: you must enter a positive balance</font>");
                    break;
                }

        		$this->SOAPEngine->soapclient->addHeader($this->SOAPEngine->SoapAuth);
		        $result     = $this->SOAPEngine->soapclient->getAccount($account);

        		if (PEAR::isError($result)) {
            		$error_msg  = $result->getMessage();
            		$error_fault= $result->getFault();
            		$error_code = $result->getCode();
            		printf ("<font color=red>Error: %s (%s): %s</font>",$error_msg, $error_fault->detail->exception->errorcode,$error_fault->detail->exception->errorstring);
            		break;
                }

				if (!$result->prepaid) {
            		printf ("<font color=red>Info: SIP account %s@%s is not prepaid, no action performed</font>",$key['username'],$key['domain']);
                    continue;
                }

                $function=array('commit'   => array('name'       => 'addBalance',
                                                    'parameters' => array($account,$sub_action_parameter),
                                                    'logs'       => array('success' => sprintf('SIP account %s@%s balance has been increased with %s',$key['username'],$key['domain'],$sub_action_parameter)
                                                                          )
                                                   )
        
                                );
                $this->SOAPEngine->execute($function);

            }
        }
        print "</ol>";

    }

}

class SIPAliasesActions extends Actions {
    var $actions=array(
                       'delete'         => 'Delete SIP aliases'
                       );

    function SIPAliases(&$SOAPEngine) {
        $this->Actions(&$SOAPEngine);
    }

    function performActions($selectionKeys,$action,$sub_action_parameter) {
        if (!in_array($action,array_keys($this->actions))) {
            print "<font color=red>Error: Invalid action $action</font>";
        	return false;
        }

        print "<ol>";
        foreach($selectionKeys as $key) {
            print "<li>";
            flush();

            //printf ("Performing action=%s on key=%s",$action,$key);
            $alias=array('username' => $key['username'],
                         'domain'   => $key['domain']
                        );

        	if ($action=='delete') {
    
                $function=array('commit'   => array('name'       => 'deleteAlias',
                                                    'parameters' => array($alias),
                                                    'logs'       => array('success' => sprintf('SIP alias %s@%s has been deleted',$key['username'],$key['domain'])
                                                                          )
                                                   )
        
                                );
    
                //$this->SOAPEngine->execute($function);
            }
        }
        print "</ol>";

    }

}

class ENUMMappingsActions extends Actions {
    var $actions=array(
                       'delete'         => 'Delete ENUM mappings',
                       'changettl'      => 'Change TTL to:',
                       'changeowner'    => 'Change owner to:'
                       );

    var $mapping_fields=array('id'       => 'integer',
                              'type'     => 'text',
                              'mapto'    => 'text',
                              'priority' => 'integer',
                              'ttl'      => 'integer'
                              );

    function ENUMMappingsActions(&$SOAPEngine) {
        $this->Actions(&$SOAPEngine);
    }

    function performActions($selectionKeys,$action,$sub_action_parameter) {
        if (!in_array($action,array_keys($this->actions))) {
            print "<font color=red>Error: Invalid action $action</font>";
        	return false;
        }

        print "<ol>";
        foreach($selectionKeys as $key) {
            flush();
            print "<li>";

            $enum_id=array('number' => $key['number'],
                           'tld'    => $key['tld']
                          );
        	if ($action=='delete') {

                //printf ("Performing action=%s on key=%s",$action,$key);
                $function=array('commit'   => array('name'       => 'deleteNumber',
                                                    'parameters' => array($enum_id),
                                                    'logs'       => array('success' => sprintf('ENUM number +%s under %s has been deleted',$key['number'],$key['tld'])
                                                                          )
                                                   )
        
                                );
    
                $this->SOAPEngine->execute($function);
            } else if ($action  == 'changettl') {
        		$this->SOAPEngine->soapclient->addHeader($this->SOAPEngine->SoapAuth);
		        $number     = $this->SOAPEngine->soapclient->getNumber($enum_id);

        		if (PEAR::isError($number)) {
            		$error_msg  = $number->getMessage();
            		$error_fault= $number->getFault();
            		$error_code = $number->getCode();
            		printf ("<font color=red>Error: %s (%s): %s</font>",$error_msg, $error_fault->detail->exception->errorcode,$error_fault->detail->exception->errorstring);
            		break;
        		} else {

                    if (!is_numeric($sub_action_parameter)) {
            			printf ("<font color=red>Error: TTL '%s' must be numeric</font>",$sub_action_parameter);
                        continue;
                    }

                	$new_mappings=array();

                    foreach ($number->mappings as $_mapping) {
                        foreach (array_keys($this->mapping_fields) as $field) {
                            if ($field == 'ttl') {
                            	$new_mapping[$field]=intval($sub_action_parameter);
                            } else {
                                if ($this->mapping_fields[$field] == 'integer') {
                                    $new_mapping[$field]=intval($_mapping->$field);
                                } else {
                                    $new_mapping[$field]=$_mapping->$field;
                                }
                            }

                        }

        				$new_mappings[]=$new_mapping;
        			}

            		$number->mappings=$new_mappings;

                    $function=array('commit'   => array('name'       => 'updateNumber',
                                                        'parameters' => array($number),
                                                        'logs'       => array('success' => sprintf('ENUM number %s@%s has now TTL %d',$key['number'],$key['tld'],intval($sub_action_parameter))
                                                                              )
                                                       )
            
                                    );
                	$this->SOAPEngine->execute($function);
        		}
            } else if ($action  == 'changeowner') {
        		$this->SOAPEngine->soapclient->addHeader($this->SOAPEngine->SoapAuth);
		        $number     = $this->SOAPEngine->soapclient->getNumber($enum_id);

        		if (PEAR::isError($number)) {
            		$error_msg  = $number->getMessage();
            		$error_fault= $number->getFault();
            		$error_code = $number->getCode();
            		printf ("<font color=red>Error: %s (%s): %s</font>",$error_msg, $error_fault->detail->exception->errorcode,$error_fault->detail->exception->errorstring);
            		break;
        		} else {
            		foreach ($number->mappings as $_property) {
        				$mappings[]=$_property;
        			}
            		$number->mappings=$mappings;

                    if (is_numeric($sub_action_parameter)) {
                    	$number->owner=intval($sub_action_parameter);
                    } else {
            			printf ("<font color=red>Error: Owner '%s' must be numeric</font>",$sub_action_parameter);
                        continue;
                    }

                    $function=array('commit'   => array('name'       => 'updateNumber',
                                                        'parameters' => array($number),
                                                        'logs'       => array('success' => sprintf('ENUM number %s@%s has owner set to  %d',$key['number'],$key['tld'],intval($sub_action_parameter))
                                                                              )
                                                       )
            
                                    );
                	$this->SOAPEngine->execute($function);
        		}
            }
        }

        print "</ol>";

    }

}

?>
