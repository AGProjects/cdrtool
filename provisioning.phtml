<?
include("./global.inc");
page_open(
            array("sess" => "CDRTool_Session",
                  "auth" => "CDRTool_Auth",
                  "perm" => "CDRTool_Perm"));

$title="Provisioning interface";

if (is_readable("local/header.phtml")) {
    include("local/header.phtml");
} else {
    include("header.phtml");
}

$perm->check("admin");

include("SOAP/Client.php");
include("provisioning_lib.phtml");

$layout = new pageLayoutLocal();

$layout->showTopMenu();

$SOAPEngine = new SOAPEngine($_REQUEST['service']);
$_class     = $SOAPEngine->recordsClass;
$RECORDS    = new $_class(&$SOAPEngine);

if ($_REQUEST['action']=='Add') $RECORDS->addRecord();
if ($_REQUEST['action']=='Delete') $RECORDS->deleteRecord();

$RECORDS->listRecords();

$layout->showFooter();

print "
</body>
</html>
";

class SOAPEngine {
    var $services=array(
                        'sip'     => array('recordsClass' => 'SipAccounts',
                                           'soapClass'    => 'WebService_NGNPro_SipPort'
                                          ),
                        'sipa'    => array('recordsClass' => 'SipAliases',
                                           'soapClass'    => 'WebService_NGNPro_SipPort'
                                          ),
                        'domains'    => array('recordsClass' => 'DomainStatistics',
                                           'soapClass'    => 'WebService_NGNPro_SipPort'
                                          ),
                        'enum'    => array('recordsClass' => 'EnumMappings',
                                           'soapClass'    => 'WebService_NGNPro_EnumPort'
                                          ),
                        'trusted' => array('recordsClass' => 'TrustedPeers',
                                           'soapClass'    => 'WebService_NGNPro_SipPort'
                                          )
                        );

    function SOAPEngine($service) {

        // $soapEngines must be defined in global.inc
        global $soapEngines;
        $this->soapEngines = $soapEngines;

        if (is_array($this->soapEngines)) {

            if (!$service) {
                // Use first defined service in global.inc
                $_services     = array_keys($this->services);
                $_soapids      = array_keys($this->soapEngines);
                $service       = $_soapids[0].":".$_services[0];
            }


            $this->service = $service;

            $_els=explode(":",$this->service);

            $this->soapEngineId   = $_els[0];
            $this->soapEnginePort = $_els[1];
            $this->recordsClass   = $this->services[$this->soapEnginePort]['recordsClass'];
            $this->soapClass      = $this->services[$this->soapEnginePort]['soapClass'];

            $this->SOAPlogin = array(
                                   "username"    => $this->soapEngines[$this->soapEngineId]['username'],
                                   "password"    => $this->soapEngines[$this->soapEngineId]['password'],
                                   "admin"       => true
                                   );

            $this->SOAPurl=$this->soapEngines[$this->soapEngineId]['url'];
    
            $this->SoapAuth = array('auth', $this->SOAPlogin , 'urn:AGProjects:NGNPro', 0, '');


    		// Instantiate the SOAP client
            $this->soapclient = new $this->soapClass($this->SOAPurl);

            $this->soapclient->setOpt('curl', CURLOPT_TIMEOUT,        5);
            $this->soapclient->setOpt('curl', CURLOPT_SSL_VERIFYPEER, 0);
            $this->soapclient->setOpt('curl', CURLOPT_SSL_VERIFYHOST, 0);

    	} else {
            print "<p><font color=red>Error: No SOAP credentials defined.</font>";
        }
    }

    function showEngineSelection() {
        $selected_soapEngine[$this->service]='selected';
        printf ("<select name=service onChange=\"document.soapengine.submit.disabled = true; location.href = '%s?service=' + this.options[this.selectedIndex].value\">",$_SERVER['PHP_SELF']);
        $j=0;
        foreach (array_keys($this->soapEngines) as $_engine) {
        	if ($j) printf ("<option value=''>--------");
            foreach (array_keys($this->services) as $_service) {
                $idx=$_engine.":".$_service;
                printf ("<option value='%s:%s' %s>%s:%s",$_engine,$_service,$selected_soapEngine[$idx],ucfirst($_service),$this->soapEngines[$_engine]['name']);
            }
            $j++;
        }

        printf ("</select>");
    }
}

class Records {
	var $maxrowsperpage = '20';

    function Records(&$SOAPEngine) {
    	$this->SOAPEngine=&$SOAPEngine;

        $this->filters['sortBy']    = trim($_REQUEST['sortBy']);
        $this->filters['sortOrder'] = trim($_REQUEST['sortOrder']);
        $this->next                 = $_REQUEST['next'];
    }

    function showPagination($maxrows) {
        print "
        <p>
        <table border=0 align=center>
        <tr>
        <td>
        ";

        $this->url.="&service=".urlencode($this->SOAPEngine->service);

        if ($this->next != 0  ) {
            $show_next=$this->maxrowsperpage-$this->next;
            if  ($show_next < 0)  {
                $mod_show_next  =  $show_next-2*$show_next;
            }
            if (!$mod_show_next) $mod_show_next=0;
            $url_prev=$_SERVER['PHP_SELF'].$this->url."&next=$mod_show_next";
            print "<a href=\"$url_prev\">Previous</a> ";
        }
        
        print "
        </td>
        <td>
        ";

        if ($this->next + $this->maxrowsperpage < $this->rows)  {
            $show_next = $this->maxrowsperpage + $this->next;
            $url_next  = $_SERVER['PHP_SELF'].$this->url."&next=$show_next";
            print "<a href=\"$url_next\">Next</a>";
        }

        print "
        </td>
        </tr>
        </table>
        ";
    }

    function showSeachFormCustom() {
    }

    function showSeachForm() {
        print "
        <p>
        <table border=0 class=border width=100%>
        <tr>
            ";
            printf ("<form method=post name=soapengine action=%s>",$_SERVER['PHP_SELF']);
            print "
        	<td align=left>
            ";
            $this->SOAPEngine->showEngineSelection();

            $this->showSeachFormCustom();

            print "
	        </td>
        	<td align=right>
            ";
            $this->showSortForm();

            print "
            <input type=submit name=action value=Search>
            ";
            print "
	        </td>
            </form>
        </tr>
        </table>
        ";

        if ($_REQUEST['action'] != 'Delete') $this->showAddForm();

    }

    function listRecords() {
    }

    function addRecord() {
    }

    function deleteRecord() {
    }

    function tel2enum($tel,$tld) {

        if (strlen($tld) == 0)  $tld="e164.arpa";

        // transform telephone number in FQDN Enum style domain name
        if (preg_match("/^[+]?(\d+)$/",$tel,$m)) {
            $l=strlen($m[1]);
            $rev_num="";
            $z=0;
            while ($z < $l) {
                $ss=substr($m[1],$z,1);
                $enum=$ss.".".$enum;
                $z++;
            }
            preg_match("/^(.*)\.$/",$enum,$m);
            $enum=$m[1];
            $enum=$enum.".$tld.";
            return($enum);
         } else {
            return($tel);
         }
    }

    function showAddForm() {
	}

    function showSortForm() {

        if (!count($this->sortElements)) {
            return;
        }

        $selected_sortBy[$this->filters['sortBy']]='selected';

        //print " Sort ";

        print "<select name=sortBy>";
        foreach (array_keys($this->sortElements) as $key) {
        	printf ("<option value='%s' %s>%s",$key,$selected_sortBy[$key],$this->sortElements[$key]);
        }
        print "</select>";

        $selected_sortOrder[$this->filters['sortOrder']]='selected';
        print "<select name=sortOrder>";
        printf ("<option value='DESC' %s>DESC",$selected_sortOrder['DESC']);
        printf ("<option value='ASC' %s>ASC",$selected_sortOrder['ASC']);
        print "</select>";
    }

    function showTimezones() {
        if (!$fp = fopen("timezones", "r")) {
        	print _("Failed to open timezone file.");
            return false;
        }
        print "<select name=timezone>";
        print "\n<option>";
        while ($buffer = fgets($fp,1024)) {
        	$buffer=trim($buffer);
            if ($this->timezone==$buffer) {
                $selected="selected";
            } else {
                $selected="";
            }
            print "\n<option $selected>";
            print "$buffer";
        }
        fclose($fp);
        print "</select>";
    }
}

class ENUMmappings extends Records {
    var $sortElements=array('changeDate' => 'Change date',
                            'number'     => 'E.164 number',
                            'tld'        => 'TLD',
                            'owner'      => 'Owner'
                            );

    function ENUMmappings(&$SOAPEngine) {
        $this->filters   = array('number'       => trim($_REQUEST['number_filter']),
                                 'tld'          => trim($_REQUEST['tld_filter']),
                                 'type'         => trim($_REQUEST['type_filter']),
                                 'mapto'        => trim($_REQUEST['mapto_filter']),
                                 'owner'        => trim($_REQUEST['owner_filter'])
                                );
        
		$this->Records(&$SOAPEngine);
    }

    function listRecords() {

		$this->showSeachForm();

        // Filter
        $filter=array('number' => $this->filters['number'],
                      'type'   => $this->filters['type'],
                      'mapto'  => $this->filters['mapto']
                      );

        // Range
        $range=array('start' => intval($this->next),
                     'count' => intval($this->maxrowsperpage)
                     );

        // Order
        if (!$this->filters['sortBy'])    $this->filters['sortBy']    = 'changeDate';
        if (!$this->filters['sortOrder']) $this->filters['sortOrder'] = 'DESC';

        $orderBy = array('attribute' => $this->filters['sortBy'],
                         'direction' => $this->filters['sortOrder']
                         );

        // Compose query
        $Query=array('filter'  => $filter,
                     'orderBy' => $orderBy,
                     'range'   => $range
                     );

        $this->url=sprintf("?sortBy=%s&sortOrder=%s",urlencode($this->filters['sortBy']),urlencode($this->filters['sortOrder']));

        if (strlen($this->filters['number'])) $this->url .= sprintf("&number_filter=%s",urlencode($this->filters['number']));
        if (strlen($this->filters['type']))   $this->url .= sprintf("&type_filter=%s",urlencode($this->filters['type']));
        if (strlen($this->filters['mapto']))  $this->url .= sprintf("&mapto_filter=%s",urlencode($this->filters['mapto']));

        // Insert credetials
        $this->SOAPEngine->soapclient->addHeader($this->SOAPEngine->SoapAuth);

        // Call function
        $result     = $this->SOAPEngine->soapclient->getNumbers($Query);

        if (PEAR::isError($result)) {
            $error_msg  = $result->getMessage();
            $error_fault= $result->getFault();
            $error_code = $result->getCode();
            printf ("<p><font color=red>Error: %s (%s): %s</font>",$error_msg, $error_fault->detail->exception->errorcode,$error_fault->detail->exception->errorstring);
            return false;
        } else {

			$this->rows = $result->total;

            //print "<pre>";
            //print_r($result);

            print "
            <p>
            <table border=0 align=center>
            <tr><td>$this->rows records found</td></tr>
            </table>
            <p>
            <table border=0 cellpadding=2 width=100%>
            <tr bgcolor=lightgrey>
                <td><b>Id</b></th>
                <td><b>E.164 number</b></td>
                <td><b>Top level domain</b></td>
                <td><b>DNS name</b></td>
                <td><b>Service</b></td>
                <td><b>Map to</b></td>
                <td><b>TTL</b></td>
                <td><b>Priority</b></td>
                <td><b>Owner</b></td>
                <td><b>Info</b></td>
            </tr>
            ";

            if (!$this->next)  $this->next=0;

            if ($this->rows > $this->maxrowsperpage)  {
                $maxrows = $this->maxrowsperpage + $this->next;
                if ($maxrows > $this->rows) $maxrows = $this->maxrowsperpage;
            } else {
                $maxrows=$this->rows;
            }

            $i=0;

			if ($this->rows) {
                while ($i < $this->maxrowsperpage)  {
    
                    if (!$result->numbers[$i]) break;
    
                    $number = $result->numbers[$i];
    
                    $index=$this->next+$i+1;
    
                    $rr=floor($index/2);
                    $mod=$index-$rr*2;
            
                    if ($mod ==0) {
                    	$bgcolor="lightgrey";
                    } else {
                        $bgcolor="white";
                    }

                    $j=1;
                    foreach ($number->mappings as $_mapping) {
                        if ($j==1) {
                            printf("
                            <tr bgcolor=%s>
                            <td>%s</td>
                            <td>+%s</td>
                            <td>%s</td>
                            <td>%s</td>
                            <td>%s</td>
                            <td>%s</td>
                            <td>%s</td>
                            <td>%s</td>
                            <td>%s</td>
                            <td>%s</td>
                            </tr>",
                            $bgcolor,
                            $index,
                            $number->id->number,
                            $number->id->tld,
                            $this->tel2enum($number->id->number,$number->id->tld),
                            ucfirst($_mapping->type),
                            $_mapping->mapto,
                            $_mapping->ttl,
                            $_mapping->priority,
                            $number->owner,
                            $number->info
                            );
                        } else {
                            printf("
                            <tr bgcolor=%s>
                            <td></td>
                            <td></td>
                            <td></td>
                            <td></td>
                            <td>%s</td>
                            <td>%s</td>
                            <td>%s</td>
                            <td>%s</td>
                            <td></td>
                            <td></td>
                            </tr>",
                            $bgcolor,
                            ucfirst($_mapping->type),
                            $_mapping->mapto,
                            $_mapping->ttl,
                            $_mapping->priority
                            );

                        }
                        $j++;
                    }

                    printf("
                    </tr>
                    ");

                    $i++;
    
                }
    
			}

            print "</table>";

            $this->showPagination($maxrows);

            return true;
        }
    }

    function showSeachFormCustom() {

        printf (" E.164 number: <input type=text size=10 name=number_filter value='%s'>",$this->filters['number']);
        printf (" TLD: <input type=text size=10 name=tld_filter value='%s'>",$this->filters['tld']);
        printf (" Service: <input type=text size=10 name=type_filter value='%s'>",$this->filters['type']);
        printf (" Map to: <input type=text size=10 name=mapto_filter value='%s'>",$this->filters['mapto']);

    }

}

class TrustedPeers extends Records {

    function TrustedPeers(&$SOAPEngine) {
        $this->filters   = array('ip'     => trim($_REQUEST['ip_filter'])
                           );

		$this->Records(&$SOAPEngine);
    }

    function listRecords() {

		$this->showSeachForm();

        // Insert credetials
        $this->SOAPEngine->soapclient->addHeader($this->SOAPEngine->SoapAuth);

        // Call function
        $result     = $this->SOAPEngine->soapclient->getTrustedPeers();

        if (PEAR::isError($result)) {
            $error_msg  = $result->getMessage();
            $error_fault= $result->getFault();
            $error_code = $result->getCode();
            printf ("<p><font color=red>Error: %s (%s): %s</font>",$error_msg, $error_fault->detail->exception->errorcode,$error_fault->detail->exception->errorstring);
            return false;
        } else {

			$this->rows = count($result);

            print "
            <table border=0 align=center>
            <tr><td>$this->rows records found</td></tr>
            </table>
            <p>
            <table border=0 cellpadding=2 width=100%>
            <tr bgcolor=lightgrey>
                <td><b>Id</b></th>
                <td><b>IP address</b></td>
                <td><b>Protocol</b></td>
                <td><b>From pattern</b></td>
                <td><b>Description</b></td>
                <td><b>Owner</b></td>
                <td><b>Action</b></td>
            </tr>
            ";

            if (!$this->next)  $this->next=0;

            if ($this->rows > $this->maxrowsperpage)  {
                $maxrows = $this->maxrowsperpage + $this->next;
                if ($maxrows > $this->rows) $maxrows = $this->maxrowsperpage;
            } else {
                $maxrows=$this->rows;
            }

            $i=0;

			if ($this->rows) {
                while ($i < $this->maxrowsperpage)  {
    
                    $peer = $result[$i];
                    if (!$peer->ip) break;

                    $index = $this->next+$i+1;
    
                    $rr=floor($index/2);
                    $mod=$index-$rr*2;
            
                    if ($mod ==0) {
                    	$bgcolor="lightgrey";
                    } else {
                        $bgcolor="white";
                    }

                    $this->url .= sprintf("?service=%s&action=Delete&ip_filter=%s",
                    urlencode($this->SOAPEngine->service),
                    urlencode($peer->ip)
                    );

                    if ($_REQUEST['action'] == 'Delete' &&
                    	$_REQUEST['ip_filter'] == $peer->ip) {
                		$this->url .= "&confirm=1";
                        $actionText = "<font color=red>Confirm</font>";
                    } else {
                        $actionText = "Delete";
                    }

                    printf("
                    <tr bgcolor=%s>
                    <td>%s</td>
                    <td>%s</td>
                    <td>%s</td>
                    <td>%s</td>
                    <td>%s</td>
                    <td>%s</td>
                    <td><a href=%s>%s</a></td>
                    </tr>",
                    $bgcolor,
                    $index,
                    $peer->ip,
                    $peer->protocol,
                    $peer->fromPattern,
                    $peer->description,
                    $peer->owner,
                    $this->url,
                    $actionText
                    );

                    printf("
                    </tr>
                    ");

                    $i++;
    
                }
    
			}

            print "</table>";

            $this->showPagination($maxrows);

            return true;
        }
    }

    function showAddForm() {
        print "
        <p>
        <table border=0 class=border width=100%>
        <tr>
            ";
            printf ("<form method=post name=addform action=%s>",$_SERVER['PHP_SELF']);
            print "
        	<td align=left>
            ";

            print "
            <input type=submit name=action value=Add>
            ";

            printf (" IP address: <input type=text size=20 name=ipaddress>");
            printf (" Description: <input type=text size=30 name=description>");
            printf (" Owner: <input type=text size=10 name=owner>");

            print "
	        </td>
        	<td align=right>
            ";
            print "
	        </td>
            ";
            printf("<input type=hidden name=service value='%s'>",$this->SOAPEngine->service);
            print "
            </form>
        </tr>
        </table>
        ";
    }

    function addRecord() {
    	$ipaddress   = trim($_REQUEST['ipaddress']);
        $description = trim($_REQUEST['description']);
        $owner       = trim($_REQUEST['owner']);

		if (!strlen($ipaddress) || !strlen($description)) {
            printf ("<p><font color=red>Error: Missing IP or description. </font>");
            return false;
        }

        $peer=array(
                     'ip'          => $ipaddress,
                     'description' => $description,
                     'owner'       => intval($_REQUEST['owner'])
        			);

        $this->SOAPEngine->soapclient->addHeader($this->SOAPEngine->SoapAuth);

        $result     = $this->SOAPEngine->soapclient->addTrustedPeer($peer);

        if (PEAR::isError($result)) {
            $error_msg  = $result->getMessage();
            $error_fault= $result->getFault();
            $error_code = $result->getCode();
            printf ("<p><font color=red>Error: %s (%s): %s</font>",$error_msg, $error_fault->detail->exception->errorcode,$error_fault->detail->exception->errorstring);
            return false;
        } else {
           printf ("<p><font color=green>Trusted peers %s has been added. </font>",$ipaddress);
           return 1;
        }
    }

    function deleteRecord() {
        if (!$_REQUEST['confirm']) {
        	print "<p><font color=red>Please press on Confirm to confirm the delete. </font>";
            return 1;
        }

        if (!strlen($this->filters['ip']) || !strlen($this->filters['ip'])) {
            print "<p><font color=red>Error: missing IP address. </font>";
            return 0;
        }

        $this->SOAPEngine->soapclient->addHeader($this->SOAPEngine->SoapAuth);

        $result     = $this->SOAPEngine->soapclient->deleteTrustedPeer($this->filters['ip']);

        if (PEAR::isError($result)) {
            $error_msg  = $result->getMessage();
            $error_fault= $result->getFault();
            $error_code = $result->getCode();
            printf ("<p><font color=red>Error: %s (%s): %s</font>",$error_msg, $error_fault->detail->exception->errorcode,$error_fault->detail->exception->errorstring);
            return false;
        } else {
           printf ("<p><font color=green>Trusted peer %s has been deleted. </font> ",$this->filters['ip']);
           unset($this->filters);
           return 1;
        }
    }

}

class SIPAccounts extends Records {
    var $sortElements=array('changeDate' =>'Change date',
                            'username'   => 'Username',
                            'domain'     => 'Domain',
                            'owner'      => 'Owner'
                            );

    function SIPAccounts(&$SOAPEngine) {
        global $CDRTool;
        $this->CDRTool = $CDRTool;

        $this->filters   = array('username'     => trim($_REQUEST['username_filter']),
                           'domain'       => trim($_REQUEST['domain_filter']),
                           'fullname'     => trim($_REQUEST['fullname_filter'])
                           );

        if ($this->CDRTool['filter']['domain']) {
            $this->domainsFilter=explode(" ",$this->CDRTool['filter']['domain']);
		}

		$this->Records(&$SOAPEngine);

    }

    function listRecords() {

		if (preg_match("/^(.*)@(.*)$/",$this->filters['username'],$m)) {
        	$this->filters['username'] = $m[1];
            $this->filters['domain']   = $m[2];
        }

        // Make sure we apply the domain filter from the login credetials
        if ($this->domainsFilter && !$this->filters['domain']) {
        	$this->filters['domain'] = $this->domainsFilter[0];
        }

        if ($this->filters['domain'] && $this->domainsFilter && !in_array($this->filters['domain'],$this->domainsFilter)) {
        	$this->filters['domain'] = $this->domainsFilter[0];
        }

		$this->showSeachForm();

        // Filter
        $filter=array('username' => $this->filters['username'],
                      'domain'   => $this->filters['domain'],
                      'name'     => $this->filters['fullname']
                      );

        // Range
        $range=array('start' => intval($this->next),
                     'count' => intval($this->maxrowsperpage)
                     );

        // Order
        if (!$this->filters['sortBy'])    $this->filters['sortBy']    = 'changeDate';
        if (!$this->filters['sortOrder']) $this->filters['sortOrder'] = 'DESC';

        $orderBy = array('attribute' => $this->filters['sortBy'],
                         'direction' => $this->filters['sortOrder']
                         );

        // Compose query
        $Query=array('filter'  => $filter,
                        'orderBy' => $orderBy,
                        'range'   => $range
                        );

        $this->url=sprintf("?sortBy=%s&sortOrder=%s",urlencode($this->filters['sortBy']),urlencode($this->filters['sortOrder']));

        if (strlen($this->filters['username'])) $this->url .= sprintf("&username_filter=%s",urlencode($this->filters['username']));
        if (strlen($this->filters['domain']))   $this->url .= sprintf("&domain_filter=%s",urlencode($this->filters['domain']));
        if (strlen($this->filters['fullname'])) $this->url .= sprintf("&fullname_filter=%s",urlencode($this->filters['fullname']));

        // Insert credetials
        $this->SOAPEngine->soapclient->addHeader($this->SOAPEngine->SoapAuth);

        // Call function
        $result     = $this->SOAPEngine->soapclient->getAccounts($Query);

        if (PEAR::isError($result)) {
            $error_msg  = $result->getMessage();
            $error_fault= $result->getFault();
            $error_code = $result->getCode();
            printf ("<p><font color=red>Error: %s (%s): %s</font>",$error_msg, $error_fault->detail->exception->errorcode,$error_fault->detail->exception->errorstring);
            return false;
        } else {

			$this->rows = $result->total;

            print "
            <p>
            <table border=0 align=center>
            <tr><td>$this->rows records found</td></tr>
            </table>
            <p>
            <table border=0 cellpadding=2 width=100%>
            <tr bgcolor=lightgrey>
                <td><b>Id</b></th>
                <td><b>SIP account</b></td>
                <td><b>Timezone</b></td>
                <td><b>Full name</b></td>
                <td><b>Email</b></td>
                <td><b>Caller Id</b></td>
                <td><b>Change date</b></td>
                <td><b>Action</b></td>
            </tr>
            ";

            if (!$this->next)  $this->next=0;

            if ($this->rows > $this->maxrowsperpage)  {
                $maxrows = $this->maxrowsperpage + $this->next;
                if ($maxrows > $this->rows) $maxrows = $this->maxrowsperpage;
            } else {
                $maxrows=$this->rows;
            }

            $i=0;

			if ($this->rows) {
                while ($i < $this->maxrowsperpage)  {
    
                    if (!$result->accounts[$i]) break;
    
                    $account = $result->accounts[$i];
    
                    $index=$this->next+$i+1;
    
                    $rr=floor($index/2);
                    $mod=$index-$rr*2;
            
                    if ($mod ==0) {
                    	$bgcolor="lightgrey";
                    } else {
                        $bgcolor="white";
                    }

        			$this->url .= sprintf("&service=%s&action=Delete&username_filter=%s&domain_filter=%s",
                    urlencode($this->SOAPEngine->service),
                    urlencode($account->id->username),
                    urlencode($account->id->domain)
                    );

                    if ($_REQUEST['action'] == 'Delete' &&
                    	$_REQUEST['username_filter'] == $account->id->username &&
                        $_REQUEST['domain_filter'] == $account->id->domain) {
                		$this->url .= "&confirm=1";
                        $actionText = "<font color=red>Confirm</font>";
                    } else {
                        $actionText = "Delete";
                    }

					$sip_account=sprintf("%s@%s",$account->id->username,$account->id->domain);

                    printf("
                    <tr bgcolor=%s>
                    <td>%s</td>
                    <td>%s</td>
                    <td>%s</td>
                    <td>%s %s</td>
                    <td>%s</td>
                    <td>%s</td>
                    <td>%s</td>
                    <td><a href=%s>%s</a></td>
                    </tr>
                    ",
                    $bgcolor,
                    $index,
                    $sip_account,
                    $account->timezone,
                    $account->firstName,
                    $account->lastName,
                    $account->email,
                    $account->rpid,
                    $account->changeDate,
                    $this->url,
                    $actionText
                    );
    
                    $i++;
                }
    
			}

            print "</table>";

            $this->showPagination($maxrows);

            return true;
        }
    }

    function showSeachFormCustom() {
        printf (" Username: <input type=text size=15 name=username_filter value='%s'>",$this->filters['username']);
        printf (" Domain: ");

        if ($this->domainsFilter) {
            $selected_domain[$this->filters['domain']]='selected';
            printf ("<select name=domain_filter>");
            foreach ($this->domainsFilter as $_domain) {
                printf ("<option value='$_domain' %s>$_domain",$selected_domain[$_domain]);
            }

            printf ("</select");
        } else {
            printf ("<input type=text size=15 name=domain_filter value='%s'>",$this->filters['domain']);
        }

        printf (" Full name: <input type=text size=15 name=fullname_filter value='%s'>",$this->filters['fullname']);
    }

    function deleteRecord() {
        if (!$_REQUEST['confirm']) {
        	print "<p><font color=red>Please press on Confirm to confirm the delete. </font>";
            return 1;
        }

        if (!strlen($this->filters['username']) || !strlen($this->filters['domain'])) {
            print "<p><font color=red>Error: missing SIP account username or domain. </font>";
            return 0;
        }

        $account=array('username' => $this->filters['username'],
                     'domain'   => $this->filters['domain']
        			);

        $this->SOAPEngine->soapclient->addHeader($this->SOAPEngine->SoapAuth);

        $result     = $this->SOAPEngine->soapclient->deleteAccount($account);

        if (PEAR::isError($result)) {
            $error_msg  = $result->getMessage();
            $error_fault= $result->getFault();
            $error_code = $result->getCode();
            printf ("<p><font color=red>Error: %s (%s): %s</font>",$error_msg, $error_fault->detail->exception->errorcode,$error_fault->detail->exception->errorstring);
            return false;
        } else {
           printf ("<p><font color=green>SIP account %s@%s has been deleted. </font> ",$this->filters['username'],$this->filters['domain']);
           unset($this->filters);
           return 1;
        }
    }

    function showAddForm() {
        print "
        <p>
        <table border=0 class=border width=100%>
        <tr>
            ";
            printf ("<form method=post name=addform action=%s>",$_SERVER['PHP_SELF']);
            print "
        	<td align=left>
            ";

            print "
            <input type=submit name=action value=Add>
            ";

            printf (" SIP: <input type=text size=15 name=account value='%s'>",$_REQUEST['account']);
            printf (" Pass: <input type=password size=10 name=password value='%s'>",$_REQUEST['password']);
            printf (" Name: <input type=text size=15 name=fullname value='%s'>",$_REQUEST['fullname']);
            printf (" Email: <input type=text size=15 name=email value='%s'>",$_REQUEST['email']);
            printf (" Owner: <input type=text size=5 name=owner value='%s'>",$_REQUEST['owner']);
            print " TZ: ";

            global $CDRTool;
            if ($_REQUEST['timezone']) {
				$this->timezone=$_REQUEST['timezone'];
            } else {
				$this->timezone=$CDRTool['provider']['timezone'];
            }

            $this->showTimezones();

            print "
	        </td>
        	<td align=right>
            ";
            print "
	        </td>
            ";
            printf("<input type=hidden name=service value='%s'>",$this->SOAPEngine->service);
            print "
            </form>
        </tr>
        </table>
        ";
    }

    function addRecord() {
    	$account_els  = explode("@", trim($_REQUEST['account']));
        $name_els  = explode(" ", trim($_REQUEST['fullname']));

		if (!strlen($account_els[0]) || !strlen($account_els[1])) {
            printf ("<p><font color=red>Error: Missing SIP account username or domain. </font>");
            return false;
        }

        $account=array(
                     'id'     => array('username' => $account_els[0],
                                       'domain'   => $account_els[1]
                                       ),
                     'firstName'  => $name_els[0],
                     'lastName'   => $name_els[1],
                     'password'   => trim($_REQUEST['password']),
                     'timezone'   => trim($_REQUEST['timezone']),
                     'email'      => trim($_REQUEST['email']),
                     'owner'      => intval($_REQUEST['owner'])
        			);

        //print_r($account);

        // check if domain exists
        $this->SOAPEngine->soapclient->addHeader($this->SOAPEngine->SoapAuth);

        $result     = $this->SOAPEngine->soapclient->addAccount($account);

        if (PEAR::isError($result)) {
            $error_msg  = $result->getMessage();
            $error_fault= $result->getFault();
            $error_code = $result->getCode();
            printf ("<p><font color=red>Error: %s (%s): %s</font>",$error_msg, $error_fault->detail->exception->errorcode,$error_fault->detail->exception->errorstring);
            return false;
        } else {
           printf ("<p><font color=green>SIP account %s@%s has been added. </font>",$alias_els[0],$alias_els[1]);
           return 1;
        }
    }

}

class SIPAliases extends Records {
    var $sortElements=array(
                            'aliasUsername'  => 'Alias user',
                            'aliasDomain'    => 'Alias domain',
                            'targetUsername' => 'Target user',
                            'targetDomain'   => 'Target domain',
                            'owner'          => 'Owner'
                            );

    function SIPAliases(&$SOAPEngine) {
        global $CDRTool;
        $this->CDRTool = $CDRTool;

        $this->filters   = array('aliasUsername'     => trim($_REQUEST['alias_username_filter']),
                                 'aliasDomain'       => trim($_REQUEST['alias_domain_filter']),
                                 'targetUsername'    => trim($_REQUEST['target_username_filter']),
                                 'targetDomain'      => trim($_REQUEST['target_domain_filter'])
                           );

        if ($this->CDRTool['filter']['domain']) {
            $this->domainsFilter=explode(" ",$this->CDRTool['filter']['domain']);
		}

		$this->Records(&$SOAPEngine);

    }

    function listRecords() {

        // Make sure we apply the domain filter from the login credetials
        if ($this->domainsFilter && !$this->filters['aliasDomain']) {
        	$this->filters['aliasDomain'] = $this->domainsFilter[0];
        }

        if ($this->filters['aliasDomain'] && $this->domainsFilter && !in_array($this->filters['aliasDomain'],$this->domainsFilter)) {
        	$this->filters['aliasDomain'] = $this->domainsFilter[0];
        }

		$this->showSeachForm();

        // Filter
        $filter=array('aliasUsername'  => $this->filters['aliasUsername'],
                      'aliasDomain'    => $this->filters['aliasDomain'],
                      'targetUsername' => $this->filters['targetUsername'],
                      'targetDomain'   => $this->filters['targetDomain']
                      );

        // Range
        $range=array('start' => intval($this->next),
                     'count' => intval($this->maxrowsperpage)
                     );

        // Order
        if (!$this->filters['sortBy'])    $this->filters['sortBy']    = 'aliasUsername';
        if (!$this->filters['sortOrder']) $this->filters['sortOrder'] = 'DESC';

        $orderBy = array('attribute' => $this->filters['sortBy'],
                         'direction' => $this->filters['sortOrder']
                         );

        // Compose query
        $Query=array('filter'  => $filter,
                        'orderBy' => $orderBy,
                        'range'   => $range
                        );

        $this->url=sprintf("?sortBy=%s&sortOrder=%s",urlencode($this->filters['sortBy']),urlencode($this->filters['sortOrder']));

        if (strlen($this->filters['aliasUsername']))  $this->url .= sprintf("&alias_username_filter=%s",urlencode($this->filters['aliasUsername']));
        if (strlen($this->filters['aliasDomain']))    $this->url .= sprintf("&alias_domain_filter=%s",urlencode($this->filters['aliasDomain']));
        if (strlen($this->filters['targetUsername'])) $this->url .= sprintf("&target_username_filter=%s",urlencode($this->filters['targetUsername']));
        if (strlen($this->filters['targetDomain']))   $this->url .= sprintf("&target_domain_filter=%s",urlencode($this->filters['targetDomain']));

        // Insert credetials
        $this->SOAPEngine->soapclient->addHeader($this->SOAPEngine->SoapAuth);

        // Call function
        $result     = $this->SOAPEngine->soapclient->getAliases($Query);

        if (PEAR::isError($result)) {
            $error_msg  = $result->getMessage();
            $error_fault= $result->getFault();
            $error_code = $result->getCode();
            printf ("<p><font color=red>Error: %s (%s): %s</font>",$error_msg, $error_fault->detail->exception->errorcode,$error_fault->detail->exception->errorstring);
            return false;
        } else {

			$this->rows = $result->total;
            //print "<pre>";
            //print_r($result);

            print "
            <p>
            <table border=0 align=center>
            <tr><td>$this->rows records found</td></tr>
            </table>
            <p>
            <table border=0 cellpadding=2 width=100%>
            <tr bgcolor=lightgrey>
                <td><b>Id</b></th>
                <td><b>SIP alias</b></td>
                <td><b>SIP target</b></td>
                <td><b>Owner</b></td>
                <td><b>Action</b></td>
            </tr>
            ";

            if (!$this->next)  $this->next=0;

            if ($this->rows > $this->maxrowsperpage)  {
                $maxrows = $this->maxrowsperpage + $this->next;
                if ($maxrows > $this->rows) $maxrows = $this->maxrowsperpage;
            } else {
                $maxrows=$this->rows;
            }

            $i=0;

			if ($this->rows) {
                while ($i < $this->maxrowsperpage)  {
    
                    if (!$result->aliases[$i]) break;
    
                    $alias = $result->aliases[$i];
    
                    $index=$this->next+$i+1;
    
                    $rr=floor($index/2);
                    $mod=$index-$rr*2;
            
                    if ($mod ==0) {
                    	$bgcolor="lightgrey";
                    } else {
                        $bgcolor="white";
                    }

        			$this->url .= sprintf("&service=%s&action=Delete&alias_username_filter=%s&alias_domain_filter=%s",
                    urlencode($this->SOAPEngine->service),
                    urlencode($alias->id->username),
                    urlencode($alias->id->domain)
                    );

                    if ($_REQUEST['action'] == 'Delete' &&
                    	$_REQUEST['alias_username_filter'] == $alias->id->username &&
                        $_REQUEST['alias_domain_filter'] == $alias->id->domain) {
                		$this->url .= "&confirm=1";
                        $actionText = "<font color=red>Confirm</font>";
                    } else {
                        $actionText = "Delete";
                    }

                    printf("
                    <tr bgcolor=%s>
                    <td>%s</td>
                    <td>%s@%s</td>
                    <td>%s@%s</td>
                    <td>%s</td>
                    <td><a href=%s>%s</a></td>
                    </tr>
                    ",
                    $bgcolor,
                    $index,
                    $alias->id->username,
                    $alias->id->domain,
                    $alias->target->username,
                    $alias->target->domain,
                    $alias->owner,
                    $this->url,
                    $actionText
                    );
    
                    $i++;
    
                }
    
			}

            print "</table>";

            $this->showPagination($maxrows);

            return true;
        }
    }

    function deleteRecord() {
        if (!$_REQUEST['confirm']) {
        	print "<p><font color=red>Please press on Confirm to confirm the delete. </font>";
            return 1;
        }

        if (!strlen($this->filters['aliasUsername']) || !strlen($this->filters['aliasDomain'])) {
            print "<p><font color=red>Error: missing SIP alias username or domain. </font>";
            return 0;
        }

        $alias=array('username' => $this->filters['aliasUsername'],
                     'domain'   => $this->filters['aliasDomain']
        			);

        //print_r($alias);
        $this->SOAPEngine->soapclient->addHeader($this->SOAPEngine->SoapAuth);

        $result     = $this->SOAPEngine->soapclient->deleteAlias($alias);

        if (PEAR::isError($result)) {
            $error_msg  = $result->getMessage();
            $error_fault= $result->getFault();
            $error_code = $result->getCode();
            printf ("<p><font color=red>Error: %s (%s): %s</font>",$error_msg, $error_fault->detail->exception->errorcode,$error_fault->detail->exception->errorstring);
            return false;
        } else {
           printf ("<p><font color=green>SIP alias %s@%s has been deleted. </font> ",$this->filters['aliasUsername'],$this->filters['aliasDomain']);
           unset($this->filters);
           $this->recordDeleted=1;
           return 1;
        }
    }

    function showSeachFormCustom() {
        printf (" User: <input type=text size=10 name=alias_username_filter value='%s'>",$this->filters['aliasUsername']);
        printf (" Domain: ");

        if ($this->domainsFilter) {
            $selected_domain[$this->filters['aliasDomain']]='selected';
            printf ("<select name=alias_domain_filter>");

            foreach ($this->domainsFilter as $_domain) {
                printf ("<option value='$_domain' %s>$_domain",$selected_domain[$_domain]);
            }

            printf ("</select");
        } else {
            printf ("<input type=text size=10 name=alias_domain_filter value='%s'>",$this->filters['aliasDomain']);
        }

        printf (" Target user: <input type=text size=10 name=target_username_filter value='%s'>",$this->filters['targetUsername']);
        printf (" Target domain: <input type=text size=10 name=target_domain_filter value='%s'>",$this->filters['targetDomain']);

    }

    function showAddForm() {
        print "
        <p>
        <table border=0 class=border width=100%>
        <tr>
            ";
            printf ("<form method=post name=addform action=%s>",$_SERVER['PHP_SELF']);
            print "
        	<td align=left>
            ";

            print "
            <input type=submit name=action value=Add>
            ";

            printf (" SIP alias: <input type=text size=35 name=alias>");
            printf (" SIP target: <input type=text size=35 name=target>");
            printf (" Owner: <input type=text size=10 name=owner>");

            print "
	        </td>
        	<td align=right>
            ";
            print "
	        </td>
            ";
            printf("<input type=hidden name=service value='%s'>",$this->SOAPEngine->service);
            print "
            </form>
        </tr>
        </table>
        ";
    }

    function addRecord() {
    	$alias_els  = explode("@", trim($_REQUEST['alias']));
        $target_els = explode("@", trim($_REQUEST['target']));

        if (!strlen($alias_els[0]) || !strlen($alias_els[1])) {
            print "<p><font color=red>Error: missing SIP alias username or domain. </font>";
            return 0;
        }

        if (!strlen($target_els[0]) || !strlen($target_els[1])) {
            print "<p><font color=red>Error: missing SIP target username or domain. </font>";
            return 0;
        }

        $alias=array(
                     'id'     => array('username' => $alias_els[0],
                                       'domain'   => $alias_els[1]
                                       ),
                     'target' => array('username' => $target_els[0],
                                       'domain'   => $target_els[1]
                                       ),
                     'owner'  => intval($_REQUEST['owner'])
        			);

        //print_r($alias);
        $this->SOAPEngine->soapclient->addHeader($this->SOAPEngine->SoapAuth);

        $result     = $this->SOAPEngine->soapclient->addAlias($alias);

        if (PEAR::isError($result)) {
            $error_msg  = $result->getMessage();
            $error_fault= $result->getFault();
            $error_code = $result->getCode();
            printf ("<p><font color=red>Error: %s (%s): %s</font>",$error_msg, $error_fault->detail->exception->errorcode,$error_fault->detail->exception->errorstring);
            return false;
        } else {
           printf ("<p><font color=green>SIP alias %s@%s has been added. </font>",$alias_els[0],$alias_els[1]);
           return 1;
        }
    }
}

class DomainStatistics extends Records {

    var $maxrowsperpage= 200;

    function DomainStatistics(&$SOAPEngine) {
        $this->filters   = array(
                           'domain'       => trim($_REQUEST['domain_filter'])
                           );

		$this->Records(&$SOAPEngine);
    }

    function listRecords() {

		$this->showSeachForm();

        // Insert credetials
        $this->SOAPEngine->soapclient->addHeader($this->SOAPEngine->SoapAuth);

		$filter=$this->filters['domain'];
        // Call function
        $result     = $this->SOAPEngine->soapclient->getDomainStatistics($filter);

        if (PEAR::isError($result)) {
            $error_msg  = $result->getMessage();
            $error_fault= $result->getFault();
            $error_code = $result->getCode();
            printf ("<p><font color=red>Error: %s (%s): %s</font>",$error_msg, $error_fault->detail->exception->errorcode,$error_fault->detail->exception->errorstring);
            return false;
        } else {

			$this->rows = count($result);

            //print_r($result);

            print "
            <table border=0 align=center>
            <tr><td>$this->rows records found</td></tr>
            </table>
            <p>
            <table border=0 cellpadding=2 width=100%>
            <tr bgcolor=lightgrey>
                <td><b>Id</b></th>
                <td><b>SIP domain</b></td>
                <td><b>SIP subscribers</b></td>
                <td><b>Online subscribers</b></td>
                <td><b>Online SIP devices</b></td>
                <td><b>Action</b></td>
            </tr>
            ";

            if (!$this->next)  $this->next=0;

            if ($this->rows > $this->maxrowsperpage)  {
                $maxrows = $this->maxrowsperpage + $this->next;
                if ($maxrows > $this->rows) $maxrows = $this->maxrowsperpage;
            } else {
                $maxrows=$this->rows;
            }

            $i=0;

			if ($this->rows) {
                while ($i < $this->maxrowsperpage)  {
    
                    $domain = $result[$i];
                    if (!strlen($domain->users)) break;

                    $index = $this->next+$i+1;
    
                    $rr=floor($index/2);
                    $mod=$index-$rr*2;
            
                    if ($mod ==0) {
                    	$bgcolor="lightgrey";
                    } else {
                        $bgcolor="white";
                    }

        			$this->url .= sprintf("?service=%s&action=Delete&domain_filter=%s",
                    urlencode($this->SOAPEngine->service),
                    urlencode($domain->domain)
                    );

                    if ($_REQUEST['action'] == 'Delete' &&
                        $_REQUEST['domain_filter'] == $domain->domain) {
                		$this->url .= "&confirm=1";
                        $actionText = "<font color=red>Confirm</font>";
                    } else {
                        $actionText = "Delete";
                    }

                    printf("
                    <tr bgcolor=%s>
                    <td>%s</td>
                    <td>%s</td>
                    <td>%s</td>
                    <td>%s</td>
                    <td>%s</td>
                    <td><a href=%s>%s</a></td>
                    </tr>",
                    $bgcolor,
                    $index,
                    $domain->domain,
                    $domain->users,
                    $domain->onlineUsers,
                    $domain->onlineDevices,
                    $this->url,
                    $actionText
                    );

                    $i++;
                }
			}

            print "</table>";

            $this->showPagination($maxrows);

            return true;
        }
    }

    function showSeachFormCustom() {

        printf (" Domain: <input type=text size=15 name=domain_filter value='%s'>",$this->filters['domain']);

    }

    function deleteRecord() {
        if (!$_REQUEST['confirm']) {
        	print "<p><font color=red>Please press on Confirm to confirm the delete. </font>";
            return 1;
        }

        if (!strlen($this->filters['domain']) || !strlen($this->filters['domain'])) {
            print "<p><font color=red>Error: missing SIP domain. </font>";
            return 0;
        }

        $this->SOAPEngine->soapclient->addHeader($this->SOAPEngine->SoapAuth);

        $result     = $this->SOAPEngine->soapclient->deleteDomain($this->filters['domain']);

        if (PEAR::isError($result)) {
            $error_msg  = $result->getMessage();
            $error_fault= $result->getFault();
            $error_code = $result->getCode();
            printf ("<p><font color=red>Error: %s (%s): %s</font>",$error_msg, $error_fault->detail->exception->errorcode,$error_fault->detail->exception->errorstring);
            return false;
        } else {
           printf ("<p><font color=green>SIP domain %s has been deleted. </font> ",$this->filters['domain']);
           unset($this->filters);
           return 1;
        }
    }

    function showAddForm() {
        print "
        <p>
        <table border=0 class=border width=100%>
        <tr>
            ";
            printf ("<form method=post name=addform action=%s>",$_SERVER['PHP_SELF']);
            print "
        	<td align=left>
            ";

            print "
            <input type=submit name=action value=Add>
            ";

            printf (" Domain: <input type=text size=20 name=domain>");

            print "
	        </td>
        	<td align=right>
            ";
            print "
	        </td>
            ";
            printf("<input type=hidden name=service value='%s'>",$this->SOAPEngine->service);
            print "
            </form>
        </tr>
        </table>
        ";
    }

    function addRecord() {

        $domain=trim($_REQUEST['domain']);

        if (!strlen($domain)) {
            print "<p><font color=red>Error: missing SIP domain. </font>";
            return 0;
        }

        $this->SOAPEngine->soapclient->addHeader($this->SOAPEngine->SoapAuth);

        $result     = $this->SOAPEngine->soapclient->addDomain($domain);

        if (PEAR::isError($result)) {
            $error_msg  = $result->getMessage();
            $error_fault= $result->getFault();
            $error_code = $result->getCode();
            printf ("<p><font color=red>Error: %s (%s): %s</font>",$error_msg, $error_fault->detail->exception->errorcode,$error_fault->detail->exception->errorstring);
            return false;
        } else {
           printf ("<p><font color=green>SIP domain %s has been added. </font>",$domain);
           return 1;
        }
    }
}

page_close();
?>