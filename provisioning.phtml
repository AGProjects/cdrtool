<?
include("./global.inc");
page_open(
            array("sess" => "CDRTool_Session",
                  "auth" => "CDRTool_Auth",
                  "perm" => "CDRTool_Perm"));

$title="Provisioning interface";

if (is_readable("local/header.phtml")) {
    include("local/header.phtml");
} else {
    include("header.phtml");
}

set_time_limit(600);
$perm->check("provisioning");

require_once("provisioning/ngnpro_soap_library.phtml");
require_once("provisioning/ngnpro_client_lib.phtml");
include_once("provisioning/ngnpro_engines.inc");

$layout = new pageLayoutLocal();
$layout->showTopMenu();

// $soapEngines must be defined in global.inc

global $CDRTool;

if ($CDRTool['reseller']) {
	$loginCredentials=array(
                        'reseller'           => $CDRTool['reseller'],
                        'loginType'          => 'admin'
                        );
} else {
	$loginCredentials=array(
                        'loginType'          => 'admin'
                        );
}

if (strlen($CDRTool['filter']['soap'])) {
    $allowedEngines=explode(' ',trim($CDRTool['filter']['soap']));
	foreach(array_keys($soapEngines) as $_engine) {
        foreach ($allowedEngines as $_allowed) {
            if ($_engine == $_allowed) {
                $soapEngines_checked[$_allowed]=$soapEngines[$_allowed];
                continue;
            }
        }
    }

    $soapEngines=$soapEngines_checked;
}

//print_r($loginCredentials);

$extraFormElements=array();

if ($_REQUEST['generatorId']) {
    $generator  = new recordGenerator($_REQUEST['generatorId'],$recordGenerators,$soapEngines,$extraFormElements,$loginCredentials);
    if ($_REQUEST['action']=='Generate') {
        $generator->generateRecords();
        $generator->showGeneratorForm();
    } else {
        $generator->showGeneratorForm();
    }
} else {
	$SOAPEngine = new SOAPEngine($_REQUEST['service'],$soapEngines,$extraFormElements,$loginCredentials);
    $_class     = $SOAPEngine->recordsClass;
    $RECORDS    = new $_class(&$SOAPEngine);
    
    if ($_REQUEST['action']=='Add')    $RECORDS->addRecord();
    if ($_REQUEST['action']=='Delete') $RECORDS->deleteRecord();
        if ($_REQUEST['action']=='Update') $RECORDS->updateRecord();

    if ($_REQUEST['action']=='PerformActions') {
        $RECORDS->performActions();
    } else {
        $RECORDS->listRecords();
    }
    
}
$layout->showFooter();

print "
</body>
</html>
";

page_close();
?>