DESCRIPTION
-----------

Prepaid functionality is achieved by:

1. An external call control module (not provided by CDRTool) that maintains
call status and terminates calls by sending BYEs to both SIP end-points. The
call control module communicates with both the SIP Proxy and CDRTool using
an API described below. 

2. CDRTool rating engine - provides session locking, calculates maximum
session time based on user balance and destination using the same algorithm
as the postpaid engine and debits the subscriber balance.

See doc/PrepaidEngine.pdf for a detailed call flow.


Prepaid API
-----------

CDRTool prepaid engine is used to compute session times based on user credit
and destination rates and debit the balance when the call has ended. The
prepaid engine is accessible over the TCP socket where the rating engine
listens.

The TCP socket location is configured in /etc/default/cdrtool. The
connection can be tested manually using the telnet command and by typing
help at the prompt:

tstuser@host:~$ telnet 10.0.0.0.1 9024
Trying 10.0.0.1...
Connected to 10.0.0.1.
Escape character is '^]'.
Help
MaxSessionTime        From=sip:123@example.com To=sip:0031650222333@example.com Duration=7200 Gateway=10.0.0.1 Lock=1
AddBalance            From=123@example.com Value=10.00
GetBalance            From=123@example.com
GetBalanceHistory     From=123@example.com
DeleteBalance         From=123@example.com
DeleteBalanceHistory  From=123@example.com
DebitBalance          From=sip:123@example.com To=sip:0031650222333@example.com Gateway=10.0.0.1 Duration=59
ShowPrepaidAccounts   Filter=123@example.com
ReloadPrepaidAccounts Account=abc@example.com

In the example above only the commands related to the prepaid functionality
are highlighted.

Call control module sends commands based on the syntax described below, to
the CDRTool prepaid engine that handles the prepaid accounts. A command is a
line of text containing a keyword, which is the command itself followed by a
number of parameters separated by space. The command ends with an enter in
unix style: '\n' For each such request there will be a reply on one or more
lines, containing information that depends on the command that was sent. A
reply ends when a double end of line (\n) is received: \n\n (this is needed
because there are commands that require multiline responses). How the
information contained in a reply is to be interpreted depends on the command
itself and is described below.


1. Asking for the call time limit
   ------------------------------

To request the maximum time for a session, the following request must be
sent to CDRTool rating engine on one line:

MaxSessionTime From=sip:123@example.com To=sip:0031650222@example.com
Duration=7200 Gateway=81.20.68.10 ENUMtl=tld.com Lock=1\n

Duration is a limit imposed to the time allowed, in case you want to limit
the call time to a maximum duration. This will be a top limit for the call's
time, even if the user could talk more than that based on his current
balance. The SIP proxy may limit all calls to 7200 seconds for example. 
Lock specifies if the account is to be locked or not (i.e. don't allow the
same user make multiple calls at the same time). This is used because
sometimes we only need to peek at the time but not actually start a call and
lock the user. When the call starts the account should always be locked. To
may actually be sip:number@domain;param=value so you must extract the
username part which is the number From is a sip URI which can be "full name"

ENUMtld parameter is optional but if present discounts based on ENUM can be
applied (see RATING.txt for more information on ENUM discounts).

Call control expects a reply like below:

value\n\n

value is the numeric time in seconds, or one of the keywords Locked or None
(None meaning it's not a prepaid account and it doesn't have any limitation,
or it's a free destination, like a 0800... number).  There is no empty line
before value (response starts with value on the first line and then it has 2
enters unix style as described).

To field must be the canonical destination SIP URI after all possible
lookups in the SIP Proxy.

2. Debiting the balance when the conversation ends
   -----------------------------------------------

To debit money from the user account when the conversation ends, the Call
control module must send the following command on one line:

DebitBalance From=sip:123@example.com To=sip:0031650222@example.com
Gateway=81.20.68.10 Duration=59\n

Same notes about the From and To fields as above apply.

and expects in return:

value\n\n

where value is one of: OK (success), Failed (failure), Not Prepaid (account
is not prepaid - this case is not considered a failure)

There are cases where we call DebitBalance with a 0 duration. This is valid
and should unlock the account but leave the credit untouched.


Prepaid calls in progress
-------------------------

To see the calls in progress go to Rating -> Prepaid -> Search with Lock = 1

If the connection between the SIP Proxy call control module and CDRTool
rating engine is broken it is possible to have prepaid accounts that
remained locked because no DebitBalance command has been received. To unlock
these accounts find them in Rating -> Prepaid section and set Lock to 0.


Third party tools
-----------------

FreeRADIUS-CDRTool by Dan-Cristian Bogos 

FreeRADIUS module providing connectivity to CDRTool prepaid engine. Provides
prepaid authentication for calls proxied by OpenSER and returns to OpenSER
MaxCallDuration and user Credit. Can be easily extended to support other SIP
or H323 devices.

http://sourceforge.net/projects/frad-cdrtool


Notes
-----

The balance is debited correctly regardless of the moment of CDR
normalization. Renormalization of calls do not recalculate balance.


Simultaneous prepaid calls
--------------------------

Since version 6.6.0 is possible to have multiple calls using the same
prepaid account without the risk of reaching a negative balance. 


To have this working your must set $RatingEngine['prepaid_lock'] to 0 in
/etc/cdrtool/global.inc and update the call control software module that
keeps track of the maximum session time to enforce call ending for all calls
belonging to the same sip account at the same time based on the last value
of MaxSessionTime received from the rating engine. The previous version
required the call control module to keep the time counter per sip session,
now it needs to sync the counter for all calls belonging to the same sip
account.

Having simultaneous prepaid calls for the same account will load the rating
engine more during call setup (it will perform internally during each call
setup (2 x the number of parallel sip sessions per sip account) number of
calls to ShowPrice and MaxSessionTime functions) but there is no database
polling needed during the duration of the calls to check the balance.

The list of ongoing prepaid calls can be monitored in the Prepaid accounts
section of the Rating pages. For each sip account that has ongoing calls a
link marked Sessions apear in the left side of the record. Click on it to
display the ongoing prepaid sessions. The 'Delete session' button allows the
removal of the session form the rating engine. The expired sessions that
have not been closed properly by the call control module are automatically
purged 30 seconds after expiration.

The time and balance distribution between parallel calls is logged detailed
in the syslog:

cdrtool[13292]: MaxSessionTime From=sip:adi@umts.ro Lock=1 To=sip:00318008185@umts.ro CallId=waaivgq89aTxmPIG6JIsPhODUe0tRVf- Duration=36000 Gateway=80.101.96.20
cdrtool[13292]: ConnectFee=0.0450 Span=1 Duration=16 DestId=31646 default Profile=442 Period=weekend Rate=442 Interval=0-24 Cost=0.1600/60 Price=0.0427
cdrtool[13292]: Ongoing prepaid session uw1znivnqoeofyezzuiiisudukw64cm- for adi@umts.ro to sip:0031646630425@umts.ro: duration=16, price=0.0877 
cdrtool[13292]: Balance for adi@umts.ro having 1 ongoing sessions: database=9.9534, due=0.0877, real=9.8657
cdrtool[13292]: Maximum duration for adi@umts.ro to destination 31646 having balance=9.8657 is 3700
cdrtool[13292]: Maximum duration for adi@umts.ro to destination 31800 having balance=9.8657 is 29597
cdrtool[13292]: Maximum duration agregated for adi@umts.ro is (Balance=9.8657)/(Sum of price per second for each destination=0.0030)=3288 s
cdrtool[13292]: CallId=waaivgq89atxmpig6jisphodue0trvf- BillingParty=adi@umts.ro DestId=31800 Balance=9.8657 MaxSessionTime=3288 Spans=2

